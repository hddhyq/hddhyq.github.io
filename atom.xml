<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>hddhyq&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://hddhyq.github.io/"/>
  <updated>2021-05-05T06:42:43.172Z</updated>
  <id>https://hddhyq.github.io/</id>
  
  <author>
    <name>hddhyq</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>了解ESLint</title>
    <link href="https://hddhyq.github.io/2021/02/27/know-eslint/"/>
    <id>https://hddhyq.github.io/2021/02/27/know-eslint/</id>
    <published>2021-02-27T13:39:28.000Z</published>
    <updated>2021-05-05T06:42:43.172Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/project/eslint-logo.png" /></p><p>原由是想写一个 繁简体 的业务检查，进而一步一步的了解了 ESLint 这个工具~ <a id="more"></a> ## ESLint的历史 JavaScript 发展历史中，出现了很多 lint 工具，比较有代表性的是以下三款lint工具。</p><h4 id="jslint">1. <a href="https://jslint.com/help.html">JSLint</a></h4><p>最早的lint工具，由 <a href="https://zh.wikipedia.org/wiki/%E9%81%93%E6%A0%BC%E6%8B%89%E6%96%AF%C2%B7%E5%85%8B%E7%BE%85%E5%85%8B%E7%A6%8F%E7%89%B9">Douglas Crockford</a>开发(也是《JavaScript：语言精粹》的作者)。缺点是该工具的语法规则都是预设的，用户无法改变。也就是说，想要使用这个工具，你必须确保自己能接受它的所有规则。</p><h4 id="jshint">2. <a href="https://jshint.com/docs/">JSHint</a></h4><p>JSHint 是由 Anton Kovalyov 基于 JSLint 开发的开源项目，显著的特点就是允许用户自定义自己的语法规则，加持上开源社区的驱动，发展十分迅速。由于是基于 JSLint 开发，原有的一些问题也继承下来了，比如：不易扩展，不易直接根据报错定位到具体的规则配置等。</p><h4 id="eslint">3. <a href="https://eslint.org/">ESLint</a></h4><p>ESLint是由 <a href="https://github.com/nzakas/">Nicholas C. Zakas</a> (《JavaScript 高级程序设计》作者) 在2013年开始开发的，它的初衷就是为了能让开发者能自定义自己的 lint rules，它提供了一套完善的插件系统，可以自由的扩展，动态的加载配置，同时能方便的根据报错定位到具体的规则配置。ESLint的诞生并不是 Zakas 在重复造一个轮子，而是他在业务开发中需要新增一条规则，但是 JSHint 无法提供支持，于是他就结合 JSHint 和 <a href="https://jscs-dev.github.io/">JSCS</a> (AST的方式进行规则检测) 写出来了 ESLint。</p><p>早期的 ESLint 并没有大火，因为需要将源代码转成 AST，运行速度上输给了 JSHint，并且 JSHint 当时已经有了完整的生态（编辑器的支持）。真正让 ESLint 大火是因为 ES6 的出现。</p><p>ES6 发布后，因为新增了很多语法，JSHint 短期内无法提供支持，而 ESLint 只需要有合适的解析器就能够进行 lint 检查。这时 <a href="https://babeljs.io/">Babel</a> 为 ESLint 提供了支持，开发了 babel-eslint，让 ESLint 成为最快支持 ES6 语法的 lint 工具。</p><h2 id="使用eslint">使用ESLint</h2><p>ESLint 的用法包含两部分：通过配置文件配置 lint 规则；通过命令行执行 lint 。</p><h3 id="配置eslint">配置eslint</h3><p>通过 <code>eslint --init</code> 做出各种选择是最常见的 eslint 配置方式： <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> eslint --init</span></span><br><span class="line">√ How would you like to use ESLint? · problems</span><br><span class="line">√ What type of modules does your project use? · commonjs</span><br><span class="line">√ Which framework does your project use? · none</span><br><span class="line">√ Does your project use TypeScript? · No / Yes</span><br><span class="line">√ Where does your code run? · browser</span><br><span class="line">√ What format do you want your config file to be in? · JavaScript</span><br></pre></td></tr></table></figure> 上述选择之后，根目录会新生成一个 <code>.eslintrc.js</code> 文件。 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* .eslintrc.js */</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">"env"</span>: &#123;</span><br><span class="line">        <span class="string">"browser"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"commonjs"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"es2021"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"extends"</span>: <span class="string">"eslint:recommended"</span>,</span><br><span class="line">    <span class="string">"parserOptions"</span>: &#123;</span><br><span class="line">        <span class="string">"ecmaVersion"</span>: <span class="number">12</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"rules"</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>然后通过 命令行 的交互就能去检查对应的 js 文件了。 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eslint demo.js</span><br></pre></td></tr></table></figure></p><h2 id="创建-eslint-自定义规则">创建 ESLint 自定义规则</h2><h3 id="npm-安装">1. npm 安装</h3><p>根据 ESLint 的官方指南，我们需要 yeoman 和 generator-eslint 来构建插件的脚手架代码。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yo generator-eslint</span><br></pre></td></tr></table></figure><h3 id="创建文件夹">2. 创建文件夹</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir eslint-plugin-demo</span><br><span class="line">cd eslint-plugin-demo</span><br></pre></td></tr></table></figure><h3 id="初始化项目结构">3. 初始化项目结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yo eslint:plugin</span><br></pre></td></tr></table></figure><p>会进入对应的命令行交互流程，流程结束生成 ESLint 插件项目的目录结构</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">? What is your name? hddhyq</span><br><span class="line">? What is the plugin ID? demolint  # 插件的ID是什么 eslint-plugin-&lt;ID&gt;</span><br><span class="line">? Type a short description of this plugin: demo for create ESLint rule # 描述信息</span><br><span class="line">? Does this plugin contain custom ESLint rules? Yes # 是否包含自定义ESLint规则</span><br><span class="line">? Does this plugin contain one or more processors? No # 这个插件包含一个或多个处理器吗</span><br><span class="line">   create package.json</span><br><span class="line">   create lib\index.js</span><br><span class="line">   create README.md</span><br></pre></td></tr></table></figure><h3 id="创建规则">4. 创建规则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yo eslint:rule</span><br></pre></td></tr></table></figure><p>创建规则命令行交互： <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">? What is your name? hddhyq</span><br><span class="line">? Where will this rule be published? (Use arrow keys) # 这个规则将在哪里发布</span><br><span class="line">  ESLint Core  # 官方的核心规则 (目前有200多条规则)</span><br><span class="line">❯ ESLint Plugin  # 选择 ESLint 插件</span><br><span class="line">? What is the rule ID? no-wareware</span><br><span class="line">? Type a short description of this rule: 禁止使用~~转换数字</span><br><span class="line">? Type a short example of the code that will fail: var a = ~~100 # 测试代码</span><br><span class="line">   create docs\rules\no-wareware.md # 使用文档</span><br><span class="line">   create lib\rules\no-wareware.js  # 校验文件</span><br><span class="line">   create tests\lib\rules\no-wareware.js # 测试文件</span><br></pre></td></tr></table></figure></p><h2 id="eslint-如何验证规则">ESLint 如何验证规则</h2><p>Lint 是基于静态代码进行分析，对于 ESLint 来说，核心功能就是对 rule 及其配置，利用 Lint 分析源码。这里就需要介绍到 AST(抽象语法树) ，相信大家对它一定都用一定的了解，像Babel，Webpack，UglifyJS 等都使用到了 AST 。</p><h3 id="关于-ast">关于 AST</h3><p>ESLint 使用 <a href="https://github.com/eslint/espree">Espree</a> 来解析我们的 JS 语句，来生成抽象语法树。我们可以使用<a href="https://astexplorer.net/">AST explorer</a> ，方便查看一段代码被解析成 AST 后的样子。</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/project/eslint_ast.png" alt="" /><figcaption>AST展示</figcaption></figure><p>从上图可以看出，我们鼠标在右侧选中某个值，左侧对应的区域也会高亮展示。就像 CSS Selectors 一样，右侧被选中的项，我们称作 AST selectors 。</p><ul><li><a href="https://cn.eslint.org/docs/developer-guide/selectors">https://cn.eslint.org/docs/developer-guide/selectors</a></li><li><a href="https://github.com/estools/esquery">https://github.com/estools/esquery</a></li></ul><p>通过 AST selectors 我们可以快速的找到 静态代码中的内容 。 ### 单条 rule 如何工作？ 这里看一下，我们自定义的规则 <code>"eslint-plugin-demo/no-wareware": "error"</code> 。源码如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    meta: &#123;</span><br><span class="line">        docs: &#123;</span><br><span class="line">            description: "禁止使用~~转换数字",</span><br><span class="line">        &#125;,</span><br><span class="line">        fixable: null,  // or "code" or "whitespace"</span><br><span class="line">        schema: []</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    create: function(context) &#123;</span><br><span class="line"></span><br><span class="line">        return  &#123;</span><br><span class="line">            UnaryExpression(node) &#123;</span><br><span class="line">                if (node.operator === '~' &amp;&amp; node.argument.operator === '~') &#123;</span><br><span class="line">                    context.report(&#123;</span><br><span class="line">                        node,</span><br><span class="line">                        message: '請使用 + 代替 ~~ 運算符'</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>可以看到，一条 rule 就是一个 node 模块，主要由 <code>meta</code> 和 <code>create</code> 两部分组成，</p><ul><li><code>meta</code> 代表了这条规则的元数据，比如类别，文档，可接受的参数 <code>schema</code> 等，<a href="https://eslint.org/docs/developer-guide/working-with-rules#rule-basics">官方文档</a>对其有详细描述。</li><li><code>create</code> 主要表达了这条 rule 具体会怎么分析处理代码。</li></ul><p>上面的代码，在运行到 <code>UnaryExpression</code> 会判断它的操作符是否为"<sub>"，并判断是否下一个操作符是否也为"</sub>"。如果匹配到，就会抛出错误。</p><p>拓展，关于 <code>selector:exit</code></p><ul><li>ESLint 的 traverser 用到了递归遍历，是一个由外向内再向外的过程，<code>:exit</code> 相当于添加了一重额外的回调，让我们对静态代码有了更多的控制。</li><li>ESLint 好像也能帮我们找到永远不会执行的语句，如：<a href="https://github.com/eslint/eslint/blob/master/lib/rules/no-unreachable.js">no-unreachable</a>。ESLint 会通过 <a href="https://eslint.org/docs/developer-guide/code-path-analysis">code path analysis</a> 完成这一步骤。</li></ul><h3 id="rule-如何组合生效">rule 如何组合生效？</h3><p>我们由多种途径传递 rule。</p><ol type="1"><li>配置文件中 rule。</li><li>文件内部注释评论的 rule，这部分 rule，被称作 direcive rule。</li></ol><p>ESLint 在获取到了所有需要对单个文件应用的规则之后，接下来就是也该多重遍历的过程。源码位于<a href="https://github.com/eslint/eslint/blob/master/lib/linter/linter.js#L833">runRules</a> 函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 节选源码</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runRules</span>(<span class="params">sourceCode, configuredRules, ruleMapper, parserOptions, parserName, settings, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> emitter = createEmitter();</span><br><span class="line">    <span class="keyword">const</span> nodeQueue = [];</span><br><span class="line">    <span class="keyword">let</span> currentNode = sourceCode.ast;</span><br><span class="line"></span><br><span class="line">    Traverser.traverse(sourceCode.ast, &#123;</span><br><span class="line">        enter(node, parent) &#123;</span><br><span class="line">            node.parent = parent;</span><br><span class="line">            nodeQueue.push(&#123; <span class="attr">isEntering</span>: <span class="literal">true</span>, node &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        leave(node) &#123;</span><br><span class="line">            nodeQueue.push(&#123; <span class="attr">isEntering</span>: <span class="literal">false</span>, node &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        visitorKeys: sourceCode.visitorKeys</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> lintingProblems = [];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.keys(configuredRules).forEach(<span class="function"><span class="params">ruleId</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> severity = ConfigOps.getRuleSeverity(configuredRules[ruleId]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (severity === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> rule = ruleMapper(ruleId);</span><br><span class="line">        <span class="keyword">const</span> messageIds = rule.meta &amp;&amp; rule.meta.messages;</span><br><span class="line">        <span class="keyword">let</span> reportTranslator = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">const</span> ruleContext = <span class="built_in">Object</span>.freeze(</span><br><span class="line">            <span class="built_in">Object</span>.assign(</span><br><span class="line">                <span class="built_in">Object</span>.create(sharedTraversalContext),</span><br><span class="line">                &#123;</span><br><span class="line">                    id: ruleId,</span><br><span class="line">                    options: getRuleOptions(configuredRules[ruleId]),</span><br><span class="line">                    report(...args) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (reportTranslator === <span class="literal">null</span>) &#123;...&#125;</span><br><span class="line">                        <span class="keyword">const</span> problem = reportTranslator(...args);</span><br><span class="line">                        <span class="keyword">if</span> (problem.fix &amp;&amp; rule.meta &amp;&amp; !rule.meta.fixable) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Fixable rules should export a `meta.fixable` property."</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        lintingProblems.push(problem);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> ruleListeners = createRuleListeners(rule, ruleContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add all the selectors from the rule as listeners</span></span><br><span class="line">        <span class="built_in">Object</span>.keys(ruleListeners).forEach(<span class="function"><span class="params">selector</span> =&gt;</span> &#123;</span><br><span class="line">            emitter.on();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> eventGenerator = <span class="keyword">new</span> CodePathAnalyzer(<span class="keyword">new</span> NodeEventGenerator(emitter));</span><br><span class="line"></span><br><span class="line">    nodeQueue.forEach(<span class="function"><span class="params">traversalInfo</span> =&gt;</span> &#123;</span><br><span class="line">        currentNode = traversalInfo.node;</span><br><span class="line">        <span class="keyword">if</span> (traversalInfo.isEntering) &#123;</span><br><span class="line">            eventGenerator.enterNode(currentNode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            eventGenerator.leaveNode(currentNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lintingProblems;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li>遍历依据源码生成的 AST ，将每一个 node 传入 nodeQueue 队列中，每个会被传入两次。</li><li>遍历所有将被应用的规则，为规则中所有的选择器添加监听事件，在触发时执行，将问题 push 到 <code>lintingProblems</code> 中。</li><li>遍历第一步获取到的 nodeQueue，触发其中包含的事件。</li><li>返回 lintingProblems。</li></ol><p>这里用到了 node 的事件驱动机制，遍历的同时触发监听事件。</p><h2 id="plugin">Plugin</h2><p>plugin 大致可以两重概念：</p><ol type="1"><li>在 ESLint 配置项的字段，如 <code>plugins: ["demo"]</code>，调用我们上面的自定义 plugin 。</li><li>社区封装的 ESLint plugin，像 eslint-plugin-vue 这样 npm 模块。</li></ol><p>plugin 可以看作第三方规则的集合，ESLint 本身只会去支持标准的 ECMAScript 语法，如果我们需要在 Vue 中使用ESLint ，我们需要自己去定义一些规则，这样就有了 <a href="https://eslint.vuejs.org/">eslint-plugin-vue</a>。</p><p>plugin的配置规则和ESLint配置文件很相似，关于如何去配置 plugin，我们可以通过 <a href="https://eslint.org/docs/developer-guide/working-with-plugins">working-with-plugins</a> 去查看。</p><p>这里我们特别需要关注的是 plugin 的两种用法。</p><ul><li>在 <code>extends</code> 中使用，plugin有自己的命名空间，可通过 <code>"extends": ["plugin: myPlugin/myConfig"]</code> 引入plugin 的某类规则，具体规则是由plugin中配置的。</li><li>在 <code>plugin</code> 中使用，如添加配置 <code>plugin: ["vue"]</code>，需要在 rule 中声明需要配置的 eslint-plugin-vue 提供的规则。</li></ul><h2 id="自定义parser">自定义Parser</h2><p>plugin 的应用已经大大的增加了 ESLint 的使用规则，但是如果我们需要对一些 JS 的方言添加 Lint 在怎么办呢？</p><p>只需要满足 ESLint 的规定，便能使 ESLint 支持我们的<a href="https://eslint.org/docs/developer-guide/working-with-custom-parsers">自定义 parser</a> 。</p><p>在社区中，我们常见的 parser 有</p><ul><li><a href="https://github.com/babel/babel/tree/main/eslint/babel-eslint-parser">babel-eslint-parser</a></li><li><a href="https://github.com/typescript-eslint/typescript-eslint">typescript-eslint</a></li><li><a href="https://github.com/vuejs/eslint-plugin-vue">eslint-plugin-vue</a></li></ul><p>自定义的 parser 使用方法如下 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"parser"</span>: <span class="string">"./path/to/awesome-custom-parser.js"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="业务中的使用场景">业务中的使用场景</h2><p>除了上面的类似检查 ~~ 的单纯检查编码的场景，还可以将业务中总结的业务规范通过 自定义 ESLint 的方式提示开发者，这对于团队开发，代码维护，确保业务的安全上线都有很大的帮助。</p><p>更多的应用场景：</p><ul><li>代码中不能使用 OSS 地址的静态资源路径，应该使用 CDN 地址的资源路径。</li><li>代码中，工具类 utility 通过统一的路径引入。</li><li>保证 API 的使用规范。</li><li>...</li></ul><h2 id="参考">参考</h2><ul><li><a href="https://humanwhocodes.com/blog/2013/07/16/introducing-eslint/">introduce ESLint</a> by Nicholas C. Zakas</li><li><a href="https://zhuanlan.zhihu.com/p/34656263/">JS Linter 进化史</a></li><li><a href="https://zhuanlan.zhihu.com/p/53680918">ESLint 工作原理探讨</a></li><li><a href="https://cn.eslint.org/docs/developer-guide/architecture">ESLint 架构</a></li></ul><h2 id="拓展">拓展</h2><ul><li><a href="https://eslint.org/docs/developer-guide/code-path-analysis">code-path-analysis</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/project/eslint-logo.png&quot; /&gt;&lt;/p&gt;
&lt;p&gt;原由是想写一个 繁简体 的业务检查，进而一步一步的了解了 ESLint 这个工具~
    
    </summary>
    
      <category term="Lint" scheme="https://hddhyq.github.io/categories/Lint/"/>
    
    
      <category term="ESLint" scheme="https://hddhyq.github.io/tags/ESLint/"/>
    
  </entry>
  
  <entry>
    <title>使用Docker容器</title>
    <link href="https://hddhyq.github.io/2020/05/18/intro-docker/"/>
    <id>https://hddhyq.github.io/2020/05/18/intro-docker/</id>
    <published>2020-05-18T15:30:39.000Z</published>
    <updated>2020-10-28T14:49:48.876Z</updated>
    
    <content type="html"><![CDATA[<p>Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口,更重要的是容器性能开销极低。</p><p>总的来说，docker使得我们部署、发布、扩展、持续集成应用都更加的方便快速。作为开发者是肯定有必要学习下的。</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/devops/Docker.png" alt="" /><figcaption>Docker思维导图</figcaption></figure><a id="more"></a><h2 id="容器containers">容器(Containers)</h2><p>为什么我们需要容器呢？先来看一看代码运行环境的历史，从中看出每次的优缺点。</p><h3 id="历史">历史</h3><ol type="1"><li><strong>裸机</strong></li></ol><p>很久以前，你想要跑一个 Web 服务，你需要买或者去租一个文字服务器，我们称之为"裸机"，您的代码实际上是在处理器上执行的。不过随之产生了一个问题，假如你的应用需要扩展，你需要去购买新的服务器，租新的机房去，需要大量人力去维护你的服务器。<strong>缺点是管理难。维护成本高</strong>。</p><ol start="2" type="1"><li><strong>虚拟机</strong></li></ol><p>虚拟机使你和机器之间增加了一层<strong>抽象</strong>，你可以在服务器上启动多个的 VM 实例，为 VM 分配固定的资源，这提供了很好的<strong>灵活性</strong>。而且虚拟机相对物理机，安全性也进一步提升。虚拟机是独立的操作系统，本身在裸机上运行，但是却无法窥视裸机上的文件和进程，而且一个 VM 实例崩溃了也并不影响其他实例。<strong>缺点是需要牺牲一定的性能作为代价</strong>。</p><ol start="3" type="1"><li><strong>公有云</strong></li></ol><p>可以从Microsoft Azure或Amazon Web Services之类的公有云供应商获取虚拟机。它会预先分配一定数量的内存和计算能力（虚拟核或vCore）。<strong>你不再需要支付昂贵的维护数据中心的费用，但你仍需要管理虚拟机上的软件。</strong></p><ol start="4" type="1"><li><strong>容器</strong></li></ol><p>容器为我们提供了VM的许多安全性和资源管理功能，但又无需运行其他操作系统。它使用 <strong>chroot</strong>，<strong>namespace</strong>和<strong>cgroup</strong>将一组进程彼此分开。<strong>容器是部署代码的未来</strong>。</p><h3 id="基本概念">基本概念</h3><p><strong>chroot</strong>，<strong>namespace</strong>和<strong>cgroup</strong>作为容器的基本概念都有哪些作用呢？</p><ul><li><p><strong>chroot</strong></p><p>chroot 作为 Linux 命令，允许我们<strong>设置新进程的根目录</strong>。在我们的容器用例中，我们设置容器的根目录，那么新的容器进程组看不到任何外部消息，消除了安全性问题，因为新进程在其根目录之外没有可见性。</p></li><li><p><strong>namespace</strong></p><p>namespace和cgroup均用于安全性和资源管理。chroot仅仅隔离了文件，Linux 其他用户还是可以看到计算机正在运行的所有进程，我们需要namespace来<strong>将你从其他进程中隐藏起来</strong>。namespace用来帮助容器之间保持隔离。</p></li><li><p><strong>cgroups</strong></p><p>试想一下每一个隔离的环境都可以访问服务器上的所有物理资源，一个用户因为内存泄漏将所用物理资源都用完，其他的用户该怎么办呢？</p><p>答案是利用cgroups<strong>为每个docker分配固定的cpu和内存</strong>等。</p></li></ul><h2 id="docker">Docker</h2><p>Docker是一种命令行工具，可大大简化创建，更新包装，分发和运行容器的过程。从本质上讲，这是一个命令行，用于以更便捷的方式实现我们对cgroups，namespace和chroot的操作。接下来让我们深入研究Docker的核心概念。</p><ul><li><p><a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></p><p>适用于Mac和Windows。Docker Desktop运行Docker 守护程序（守护程序仅表示始终在后台运行的程序），以便我们可以下载，运行和构建容器。</p></li><li><p><a href="https://hub.docker.com/search?q=&amp;type=image">Docker Hub</a></p><p>Docker Hub是预制容器的公共注册表。可以将其视为容器的npm。您可以从Docker Hub的基本容器开始，然后从那里开始，而不必自己手工完成所有事情。</p></li></ul><h3 id="不通过-docker-使用images">不通过 Docker 使用images</h3><p>预制的容器称为images。它们将容器的状态转储出去，打包并存储，以便以后使用。下例中让我们从Docker Hub中获取一个容器，获取并运行Ubuntu的最新Node.js容器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> start docker contanier with docker running <span class="keyword">in</span> it connected to host docker daemon</span></span><br><span class="line">docker run -ti -v /var/run/docker.sock:/var/run/docker.sock --privileged --rm --name docker-host docker:18.06.1-ce</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> run stock alpine container</span></span><br><span class="line">docker run --rm -dit --name my-alpine alpine:3.10 sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span> running container<span class="string">'s file system</span></span></span><br><span class="line">docker export -o dockercontainer.tar my-alpine</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> make container-root directory, <span class="built_in">export</span> contents of container into it</span></span><br><span class="line">mkdir container-root</span><br><span class="line">tar xf dockercontainer.tar -C container-root/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> make a contained user, mount <span class="keyword">in</span> name spaces</span></span><br><span class="line">unshare --mount --uts --ipc --net --pid --fork --user --map-root-user chroot $PWD/container-root ash # this also does chroot for us</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> here<span class="string">'s where you'</span>d <span class="keyword">do</span> all the cgroup rules making with the settings you wanted to</span></span><br></pre></td></tr></table></figure><p>Docker不仅可以为你做网络，挂载卷和其他事情，还为您做更多的工作，但足以说明Docker为您所做的工作的核心：创建一个新的环境，该环境由namespace隔离，并受cgroups限制，并且将您chroot它。通过上面的代码让我们知道Docker大致在帮着我们做什么工作。</p><h3 id="通过-docker-使用images">通过 Docker 使用images</h3><p>使用Docker进行操作要容易得多，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --interactive --tty alpine:3.10 # or, to be shorter: docker run -it alpine:3.10</span><br></pre></td></tr></table></figure><p>这会使我们以root用户进入容器内部的Alpine ash shell。完成后，只需运行<code>exit</code>或按<code>CTRL + D</code>。</p><p>Docker 运行images有三种方式，</p><ol type="1"><li>运行单个任务</li></ol><p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container run alpine hostname</span><br></pre></td></tr></table></figure> 运行apline并打印hostname，本地没有alpine的时候会自动 Docker Hub 拉取镜像。</p><ol start="2" type="1"><li>交互性运行任务</li></ol><p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container run --interactive --tty --rm ubuntu bash</span><br></pre></td></tr></table></figure> 运行 Ubuntu 容器并打开 <code>bash</code> shell。<code>--interactive</code> 声明交互性，<code>--tty</code> 生成一个伪tty，--rm表明执行完之后删除。</p><ol start="3" type="1"><li>在后台运行任务</li></ol><p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker container run --detach --name mydb -e MYSQL_ROOT_PASS</span><br><span class="line">docker exce -it mydb mysql --user=root --password=$MYSQL_ROOT_PASS --version</span><br></pre></td></tr></table></figure> 上面命令在后台运行一个MySql容器。</p><p>上面标明我们正在使用Node.js版本12，而Stretch是指Debian的版本（默认情况下，Node.js使用的版本）。</p><p>如果<code>docker run -it node</code>隐式运行该标签，则使用该<code>latest</code>标签。所以<code>docker run -it node</code>和<code>docker run -it node:latest</code>是一样的效果。如果需要 node 的 8.0 版本，可以运行 <code>docker run -it node:8 bash</code></p><h3 id="docker-cli-常见命令">Docker-Cli 常见命令</h3><table><thead><tr class="header"><th>名称</th><th>示例命令</th><th>作用</th></tr></thead><tbody><tr class="odd"><td>pull</td><td><code>docker pull jturpin/hollywood</code></td><td>允许您预提取容器以运行，会提前缓存到本地</td></tr><tr class="even"><td>push</td><td><code>docker push xxxxx.com/abc-dev/image:1334</code></td><td>推送到您连接到的任何注册表</td></tr><tr class="odd"><td>inspect</td><td><code>docker inspect node</code></td><td>检查容器的信息</td></tr><tr class="even"><td>pause</td><td><code>docker pause &lt;ID or name&gt;</code></td><td>暂停容器中的所有进程</td></tr><tr class="odd"><td>unpause</td><td><code>docker unpause &lt;ID or name&gt;</code></td><td>取消暂停容器中的所有进程</td></tr><tr class="even"><td>exec</td><td><code>docker exec &lt;ID or name&gt; ps aux</code></td><td>使用<code>ps aux</code>查看计算机上正在运行的内容</td></tr><tr class="odd"><td>save</td><td><code>docker save logmanager:1.0 &gt; logmanager.tar</code></td><td>将image save成tar包</td></tr><tr class="even"><td>load</td><td><code>docker load &lt; my.tar</code></td><td>将一个tar包load成一个image</td></tr><tr class="odd"><td>history</td><td><code>docker history node</code></td><td>查看此Docker映像的层组成如何随时间变化以及最近如何变化</td></tr><tr class="even"><td>info</td><td><code>docker info</code></td><td>查看有关主机系统的大量信息</td></tr><tr class="odd"><td>top</td><td><code>docker top &lt;ID outputted by previous command&gt;</code></td><td>查看容器上运行的进程</td></tr><tr class="even"><td>ps -all</td><td><code>docker ps --all</code></td><td>显示除已运行的容器之外已停止运行的所有容器</td></tr><tr class="odd"><td>rm</td><td><code>docker rm &lt;id or name&gt;</code></td><td>删除容器</td></tr><tr class="even"><td>rmi</td><td><code>docker rmi mongo</code></td><td>删除镜像</td></tr><tr class="odd"><td>logs</td><td><code>docker logs &lt;id from previous command&gt;</code></td><td>查看正在容器日志</td></tr><tr class="even"><td>restart</td><td><code>docker restart myrunoob</code></td><td>重启容器</td></tr><tr class="odd"><td>search</td><td><code>docker search python</code></td><td>查看 Docker Hub 是否存在容器</td></tr></tbody></table><h2 id="dockerfile">Dockerfile</h2><p>Docker有一个名为的特殊文件Dockerfile，用来概述如何构建容器。Docker文件中的每一行都是有关如何更改Docker容器的新指令。Docker容器的一大关键在于它们应该是一次性的。您应该能够根据需求重复创建和删除容器。</p><h3 id="dockerfile示例">Dockerfile示例</h3><p>下面运行一个最简单的一个Docker容器，并且打印<code>"hi lol"</code>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node:12-stretch</span></span><br><span class="line"></span><br><span class="line"><span class="string">CMD</span> <span class="string">["node",</span> <span class="string">"-e"</span><span class="string">,</span> <span class="string">"console.log(\"hi lol\")"</span><span class="string">]</span></span><br></pre></td></tr></table></figure><p>每行（第一件事FROM，并CMD在这种情况下）被称为指令。从技术上讲，它们不必全部大写，但通常这样做是为了使文件更易于阅读。这些指令中的每条指令都将容器从之前的状态递增地更改，从而增加了<code>layer</code>（下面会介绍）。</p><p>如果你运行<code>docker build .</code>，每条指令之后，您将看到一个类似于我们一直在使用的容器ID的哈希。你知道那是为什么吗？这是因为这些层中的每一层本身都是有效的容器映像！使用<code>docker build . --tag my-node-app</code>会让运行容器更方便，<code>docker run my-node-app</code>。</p><h3 id="layer">Layer</h3><p>对Node.js应用进行更改，并且重新运行构建过程的时候，Docker足够聪明，可以看到您的FROM，RUN和WORKDIR指令没有改变。再次构建的时候，它会使用之前缓存的镜像ID，只从你更改的文件开始重新构建。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node:12-stretch</span></span><br><span class="line"></span><br><span class="line"><span class="string">USER</span> <span class="string">node</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">mkdir</span> <span class="string">/home/node/code</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/home/node/code</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">--chown=node:node</span> <span class="string">package-lock.json</span> <span class="string">package.json</span> <span class="string">./</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">--chown=node:node</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">CMD</span> <span class="string">["node",</span> <span class="string">"index.js"</span><span class="string">]</span></span><br></pre></td></tr></table></figure><p>上面，先复制了<code>package.json package-lock.json</code>，并且安装了依赖，那么更改src文件的时候，可以避免完成的npm安装以来过程。这项措施对任何依赖项安装都是有用的，建议将其安装：apt-get，pip，cargo，gem等，以及任何长期运行的命令，例如从源代码构建一些命令。</p><h2 id="制作微型容器">制作微型容器</h2><p>首先我们需要了解微型容器的优点和缺点。</p><p>微型容器的优点有：储存小，更容易迁移。更不容易送到错误的影响（如有python漏洞被利用等）。安全性和规模适合部署应用。</p><p>微型容器的缺点是：缺少了必要的工具包，不利于开发环境。</p><h3 id="自制-alpine-node.js-容器">自制 Alpine Node.js 容器</h3><p>新建Dockerfile:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">alpine:3.10</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">apk</span> <span class="string">add</span> <span class="string">--update</span> <span class="string">nodejs</span> <span class="string">npm</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">addgroup</span> <span class="string">-S</span> <span class="string">node</span> <span class="string">&amp;&amp;</span> <span class="string">adduser</span> <span class="string">-S</span> <span class="string">node</span> <span class="string">-G</span> <span class="string">node</span> <span class="comment"># 添加用户组 node 包含node</span></span><br><span class="line"></span><br><span class="line"><span class="string">USER</span> <span class="string">node</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">mkdir</span> <span class="string">/home/node/code</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/home/node/code</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">--chown=node:node</span> <span class="string">package-lock.json</span> <span class="string">package.json</span> <span class="string">./</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">--chown=node:node</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">CMD</span> <span class="string">["node",</span> <span class="string">"index.js"</span><span class="string">]</span></span><br></pre></td></tr></table></figure><h3 id="多阶段构建">多阶段构建</h3><p>微型容器更适合项目的部署，但是开发中我们安装的一些依赖在部署的过程中并不需要。这里我们需要用到多阶段构建，一个容器用来构造我们的应用程序，一个容器用来运行它。C ++或Rust应用程序可能是一个很好的例子：它们需要大型工具链来编译应用程序，但是生成的二进制文件较小，并且不需要那些工具来实际运行它们。在JS中，或许我们生产中不需要TypeScript或Sass编译器，而仅需要编译文件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build stage</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">node:12-stretch</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/build</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">package-lock.json</span> <span class="string">package.json</span> <span class="string">./</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># runtime stage</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">alpine:3.10</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">apk</span> <span class="string">add</span> <span class="string">--update</span> <span class="string">nodejs</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">addgroup</span> <span class="string">-S</span> <span class="string">node</span> <span class="string">&amp;&amp;</span> <span class="string">adduser</span> <span class="string">-S</span> <span class="string">node</span> <span class="string">-G</span> <span class="string">node</span></span><br><span class="line"><span class="string">USER</span> <span class="string">node</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">mkdir</span> <span class="string">/home/node/code</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/home/node/code</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=0</span> <span class="string">--chown=node:node</span> <span class="string">/build</span> <span class="string">.</span></span><br><span class="line"><span class="comment"># COPY --from=0 表示从第一阶段开始复制，利用--form 可以从任意阶段复制</span></span><br><span class="line"><span class="string">CMD</span> <span class="string">["node",</span> <span class="string">"index.js"</span><span class="string">]</span></span><br></pre></td></tr></table></figure><h3 id="案例静态资源展示">案例：静态资源展示</h3><p>假如我们使用React，TypeScript和Sass构建一个非常基本的前端网站，使用Nginx来展示项目。我们需要使用多阶段的Dockerfile，使得文件在一个容器中构建该项目，使用Nginx在另一个容器中提供服务。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node:latest</span></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/app</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">ci</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># you could totally use nginx:alpine here too</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">nginx:latest</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=0</span> <span class="string">/app/build</span> <span class="string">/usr/share/nginx/html</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t static-app .</span><br><span class="line">docker run -p 8080:80 static-app</span><br></pre></td></tr></table></figure><h2 id="docker的一些特性">Docker的一些特性</h2><h3 id="bind-mounts">bind-mounts</h3><p>假如服务器运行一个Wordpress网站的服务，我们的内容放在容器中，那么容器就没法自由的销毁和重启了。这时，我们需要<code>bind-mounts</code>或者<code>vloume</code>。</p><p>上例中，使用Nginx的服务器，也能<code>bind-mounts</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> from the root directory of your CRA app</span></span><br><span class="line">docker run --mount type=bind,source="$(pwd)"/build,target=/usr/share/nginx/html -p 8080:80 nginx</span><br></pre></td></tr></table></figure><p>解释一下上面的命令：</p><ul><li><code>--mount</code> ，表示将从主机装入某些东西。</li><li><code>type</code>类型有两种<code>bind</code>和<code>vloume</code>。这里使用<code>bind</code>表示从主机挂在一些已存在的数据。</li><li><code>source</code>中，需要确定哪一部分对容器可读写。必须是一个绝对路径，这里使用<code>"$(pwd)"</code>来获取绝对路径。</li><li><code>target</code>表示我们希望将文件安装到容器中的位置。</li><li>我们可以挂载更多的目录，并且可以将<code>bind</code>和<code>vloume</code>混合使用。（我们可以使用另一个<code>bind</code>绑定配置，<code>/etc/nginx/nginx.conf</code>）</li></ul><h3 id="volumes">volumes</h3><p><code>bind-mounts</code>非常适合您需要在主机和容器之间共享数据时使用。容器多次运行，需要保存上一次的运算结果，使用<code>volume</code>会很有用。卷不仅可以在运行之间由相同的容器类型共享，而且可以在不同的容器之间共享。也许如果您有两个容器，并且想通过日志将日志合并到一个位置，则卷可以帮助实现这一点。</p><p>绑定挂载是由主机管理的文件系统。它们只是主机中装入容器的<strong>普通文件</strong>。卷是不同的，因为它们是Docker管理的<strong>新文件系统</strong>，由Docker管理并安装到您的容器中。<strong>这些由Docker管理的文件系统对主机系统不可见。</strong>（实际上可以找到）</p><p>下面展示一个例子，Node会读取某个文件，并添加文件的记录到文件。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dataPath = path.join(process.env.DATA_PATH || <span class="string">"./data.txt"</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(dataPath)</span><br><span class="line">  .then(<span class="function"><span class="params">buffer</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = buffer.toString();</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">    writeTo(+data + <span class="number">1</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"file not found, writing '0' to a new file"</span>);</span><br><span class="line">    writeTo(<span class="number">0</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker build --tag=incrementor .</span><br><span class="line"><span class="meta">#</span><span class="bash"> 多次运行，会提示到不到文件</span></span><br><span class="line">docker run incrementor</span><br><span class="line"><span class="meta">#</span><span class="bash"> 多次运行，第一次找不到，后来累计+1</span></span><br><span class="line">docker run --env DATA_PATH=/data/num.txt --mount type=volume,src=incrementor-data,target=/data incrementor</span><br></pre></td></tr></table></figure><p>我们使用该<code>--env</code>标志将DATA_PATH设置为希望Node.js写入文件的位置，并使用<code>--mount</code>它挂载一个名为的命名卷<code>incrementor-data</code>。您可以将其省略，它将是一个匿名卷，它将继续存在于容器之外，但在以后的运行中不会自动选择正确的卷。</p><p>何时使用 <code>bind-mounts</code>，何时使用 <code>volume</code> 呢？</p><ol type="1"><li><p>需要保存在多次运行之间的东西，使用 <code>bind-mounts</code></p></li><li><p>数据仅在 Docker 中使用和写入，用 <code>volumes</code>。（使用Docker来备份，清理，提高安全性）</p></li></ol><h2 id="在开发环境中使用">在开发环境中使用</h2><p>通过定义Dockerfile，设置了项目所有的依赖关系，从而使它可以100％可重新创建。</p><h3 id="举例hugo">举例：Hugo</h3><p>我们的电脑上没有Go，却想使用Go上的<a href="https://gohugo.io/">Hugo</a>新项目。Hugo是一个很棒的静态网站生成工具，用Go编写，使用<a href="https://hub.docker.com/r/jguyomard/hugo-builder/">hugo-builder</a>可以快速开启一个项目，我们只需要绑定源文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/btholt/hugo-example.git</span><br><span class="line">cd hugo-example/</span><br><span class="line"><span class="meta">#</span><span class="bash"> you could rewrite the --mount here as -v <span class="variable">$PWD</span>:/src</span></span><br><span class="line">docker run --rm -it --mount type=bind,source="$(pwd)",target=/src -p 1313:1313 -u hugo jguyomard/hugo-builder:0.55 hugo server -w --bind=0.0.0.0</span><br></pre></td></tr></table></figure><p>当然，Node.js对此也很有效，只不过，<code>npm install</code>会针对我们使用的OS专门构建依赖项。</p><h3 id="具有visual-studio-code的开发容器">具有Visual Studio Code的开发容器</h3><p>我们需要在项目文件夹中创建一个名为<code>.devcontainer</code>的文件夹。其中放置两个文件，第一个是Dockerfile，我们将在其中设置开发环境。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node:12-stretch</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">-g</span> <span class="string">eslint</span> <span class="string">prettier</span></span><br></pre></td></tr></table></figure><p>接下来创建一个<code>devcontainer.json</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Frontend Masters Sample"</span>,</span><br><span class="line">  <span class="attr">"dockerFile"</span>: <span class="string">"Dockerfile"</span>,</span><br><span class="line">  <span class="attr">"appPort"</span>: [<span class="number">3000</span>],</span><br><span class="line">  <span class="attr">"runArgs"</span>: [<span class="string">"-u"</span>, <span class="string">"node"</span>],</span><br><span class="line">  <span class="attr">"settings"</span>: &#123;</span><br><span class="line">    <span class="attr">"workbench.colorTheme"</span>: <span class="string">"Night Owl"</span>,</span><br><span class="line">    <span class="comment">// "workbench.colorTheme": "Hot Dog Stand",</span></span><br><span class="line">    <span class="attr">"terminal.integrated.shell.linux"</span>: <span class="string">"/bin/bash"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"postCreateCommand"</span>: <span class="string">"npm install"</span>,</span><br><span class="line">  <span class="attr">"extensions"</span>: [</span><br><span class="line">    <span class="comment">// "somekittens.hot-dog-stand",</span></span><br><span class="line">    <span class="string">"sdras.night-owl"</span>,</span><br><span class="line">    <span class="string">"dbaeumer.vscode-eslint"</span>,</span><br><span class="line">    <span class="string">"esbenp.prettier-vscode"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从这里关闭Visual Studio Code，然后再次重新打开该项目。您应该看到一个小提示，询问您是否要在容器中重新打开该项目。点击是！如果错过了该提示，请单击VSCode左下方的（通常为绿色）按钮，看起来有点像 <code>&gt;&lt;</code> 但推到一起。它应该可以选择在开发容器中打开该项目。</p><p>注意：如果您使用的是Windows，并且与WSL一起使用，则必须先将项目从 WSL中删除，然后才能在容器中重新打开该项目。希望这将是将来的顺畅体验。要从WSL进入Windows，请单击左下角的同一 <code>&gt;&lt;</code> 徽标，然后说在Windows中打开。从那里开始，以上说明应该起作用。</p><p>这里的几个关键事项：</p><ul><li>我们可以有两个不同的Dockerfile用于开发和生产。我们可以有一个。我通常有两个，除非它们重叠太多，它们基本上是相同的。</li><li>我们通过确保每个人都为开发人员安装了正确的扩展程序来建立成功的同事。在这种情况下，我将Prettier和ESLint添加到了团队的环境中，以便他们在工作时可以得到即时反馈。</li><li>我们可以将设置添加到他们的环境中（例如保存时格式化），以便所有人的工作方式都一样。不用担心：如果不适合您的团队，您的团队可以覆盖其中的任何一个。</li></ul><h3 id="与docker联网">与Docker联网</h3><p>介绍如何使用Docker进行手动联网，以便您了解Docker Compose和Kubernetes的功能。</p><p>如果我们的Node.js应用程序更加复杂，需要连接正在运行的MongoDB数据库，我们可以在同一容器启动数据库，这么做对于小项目来说行得通，如果我们直接使用mongo容器，则对于应用的拓展等更加友好。所以两个同时运行的容器如何通信和联网呢？</p><p>在Docker中进行网络连接的方法有多种，根据您所使用的操作系统，它们的工作方式有所不同。这是一个很深的主题，我们仅做简单介绍。默认的桥接网络一直在运行，可以查看:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker network ls</span></span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">xxxxxxxxxxxx        bridge                  bridge                 local</span><br><span class="line">xxxxxxxxxxxx        host                     host                    local</span><br><span class="line">xxxxxxxxxxxx        none                    null                    local</span><br></pre></td></tr></table></figure><p>桥接网络是一个一直存在的网络，如果需要，我们可以将其连接，但是Docker再次建议不要使用它，因此我们将创建自己的网络。还有一个主机网络，即主机计算机本身的网络。<code>null</code>如果要使用其他提供程序，或者要自己手动进行操作，则最后一个带有驱动程序的网络就是您要使用的网络。</p><p>继续运行 <code>docker network create --driver=bridge app-net</code></p><p>完成此操作后，让我们启动MongoDB服务器。运行<code>docker run -d --network=app-net -p 27017:27017 --name=db --rm mongo:3</code>。</p><p>我们可以使用另一个 MongoDB容器（因为mongo除了拥有MongoDB服务器之外，它还具有客户端）。运行此：<code>docker run -it --network=app-net --rm mongo:3 mongo --host db</code>。这将是MongoDB容器通过我们的Docker网络连接到另一个容器的一个实例。</p><h3 id="node.js应用连接mongodb">Node.js应用连接MongoDB</h3><p>连接方法对任何数据库同样适用：MySQL，Postgres，Redis等。</p><p>添加读写MongoDB的工具</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; MongoClient &#125; = <span class="built_in">require</span>(<span class="string">"mongodb"</span>);</span><br><span class="line"><span class="keyword">const</span> url = process.env.MONGO_CONNECTION_STRING || <span class="string">"mongodb://localhost:27017"</span>;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> client = <span class="keyword">await</span> MongoClient.connect(url);</span><br><span class="line">  <span class="keyword">const</span> db = client.db(dbName);</span><br><span class="line">  <span class="keyword">const</span> collection = db.collection(collectionName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> server = hapi.server(&#123;</span><br><span class="line">    host: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">    port: process.env.PORT || <span class="number">3000</span></span><br><span class="line">  &#125;);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>如果您的主机上运行了MongoDB，则可以绝对在本地运行此命令，因为默认的连接字符串将连接到本地MonogDB。但我们也将其保持打开状态，以便为应用程序提供环境变量，以便将其修改为其他容器。</p><p>因此，构建容器并使用以下命令运行它：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install mongodb@3.3 # you need to add mongodb to your project</span><br><span class="line">docker build --tag=my-app-with-mongo .</span><br><span class="line">docker run -p 3000:3000 --network=app-net --env MONGO_CONNECTION_STRING=mongodb://db:27017 my-app-with-mongo</span><br></pre></td></tr></table></figure><h2 id="多容器项目">多容器项目</h2><p>我们一直在将您的应用程序部署到生产环境和创建开发环境的各个方面混合在一起。有时我们需要协调多个容器，下面介绍一些协调的方法。</p><h3 id="docker-componse">Docker-componse</h3><p>Docker Compose使我们能够协调多个容器并使用一个YAML文件进行协调。如果您正在开发Node.js应用程序并且需要数据库，缓存，或者即使您在两个或以上相互依赖或以上所有的容器中有两个以上的独立应用程序，这也很棒！Docker Compose使定义这些容器之间的关系并使它们全部运行在一起变得非常简单<code>docker-compose up</code>。</p><p>如果你需要部署Docker容器，Docker Compose适用于生产环境，如果你是开发人员，希望GitHub Actions或某些CI / CD提供程序启动多个环境以快速运行某些测试时，Docker Compose在CI / CD场景中也非常有用。</p><p>让我们开始使用之前的应用程序：一个通过Node.js应用程序连接到MongoDB数据库的应用程序。根目录创建<code>docker-componse.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"3000:3000"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/home/node/code</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/node/code/node_modules</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_CONNECTION_STRING:</span> <span class="string">mongodb://db:27017</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:3</span></span><br></pre></td></tr></table></figure><p>首先<code>version</code>表示当前使用的Docker componse YAML版本。</p><p>在<code>service</code>定义此特定应用程序所需的容器时。我们有两个：<code>web</code>容器（这是我们的应用程序）和<code>db</code>容器，即MongoDB。然后，我们确定Dockerfile所在的位置<code>build</code>，要公开的端口<code>ports</code>，要创建的卷<code>volumes</code>（此处正在装入代码，以便我们可以保留代码而不必重建映像），以及<code>environment</code>使用该字段的变量。</p><p><code>links</code>字段，表示web容器需要连接到db容器。这意味着Docker将首先启动此容器，然后将其联网到该web容器。</p><p>运行<code>docker-compose up</code>就能立即开始我们的项目，我们在web项目下编写我们的Dockerfile，可以使得开发效率更高。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">node:latest</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">i</span> <span class="string">-g</span> <span class="string">nodemon</span></span><br><span class="line"></span><br><span class="line"><span class="string">USER</span> <span class="string">node</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">mkdir</span> <span class="string">/home/node/code</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/home/node/code</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">--chown=node:node</span> <span class="string">package-lock.json</span> <span class="string">package.json</span> <span class="string">./</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">npm</span> <span class="string">ci</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">--chown=node:node</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">CMD</span> <span class="string">["nodemon",</span> <span class="string">"index.js"</span><span class="string">]</span></span><br></pre></td></tr></table></figure><p>没使用Kubernetes之前，我们可以使用<code>docker-compose up --scale web=10</code>将Web容器扩展到10个同时运行的容器。但是目前行不通，因为他们都试图在3000端口侦听主机。但是我们可以使用NGINX或HAProxy之类的方法在容器之间进行负载平衡。这是一个更高级的用例，对Compose则用处不大，因为那时候您可能应该只使用Kubernetes或类似的东西。</p><h3 id="kubernetes">Kubernetes</h3><p>Kubernetes又可以简称k8s（k然后8个字母然后s）。它是作为容器编排工具，管理大型复杂的容器集群到不同的主机上。</p><p>关于k8s的一些基本概念：</p><ul><li>master服务器，作为协调一切的服务器，是集群的大脑。</li><li>nodes服务器，用来实际运行服务的服务器。</li><li>技术上讲，一个节点只是部署目标，可以是VM或者Docker。</li><li>本质上讲，Pod是集群的原子，表示多个容器需要相互依赖启动，例如MongoDB pod和app pod分开，可以单独拓展。</li><li>一个service是一组pods组成的一个backend（可以是服务，也可以是其他东西如机器学习，数据库，缓存）。一个微服务的提供，背后应该是一组微服务。pod按比例放大或者缩小，不依靠一个ip来作为服务，应该使用service作为可靠的切入点。服务之间可以互相通信。</li><li>deployment用来描述你所需的pod状态，以及让kubernetes使集群进入状态。</li></ul><p>我们需要新的cli工具：<code>kubectl</code>。kubectl（<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">有关如何安装的信息，请参见此处</a>）是允许您控制任何 Kubernetes集群的工具，无论它是本地的还是在云中。它是用于管理Kubernetes的单个统一CLI。</p><p>之后，需要在minikube使用Docker桌面内置的Kubernetes支持之间进行选择。如果都一样，我建议使用Docker Desktop，因为它更易于使用。</p><ul><li><p>Docker Desktop附带了非常简单的Kubernetes支持。很高兴学习，但是有一些限制。如果您需要做更复杂的事情，请使用minikube。要在Docker Desktop上启用Kubernetes，请打开Docker Desktop的首选项，导航到Kubernetes选项卡，启用它，在询问是否可以重新启动时接受它，然后等待几分钟。</p></li><li><p>minikube（<a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">有关安装方法，请参见此处</a>）是一个开发工具，可让您的Kubernetes集群在本地计算机上运行。您将只能在本地使用此功能。</p></li></ul><h2 id="引用">引用</h2><ul><li><a href="https://btholt.github.io/complete-intro-to-containers/">complete intro to containers</a></li><li><a href="https://training.play-with-docker.com/">play-with-docker</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。容器是完全使用沙箱机制，相互之间不会有任何接口,更重要的是容器性能开销极低。&lt;/p&gt;
&lt;p&gt;总的来说，docker使得我们部署、发布、扩展、持续集成应用都更加的方便快速。作为开发者是肯定有必要学习下的。&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/devops/Docker.png&quot; alt=&quot;&quot; /&gt;&lt;figcaption&gt;Docker思维导图&lt;/figcaption&gt;
&lt;/figure&gt;
    
    </summary>
    
      <category term="DevOps" scheme="https://hddhyq.github.io/categories/DevOps/"/>
    
    
      <category term="docker" scheme="https://hddhyq.github.io/tags/docker/"/>
    
      <category term="DevOps" scheme="https://hddhyq.github.io/tags/DevOps/"/>
    
  </entry>
  
  <entry>
    <title>浏览器缓存详解</title>
    <link href="https://hddhyq.github.io/2020/04/26/browser-cache-control/"/>
    <id>https://hddhyq.github.io/2020/04/26/browser-cache-control/</id>
    <published>2020-04-26T15:05:31.000Z</published>
    <updated>2020-04-26T15:10:37.146Z</updated>
    
    <content type="html"><![CDATA[<p>利用周末，完整地整理了浏览器中缓存的机制和使用的相关知识。</p><a id="more"></a><h2 id="前言">前言</h2><p>缓存可以说是性能优化中简单高效的一种优化方式了。一个优秀的缓存策略可以缩短网页请求资源的距离，减少延迟，并且由于缓存文件可以重复利用，还可以减少带宽，降低网络负荷。</p><p>基本的网络请求就是三个步骤：请求，处理，响应。前端缓存是在“请求”和“响应”中进行。在“请求”步骤中，浏览器也可以通过存储结果的方式直接使用资源，直接省去了发送请求；而“响应”步骤需要浏览器和服务器共同配合，减少响应内容来缩短传输时间。</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/browser/cache_mind.png" alt="" /><figcaption>思维导图</figcaption></figure><h2 id="缓存过程分析">缓存过程分析</h2><p>浏览器与服务器通信的方式为应答模式，即是：浏览器发起HTTP请求 – 服务器响应该请求。那么浏览器第一次向服务器发起该请求后拿到请求结果，会根据响应报文中HTTP头的缓存标识，决定是否缓存结果，是则将请求结果和缓存标识存入浏览器缓存中，简单的过程如下图：</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/browser/first_request.png" alt="" /><figcaption>第一次请求</figcaption></figure><p>由上图我们可以知道：</p><ul><li><p>浏览器每次发起请求，都会先在浏览器缓存中查找该请求的结果以及缓存标识</p></li><li><p>浏览器每次拿到返回的请求结果都会将该结果和缓存标识存入浏览器缓存中</p></li></ul><p>上面两点结论是浏览器缓存机制的关键，浏览器缓存表示浏览器缓存的位置，对应的 Service Worker、Memory Cache、Disk Cache和Push Cache。这种不向浏览器发送请求的机制是强制缓存，而浏览器缓存失效则使用协商缓存，这一部分将在缓存机制中讨论。</p><h2 id="缓存位置">缓存位置</h2><p>浏览器的缓存位置可以分为四种，并且各自拥有优先级，浏览器发送请求时候依次寻找，找到则返回；找不到则发送网络请求。</p><ol type="1"><li><p>Service Worker</p></li><li><p>Memory Cache</p></li><li><p>Disk Cache</p></li><li><p>Push Cache</p></li></ol><h3 id="service-worker">1. Service Worker</h3><p>Service Worker 是运行在浏览器背后的独立线程，一般可以用来实现缓存功能。使用 Service Worker的话，传输协议必须为 HTTPS。因为 Service Worker 中涉及到请求拦截，所以必须使用 HTTPS 协议来保障安全。<strong>Service Worker 的缓存与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存哪些文件、如何匹配缓存、如何读取缓存，并且缓存是持续性的。</strong></p><p>Service Worker 实现缓存功能一般分为三个步骤：首先需要先注册 Service Worker，然后监听到 install 事件以后就可以缓存需要的文件，那么在下次用户访问的时候就可以通过拦截请求的方式查询是否存在缓存，存在缓存的话就可以直接读取缓存文件，否则就去请求数据。</p><p>Service Worker 能够操作的缓存是有别于浏览器内部的 memory cache 或者 disk cache 的。我们可以从 Chrome 的 F12 中，Application -&gt; Cache Storage 找到这个单独的“小金库”。除了位置不同之外，这个缓存是永久性的，即关闭 TAB 或者浏览器，下次打开依然还在(而 memory cache 不是)。有两种情况会导致这个缓存中的资源被清除：手动调用 API cache.delete(resource) 或者容量超过限制，被浏览器全部清空。</p><p>当 Service Worker 没有命中缓存的时候，我们需要去调用 fetch 函数获取数据。也就是说，如果我们没有在 Service Worker 命中缓存的话，会根据缓存查找优先级去查找数据。但是不管我们是从 Memory Cache 中还是从网络请求中获取的数据，浏览器都会显示我们是从 Service Worker 中获取的内容。</p><h3 id="memory-cache">2. Memory Cache</h3><p>Memory Cache 也就是内存中的缓存, 主要包含的是当前文档中页面中已经抓取到的资源。例如页面上已经下载的样式、脚本、图片等。我们不排除页面可能会对这些资源再次发出请求，所以这些资源都暂存在内存中，<strong>关闭网页时，内存缓存的资源会被释放掉。</strong> <strong>由于计算机内存空间有限，页面能使用的最大内存也是有限的。</strong></p><p>关于请求资源如何进入 Memory Cache, 可以细分为两块：</p><ol type="1"><li><p><strong>preloader</strong>。浏览器在加载网页的时候，会先请求 HTML 然后解析。之后如果浏览器发现了 js, css 等需要解析和执行的资源时，它会使用 CPU 资源对它们进行解析和执行。preloader 负责缓存请求加载的网络资源，将这些资源放入 Memory Cache 中。</p></li><li><p><strong>preload</strong>。例如<code>&lt;link rel="preload"&gt;</code>，显式指定的预加载资源，会被放入 Memory Cache 中。</p></li></ol><p>Memory Cache 机制保证了一个页面如果有两个相同的请求，资源最多被请求一次。在匹配缓存时，除了 URL 匹配外，还需要考虑对它们的类型、CORS中的域名规则等。例如：一个作为脚本(script)的资源，图片(image)类型的是不能直接使用缓存文件的。</p><p>在从 Memory Cache 获取缓存内容时，浏览器会忽视例如 <code>max-age=0</code>, <code>no-cache</code> 等头部配置，因为 Memory Cache 是短期存储，相当于仅当次浏览有效。头部设置为 <code>no-store</code> ，则即便是 memory cache 也不会存储。</p><h3 id="disk-cache">3. Disk Cache</h3><p>Disk Cache是存储在硬盘上的缓存，因此它是持久存储的，是实际存在于文件系统中的。而且它允许相同的资源在跨会话，甚至跨站点的情况下使用，例如两个站点都使用了同一张图片。</p><p>在所有浏览器缓存中，Disk Cache 覆盖面基本是最大的。它会根据 HTTP Header 中的字段判断哪些资源需要缓存，哪些资源可以不请求直接使用，哪些资源已经过期需要重新请求。并且即使在跨站点的情况下，相同地址的资源一旦被硬盘缓存下来，就不会再次去请求数据。绝大部分的缓存都来自 Disk Cache，关于 HTTP 的协议头中的缓存字段，我们会在下文进行详细介绍。</p><h3 id="push-cache">4. Push Cache</h3><p>Push Cache（推送缓存）是 HTTP/2 中的内容，当以上三种缓存都没有命中时，它才会被使用。它只在会话（Session）中存在，一旦会话结束就被释放，并且缓存时间也很短暂，在Chrome浏览器中只有5分钟左右，同时它也并非严格执行HTTP头中的缓存指令。</p><p>Push Cache 在国内能够查到的资料很少，也是因为 HTTP/2 在国内不够普及。这里推荐阅读Jake Archibald的 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fjakearchibald.com%2F2017%2Fh2-push-tougher-than-i-thought%2F">HTTP/2 push is tougher than I thought</a> 这篇文章，文章中的几个结论：</p><ul><li>所有的资源都能被推送，并且能够被缓存,但是 Edge 和 Safari 浏览器支持相对比较差</li><li>可以推送 no-cache 和 no-store 的资源</li><li>一旦连接被关闭，Push Cache 就被释放</li><li>多个页面可以使用同一个HTTP/2的连接，也就可以使用同一个Push Cache。这主要还是依赖浏览器的实现而定，出于对性能的考虑，有的浏览器会对相同域名但不同的tab标签使用同一个HTTP连接。</li><li>Push Cache 中的缓存只能被使用一次</li><li>浏览器可以拒绝接受已经存在的资源推送</li><li>你可以给其他域名推送资源</li></ul><p>如果以上四种缓存都没有命中的话，那么只能发起请求来获取资源了。</p><h2 id="缓存机制">缓存机制</h2><p>浏览器缓存策略是相对于 Disk Cache 来讲的，主要包括了<strong>强制缓存</strong>和<strong>协商缓存</strong>。</p><h3 id="强制缓存">强制缓存</h3><p>强制缓存的含义是，客户端需要发送请求的时候，会先访问客户端缓存数据库检查缓存是否存在。如果存在则直接返回缓存；不存在则请求服务器，响应后再写入缓存数据库。</p><p><strong>强制缓存直接减少请求数，是提升最大的缓存策略。</strong>强缓存可以通过设置两种 HTTP Header 实现：<strong>Expires</strong> 和 <strong>Cache-Control</strong>。</p><h4 id="expires">Expires</h4><p>EXpires 是 HTTP 1.0 的字段，表示缓存到期时间，是一个绝对的时间 (当前时间+缓存时间)，如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expires: Sun, 26 Apr 2020 15:39:32 GMT</span><br></pre></td></tr></table></figure><p>在响应消息头中，设置这个字段之后，就可以告诉浏览器，在未过期之前不需要再次请求。Expires 受限于用户可能将本地时间修改，导致缓存失效。时差、误差等因素也会导致缓存失效。</p><h4 id="cache-control">Cache-control</h4><p>在HTTP/1.1中，Cache-Control是最重要的规则，主要用于控制网页缓存。比如当<code>Cache-Control:max-age=300</code> 时，则代表在这个请求正确返回时间（浏览器也会记录下来）的5分钟内再次加载资源，就会命中强缓存。</p><p>Cache-Control 指令包含：</p><table><thead><tr class="header"><th>指令</th><th>作用</th></tr></thead><tbody><tr class="odd"><td><code>public</code></td><td>响应可以被客户端和代理服务器缓存</td></tr><tr class="even"><td><code>private</code></td><td>响应只可以被客户端缓存</td></tr><tr class="odd"><td><code>max-age=30</code></td><td>缓存30s后过期，需要重新请求</td></tr><tr class="even"><td><code>s-maxage=30</code></td><td>覆盖 max-age，作用一样，只在代理服务器中生效</td></tr><tr class="odd"><td><code>no-store</code></td><td>不缓存任何响应</td></tr><tr class="even"><td><code>no-cache</code></td><td>资源被缓存，但是下次会发起请求验证资源是否过期</td></tr><tr class="odd"><td><code>max-state=30</code></td><td>30s内，即使缓存过期，也使用该缓存</td></tr><tr class="even"><td><code>max-fresh</code></td><td>希望在30s内获取最新响应</td></tr><tr class="odd"><td><code>must-revalidate</code></td><td>如果超过了 <code>max-age</code> 的时间，浏览器必须向服务器发送请求，验证资源是否还有效。</td></tr></tbody></table><p>这些值可以混合使用，例如 Cache-control:public, max-age=2592000。在混合使用时，它们的优先级如下图:</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/browser/cache_control.png" alt="" /><figcaption>cache-control</figcaption></figure><p><strong>Cache-control 的优先级高于 Expires</strong>，为了兼容 HTTP/1.0 和 HTTP/1.1，实际项目中两个字段我们都会设置。</p><h3 id="协商缓存">协商缓存</h3><p>当强制缓存失效(超过规定时间)时，就需要使用协商缓存，由服务器决定缓存内容是否失效。</p><p>主要有两种情况：</p><ul><li><p>协商缓存生效，返回<code>304</code>和<code>Not Modified</code></p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/browser/force_cache.webp" alt="" /><figcaption>force-control</figcaption></figure></li><li><p>协商缓存失效，返回200和请求结果</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/browser/negotiated_cache.webp" alt="" /><figcaption>negotiated-control</figcaption></figure></li></ul><p><strong>对比缓存在请求数上和没有缓存是一致的</strong>，但如果是 <code>304</code> 的话，返回的仅仅是一个状态码而已，并没有实际的文件内容，因此 <strong>在响应体体积上的节省是它的优化点</strong>。协商缓存可以通过设置两种 HTTP Header 实现：<code>Last-Modified</code> 和 <code>ETag</code> 。</p><h4 id="last-modified和if-modified-since">Last-Modified和If-Modified-Since</h4><ol type="1"><li>服务器通过 Last-Modified 字段告知客户端，资源最后一次被修改的时间，例如</li></ol><p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Last-Modified: Sun, 26 Apr 2020 15:39:32 GMT</span><br></pre></td></tr></table></figure></p><ol start="2" type="1"><li><p>浏览器将这个值和内容一起记录在缓存数据库中。</p></li><li><p>下一次请求相同资源时时，浏览器从自己的缓存中找出“不确定是否过期的”缓存。因此在请求头中将上次的 <code>Last-Modified</code> 的值写入到请求头的 <code>If-Modified-Since</code> 字段。</p></li><li><p>服务器会将 <code>If-Modified-Since</code> 的值与 <code>Last-Modified</code> 字段进行对比。如果相等，则表示未修改，响应 <code>304</code>；反之，则表示修改了，响应 <code>200</code> 状态码，并返回数据。</p></li></ol><p><strong>但是 Last-Modified 有一定缺陷的</strong>：</p><ul><li>如果资源更新的速度是秒以下单位，那么该缓存是不能被使用的，因为它的时间单位最低是秒。</li><li>如果文件是通过服务器动态生成的，那么该方法的更新时间永远是生成的时间，尽管文件可能没有变化，所以起不到缓存的作用。</li></ul><h4 id="etag-if-none-match">Etag &amp; If-None-Match</h4><p><strong>Etag是服务器响应请求时，返回当前资源文件的一个唯一标识(由服务器生成)，只要资源有变化，Etag就会重新生成</strong>。<code>Etag</code> 存储的是文件的特殊标识(一般都是 hash 生成的)，服务器存储着文件的 <code>Etag</code> 字段。之后的流程和 <code>Last-Modified</code> 一致，只是 <code>Last-Modified</code> 字段和它所表示的更新时间改变成了 <code>Etag</code> 字段和它所表示的文件 <code>hash</code>，把 <code>If-Modified-Since</code> 变成了 <code>If-None-Match</code>。服务器同样进行比较，命中返回 <code>304</code>, 不命中返回新资源和 <code>200</code>。</p><p><strong>Etag 的优先级高于 Last-Modified</strong></p><h2 id="浏览器行为">浏览器行为</h2><p>用户在浏览器如何操作，会触发哪种缓存策略，主要有三种：</p><ul><li><p>打开网页，地址栏输入地址： 查找 Disk Cache 中是否有匹配。如有则使用；如没有则发送网络请求。</p></li><li><p>普通刷新 (F5)：因为 TAB 页面并没有关闭，因此 Memory Cache 是可用的，会被优先使用(如果匹配的话)。其次才是 Disk Cache。</p></li><li><p>强制刷新 (Ctrl + F5)：浏览器不使用缓存，因此发送的请求头部均带有 <code>Cache-control: no-cache</code>(为了兼容，还带了 <code>Pragma: no-cache</code>)。服务器直接返回 200 和最新内容。</p></li></ul><h2 id="缓存的应用模式">缓存的应用模式</h2><h3 id="模式1-不常变化的资源">模式1: 不常变化的资源</h3><blockquote><p>Cache-Control: max-age=31536000</p></blockquote><p>处理这类资源的时候，给它们的 <code>Cache-Control</code> 配置一个很大的 <code>max-age=31536000</code> (一年)，这样浏览器之后请求相同的 URL 会命中强制缓存。为了解决更新问题，需要在文件名(或者路径)中添加hash、版本号等动态字符，通过更改动态字符，达到更改引用 URL 让之前的强制缓存失效(其实并未立即失效，只是不再使用了而已)。</p><p>在线提供的类库 (如 jquery-3.3.1.min.js, lodash.min.js 等) 均采用这个模式。如果配置中还增加 public 的话，CDN 也可以缓存起来，效果拔群。</p><h3 id="模式2-经常变化的资源">模式2: 经常变化的资源</h3><blockquote><p>Cache-Control: no-cache</p></blockquote><p>这类资源的特点是：URL不能变化，但内容可以(且经常)变化。我们可以设置 <code>Cache-Control: no-cache</code> 来迫使浏览器每次请求都必须找服务器验证资源是否有效。</p><p>既然提到了验证，就必须 ETag 或者 Last-Modified 出场。这些字段都会由专门处理静态资源的常用类库(例如 koa-static)自动添加，无需开发者过多关心。</p><p>也正如上文中提到协商缓存那样，这种模式下，节省的并不是请求数，而是请求体的大小。所以它的优化效果不如模式 1 来的显著。</p><h3 id="模式3反例-对变化的资源添加较短的max-age">模式3(反例): 对变化的资源添加较短的max-age</h3><blockquote><p>Cache-Control: must-revalidate, max-age=600</p></blockquote><p>也许有的开发者看完模式1和2，会想自己的应用时效性不强，又不想做过于长久的强制缓存，想配置 <code>must-revalidate, max-age=600</code> 的折中方案。</p><p>表面上看这很美好：资源可以缓存 10 分钟，10 分钟内读取缓存，10 分钟后和服务器进行一次验证，集两种模式之大成，但实际线上暗存风险。因为上面提过，浏览器的缓存有自动清理机制，开发者并不能控制。</p><p>举个例子：当我们有 3 种资源： index.html, index.js, index.css。我们对这 3 者进行上述配置之后，假设在某次访问时，index.js 已经被缓存清理而不存在，但 index.html, index.css 仍然存在于缓存中。这时候浏览器会向服务器请求新的 index.js，然后配上老的 index.html, index.css 展现给用户。这其中的风险显而易见：不同版本的资源组合在一起，报错是极有可能的结局。</p><p>除了自动清理引发问题，不同资源的请求时间不同也能导致问题。例如 A 页面请求的是 A.js 和 all.css，而 B 页面是 B.js 和 all.css。如果我们以 A -&gt; B 的顺序访问页面，势必导致 all.css 的缓存时间早于 B.js。那么以后访问 B 页面就同样存在资源版本失配的隐患。</p><h2 id="参考引用">参考引用</h2><ul><li><a href="https://calendar.perfplanet.com/2016/a-tale-of-four-caches/">a-tale-of-four-caches</a></li><li><a href="https://jakearchibald.com/2017/h2-push-tougher-than-i-thought/">h2-push-tougher-than-i-thought</a></li><li><a href="https://jakearchibald.com/2016/caching-best-practices/">caching-best-practices</a></li><li><a href="https://zhuanlan.zhihu.com/p/28113197">设计一个无懈可击的浏览器缓存方案</a></li><li><a href="https://www.jianshu.com/p/54cc04190252">深入了解浏览器缓存机制</a></li><li><a href="https://juejin.im/post/5c22ee806fb9a049fb43b2c5">一文读懂前端缓存</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MjM5MTA1MjAxMQ==&amp;mid=2651228395&amp;idx=1&amp;sn=dcf7e3bd518f1e189ce17eaed94c27bb&amp;chksm=bd49516f8a3ed879221bf28bf68ac00c4733a6048c54ea90e75a9e2315a262c2d66fb29a4a34&amp;mpshare=1&amp;scene=1&amp;srcid=0419jU32MPcOkcBWJJVdgj2J#rd">彻底理解浏览器的缓存机制</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;利用周末，完整地整理了浏览器中缓存的机制和使用的相关知识。&lt;/p&gt;
    
    </summary>
    
      <category term="Browser" scheme="https://hddhyq.github.io/categories/Browser/"/>
    
    
      <category term="Browser" scheme="https://hddhyq.github.io/tags/Browser/"/>
    
  </entry>
  
  <entry>
    <title>构建简易网页浏览器</title>
    <link href="https://hddhyq.github.io/2020/03/24/%E6%9E%84%E5%BB%BA%E7%AE%80%E6%98%93%E7%BD%91%E9%A1%B5%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    <id>https://hddhyq.github.io/2020/03/24/构建简易网页浏览器/</id>
    <published>2020-03-24T09:30:16.000Z</published>
    <updated>2020-03-27T08:06:33.236Z</updated>
    
    <content type="html"><![CDATA[<p>这篇文章是对观看<a href="https://www.udacity.com/course/programming-languages--cs262">Programming Languages -Building a Web Browser</a>视频课程的总结。课程介绍了编程语言的基础知识。关键概念包括如何指定和处理有效的字符串，句子和程序结构。课程中使用python来演示相关概念的示例代码。 <a id="more"></a></p><h1 id="概述">概述</h1><h2 id="字符串模式">1. 字符串模式</h2><p>有效的Javascript程序的集合，只是一组非常大的字符串。我们需要使用一些工具来处理它。</p><h2 id="词法分析">2. 词法分析</h2><p>将很大的字符串（例如网页）分解为令牌列表(tokens)，词法分析器使用有限状态机实现。词法分析所定义的<code>type</code>，定义了一连串的值或者相关的操作，像<code>number</code>，<code>string</code>, <code>+ - / *</code>， <code>length</code>和<code>list</code>等。</p><ul><li><p><strong>Regular Expression</strong></p><p>来指定一些字符集的简明表示法。(Regular Language)，用来做词法分析。</p><p>使用诸如<code>r+</code>, <code>r*</code>, <code>r1|r2</code>, <code>[a-z]</code>, <code>r?</code>，来指定<code>token</code>。</p></li><li><p><strong>Finite State Machines</strong></p><p>绘制正则表达式，讨论了正则表达式如何转化成<code>FSM</code>，讨论了<code>DSA</code>(deterministic finite automaton)与<code>NFA</code>(nondeterministic finite automaton)的区别。没有具体讨论实现的算法和<a href="https://zh.wikipedia.org/wiki/%E7%A1%AE%E5%AE%9A%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E8%87%AA%E5%8A%A8%E6%9C%BA">DFA</a>和<a href="https://zh.wikipedia.org/wiki/%E9%9D%9E%E7%A1%AE%E5%AE%9A%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E8%87%AA%E5%8A%A8%E6%9C%BA">NFA</a>状态机的基本定义。</p></li></ul><h2 id="语法分析">3. 语法分析</h2><ul><li><p><strong>Context Free Grammers</strong></p><p>也是用来指定一些字符串集的简明表示法，预先定义一些加法，减法的定义，函数的定义等，用来做语法分析。</p><p>拥有记忆部分，也可以称之为<a href="https://zh.wikipedia.org/wiki/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92">动态规划</a>。</p><p>例如</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 声明语句:</span></span><br><span class="line">stmt =&gt; identifier = exp</span><br><span class="line">exp =&gt; exp + exp</span><br><span class="line">exp =&gt; exp - exp</span><br><span class="line">exp =&gt; number</span><br><span class="line"></span><br><span class="line"><span class="comment"># 表达式语句：</span></span><br><span class="line">stmt =&gt; identifier = exp</span><br><span class="line">stmt =&gt; <span class="built_in">return</span> exp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制流</span></span><br><span class="line">stmt =&gt; <span class="keyword">if</span> exp compoundstmt</span><br><span class="line">stmt =&gt; <span class="keyword">if</span> exp compoundstmt <span class="keyword">else</span> compoundstmt</span><br><span class="line">compoundstmt =&gt; &#123; stmts &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 递归</span></span><br><span class="line">stmts =&gt; stmt stmts</span><br><span class="line">stmt =&gt; some expression</span><br><span class="line"></span><br><span class="line"><span class="comment"># functions, JS 程序就是语句和函数定义列表</span></span><br><span class="line">element =&gt; <span class="keyword">function</span> identifier (optparams) compoundstmt</span><br><span class="line">compoundstmt =&gt; &#123; stmts &#125;</span><br></pre></td></tr></table></figure><p>枚举所有的有效字符串是十分慢的，课程中介绍了记忆图表解析技术的方式，将上下文无关语法和可能记忆组合到一起。其他GLR(广义LR解析)，LALRCD，LLLRLALR等顺带提了一下。</p></li></ul><h2 id="解析">4. 解析</h2><p>如果词法分析获得的<code>tokens</code>列表在预先定义的上下文无关语法(<strong>CFG</strong>)中，则生成解析树。</p><p>解析树的时候，需要带入<code>scope</code>作用域。我们称之为<code>environment</code>变量。</p><p>环境变量主要有两个作用： 1. 将变量映射到值。 2. 指向父环境。</p><p>解释解析树的时候，需要带上<code>environment</code>去解释。</p><p>继而介绍了图灵机的<a href="https://zh.wikipedia.org/wiki/%E5%81%9C%E6%9C%BA%E9%97%AE%E9%A2%98">停机问题</a>，解释了为什么程序部分运行中产生的错误，无法优化，例如<code>while</code>死循环。</p><h2 id="解释">5. 解释</h2><h3 id="解释前需要做的工作">解释前需要做的工作</h3><p>解析前需要做的操作有<code>sematics</code>(语义)和<code>optimization</code>(优化)。</p><p><strong>语义</strong>: 程序可能有类型错误，例如你用字符串除以整数。或者有一些其他的情况，一般情况下会返回一个值，意味着我们已经计算了一下东西。</p><p><strong>优化</strong>：将具有相同语义化但是需要更少资源的程序替换另一端程序。举例<code>x + 1 =&gt; x</code>，使用<code>x</code>替换<code>x + 1</code>计算后的值，优化的关键是不能更改程序的含义，<code>x/x</code>不能替换城<code>1</code>。这一部分，V8引擎会去做。</p><h3 id="解释过程">解释过程</h3><p>在优化的分析树上进行递归遍历，程序的含义通过子表达式的含义计算而得。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/computer/TIM%E5%9B%BE%E7%89%8720200324205604.png" /></p><p>图形展示：</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/computer/TIM%E5%9B%BE%E7%89%8720200324212239.png" /></p><h3 id="web浏览器">web浏览器</h3><p>对<code>HTML</code>使用词法解析和语法解析，将<code>JavaScript</code>视为特殊的令牌，<code>HTML</code>解释器接收<code>JS</code>解释器返回的字符串，<code>HTML</code>解释器调用图形库来展示返回的字符串。</p><h2 id="学习总结">学习总结</h2><p>课程也不是很长，不过在学习的过程中，学习到了很多之前学前端应用知识没有的知识点。涉及了自动机，上下文无关等编译方面的知识。对计算的浏览器的整体运行也有了一个概括，很多知识知识代入性的，它告诉我了有这么个知识点。后期的学习中，可以慢慢挖掘这些知识点，去深入拓展自己的知识深度。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这篇文章是对观看&lt;a href=&quot;https://www.udacity.com/course/programming-languages--cs262&quot;&gt;Programming Languages -Building a Web Browser&lt;/a&gt;视频课程的总结。课程介绍了编程语言的基础知识。关键概念包括如何指定和处理有效的字符串，句子和程序结构。课程中使用python来演示相关概念的示例代码。
    
    </summary>
    
      <category term="Browser" scheme="https://hddhyq.github.io/categories/Browser/"/>
    
    
      <category term="计算机基础" scheme="https://hddhyq.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
      <category term="课程总结" scheme="https://hddhyq.github.io/tags/%E8%AF%BE%E7%A8%8B%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>抽象系统的多重表示</title>
    <link href="https://hddhyq.github.io/2020/02/06/%E6%8A%BD%E8%B1%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%A4%9A%E9%87%8D%E8%A1%A8%E7%A4%BA/"/>
    <id>https://hddhyq.github.io/2020/02/06/抽象系统的多重表示/</id>
    <published>2020-02-06T11:48:22.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>主要是对SICP(Structure and Interpretation of Computer Programs)，第二章四节的读书笔记。</p><p>文中由复数的两种表达形式引出了，基于类型分派(Tagged Data)， 消息传递(Message Passing), 数据导向(Data Directed)。 <a id="more"></a></p><h2 id="复数的表示">复数的表示</h2><p>复数存在两种表达方式：直角坐标形式（实部和虚部），极坐标形式（模和幅角）。如何使两种表达形式共存于同一个系统中。</p><p>复数的两种表达形式分别适用不同的运算。</p><ul><li><p>复数的加法倾向于用直角坐标系：</p><p>实部(Z₁ + Z₂) = 实部(Z₁) + 实部(Z₂)</p><p>虚部(Z₁ + Z₂) = 虚部(Z₁) + 虚部(Z₂)</p></li><li><p>复数的乘法自然的考虑是复数的极坐标：</p><p>模(Z₁ * Z₂) = 模(Z₁) * 模(Z₂)</p><p>幅角(Z₁ * Z₂) = 幅角(Z₁) + 模(Z₂)</p></li></ul><p>从编写程序角度来说，我们需要所有的复数操作都可以使用，不论所用的具体表示形式是什么。</p><h3 id="复数的运算">复数的运算</h3><p>假定所有复数运算的实现都基于如下四个选择函数：<code>real-part</code>, <code>imag-part</code>, <code>magnitude</code>和<code>angle</code>; 两个构造的过程：<code>make-from-real-imag</code>返回一个采用实部和虚部描述的复数，<code>make-from-mag-ang</code>返回一个采用模和幅角描述的复数。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">make-from-real-imag</span> (<span class="name">real-part</span> z) (<span class="name">imag-part</span> z))</span><br><span class="line">(<span class="name">make-from-mag-ang</span> (<span class="name">magnitude</span> z) (<span class="name">angle</span> z))</span><br></pre></td></tr></table></figure><p>复数的加减法采用实部和虚部的方式描述，乘法和除法采用模和幅角的方式描述：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">add-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-real-imag</span> (<span class="name">+</span> (<span class="name">real-part</span> z1) (<span class="name">real-part</span> z2))</span><br><span class="line">                       (<span class="name">+</span> (<span class="name">imag-part</span> z1) (<span class="name">imag-part</span> z2))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">sub-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-real-imag</span> (<span class="name">-</span> (<span class="name">real-part</span> z1) (<span class="name">real-part</span> z2))</span><br><span class="line">                       (<span class="name">-</span> (<span class="name">imag-part</span> z1) (<span class="name">imag-part</span> z2))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">mul-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-mag-ang</span> (<span class="name">*</span> (<span class="name">magnitude</span> z1) (<span class="name">magnitude</span> z2))</span><br><span class="line">                     (<span class="name">+</span> (<span class="name">angle</span> z1) (<span class="name">angle</span> z2))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">div-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-mag-ang</span> (<span class="name">/</span> (<span class="name">magnitude</span> z1) (<span class="name">magnitude</span> z2))</span><br><span class="line">                     (<span class="name">-</span> (<span class="name">angle</span> z1) (<span class="name">angle</span> z2))))</span><br></pre></td></tr></table></figure><p>在这里，实部、虚部、模和幅角有以下关系：</p><ul><li><span class="math inline">\(x = r cos A\)</span></li><li><span class="math inline">\(y = r sin A\)</span></li><li><span class="math inline">\(r = \sqrt{x ^ 2 + y ^ 2}\)</span></li><li><span class="math inline">\(A = arctan(y, x)\)</span></li></ul><p><strong>复数的直角坐标表示</strong></p><p>采用直角坐标表示形式，选取复数与虚部是直截了当的。选取极坐标表示形式则可以利用上面的公式，提供新的选择函数和构造函数：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">real-part</span> z) (<span class="name">car</span> z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">imag-part</span> z) (<span class="name">cdr</span> z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">magnitude</span> z)</span><br><span class="line">  (<span class="name">sqrt</span> (<span class="name">+</span> (<span class="name">square</span> (<span class="name">real-part</span> z)) (<span class="name">square</span> (<span class="name">imag-part</span> z)))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">angle</span> z)</span><br><span class="line">  (<span class="name">atan</span> (<span class="name">imag-part</span> z) (<span class="name">real-part</span> z)))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-real-imag</span> x y) (<span class="name">cons</span> x y))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">  (<span class="name">cons</span> (<span class="name">*</span> r (<span class="name">cos</span> a)) (<span class="name">*</span> r (<span class="name">sin</span> a))))</span><br></pre></td></tr></table></figure><p><strong>复数的极坐标表示</strong></p><p>在复数的极坐标表示中，选取模和幅角的操作直截了当，实部和虚部则需要通过三角关系去获取。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">real-part</span> z)</span><br><span class="line">  (<span class="name">*</span> (<span class="name">magnitude</span> z) (<span class="name">cos</span> (<span class="name">angle</span> z))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">imag-part</span> z)</span><br><span class="line">  (<span class="name">*</span> (<span class="name">magnitude</span> z) (<span class="name">sin</span> (<span class="name">angle</span> z))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">magnitude</span> z) (<span class="name">car</span> z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">angle</span> z) (<span class="name">cdr</span> z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">  (<span class="name">cons</span> (<span class="name">sqrt</span> (<span class="name">+</span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">        (<span class="name">atan</span> y x)))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-mag-ang</span> r a) (<span class="name">cons</span> r a))</span><br></pre></td></tr></table></figure><h2 id="带标志数据">带标志数据</h2><p>如果要在同一个系统里包含复数的两种不同表示形式，需要一种方式，将极坐标形式的数据和直角坐标形式的数据分开。</p><p>假想一下，现在需要找到对偶<code>(3,4)</code>的<code>magnitude</code>，我们无法知道答案是5（将数据解释直角坐标表示形式）还是3（将数据解释为极坐标表示）。</p><p>为了完成这种区分，我们在每个复数包含一个<code>类型标志</code>部分，用符号<code>rectangular</code>或者<code>polar</code>。此后操作一个复数的时候，借助这个标志就可以确定应该使用的选择函数。</p><p>我们需要新定义几个过程，我们假定有过程<code>type-tag</code>和<code>contents</code>，他们分别从数据对象中提取出类型和实际内容（对于复数的情况，其中的极坐标或者直角坐标）。还要假定一个过程<code>attach-tag</code>，它以一个标志和实际内容为参数，生成一个带标志的数据对象。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">attach-tag</span> type-tag contents)</span><br><span class="line"> (<span class="name">cons</span> type-tag contents))</span><br><span class="line">(<span class="name">define</span> (<span class="name">type-tag</span> datum)</span><br><span class="line">  (<span class="name">if</span> (<span class="name">pair</span>? datum)</span><br><span class="line">      (<span class="name">car</span> datum)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Bad tagged datum -- TYPE-TAG"</span> datum)))</span><br><span class="line">(<span class="name">define</span> (<span class="name">contents</span> datum)</span><br><span class="line">  (<span class="name">if</span> (<span class="name">pair</span>? datum)</span><br><span class="line">      (<span class="name">cdr</span> datum)</span><br><span class="line">      (<span class="name">error</span> <span class="string">"Bad tagged datum -- CONTENTS"</span> datum)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;; 添加判断函数</span></span><br><span class="line">(<span class="name">define</span> (<span class="name">rectangular</span>? z)</span><br><span class="line">  (<span class="name">eq</span>? (<span class="name">type-tag</span> z) 'rectangular))</span><br><span class="line">(<span class="name">define</span> (<span class="name">polar</span>? z)</span><br><span class="line">  (<span class="name">eq</span>? (<span class="name">type-tag</span> z) 'polar))</span><br></pre></td></tr></table></figure><h3 id="添加类型tag的直角坐标表示">添加类型tag的直角坐标表示</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">real-part-rectangular</span> z) (<span class="name">car</span> z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">imag-part-rectangular</span> z) (<span class="name">cdr</span> z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">magnitude-rectangular</span> z)</span><br><span class="line">  (<span class="name">sqrt</span> (<span class="name">+</span> (<span class="name">square</span> (<span class="name">real-part-rectangular</span> z))</span><br><span class="line">           (<span class="name">square</span> (<span class="name">imag-part-rectangular</span> z)))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">angle-rectangular</span> z)</span><br><span class="line">  (<span class="name">atan</span> (<span class="name">imag-part-rectangular</span> z)</span><br><span class="line">        (<span class="name">real-part-rectangular</span> z)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;; 直角坐标表示构造函数</span></span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-real-imag-rectangular</span> x y)</span><br><span class="line">  (<span class="name">attach-tag</span> 'rectangular (<span class="name">cons</span> x y)))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-mag-ang-rectangular</span> r a)</span><br><span class="line">  (<span class="name">attach-tag</span> 'rectangular</span><br><span class="line">              (<span class="name">cons</span> (<span class="name">*</span> r (<span class="name">cos</span> a)) (<span class="name">*</span> r (<span class="name">sin</span> a)))))</span><br></pre></td></tr></table></figure><h3 id="添加类型tag的极坐标表示">添加类型tag的极坐标表示</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">real-part-polar</span> z)</span><br><span class="line">  (<span class="name">*</span> (<span class="name">magnitude-polar</span> z) (<span class="name">cos</span> (<span class="name">angle-polar</span> z))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">imag-part-polar</span> z)</span><br><span class="line">  (<span class="name">*</span> (<span class="name">magnitude-polar</span> z) (<span class="name">sin</span> (<span class="name">angle-polar</span> z))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">magnitude-polar</span> z) (<span class="name">car</span> z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">angle-polar</span> z) (<span class="name">cdr</span> z))</span><br><span class="line"></span><br><span class="line"># 极坐标表示构造函数</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-real-imag-polar</span> x y)</span><br><span class="line">  (<span class="name">attach-tag</span> 'polar</span><br><span class="line">               (<span class="name">cons</span> (<span class="name">sqrt</span> (<span class="name">+</span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">                     (<span class="name">atan</span> y x))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-mag-ang-polar</span> r a)</span><br><span class="line">  (<span class="name">attach-tag</span> 'polar (<span class="name">cons</span> r a)))</span><br></pre></td></tr></table></figure><h3 id="通用选择函数的实现">通用选择函数的实现</h3><p>每个通用型选择函数都需要实现这样的过程，首先检查参数的标志，而后去调用处理该类型的适当过程。例如，为了得到一个复数的实部，<code>real-part</code>需要通过检查，设法确定是去使用<code>real-part-rectangular</code>还是<code>real-part-polar</code>。这两种情况下，我们都用<code>contents</code>提取出原始的无标志数据，送给它所需的直角坐标过程或者极坐标过程。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">real-part</span> z)</span><br><span class="line">  (<span class="name">cond</span> ((<span class="name">rectangular</span>? z)</span><br><span class="line">         (<span class="name">real-part-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar</span>? z)</span><br><span class="line">         (<span class="name">real-part-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name">else</span> (<span class="name">error</span> <span class="string">"Unknown type -- REAL-PART"</span> z))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">imag-part</span> z)</span><br><span class="line">  (<span class="name">cond</span> ((<span class="name">rectangular</span>? z)</span><br><span class="line">         (<span class="name">imag-part-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar</span>? z)</span><br><span class="line">         (<span class="name">imag-part-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name">else</span> (<span class="name">error</span> <span class="string">"Unknown type -- IMAG-PART"</span> z))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">magnitude</span> z)</span><br><span class="line">  (<span class="name">cond</span> ((<span class="name">rectangular</span>? z)</span><br><span class="line">         (<span class="name">magnitude-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar</span>? z)</span><br><span class="line">         (<span class="name">magnitude-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name">else</span> (<span class="name">error</span> <span class="string">"Unknown type -- MAGNITUDE"</span> z))))</span><br><span class="line">(<span class="name">define</span> (<span class="name">angle</span> z)</span><br><span class="line">  (<span class="name">cond</span> ((<span class="name">rectangular</span>? z)</span><br><span class="line">         (<span class="name">angle-rectangular</span> (<span class="name">contents</span> z)))</span><br><span class="line">        ((<span class="name">polar</span>? z)</span><br><span class="line">         (<span class="name">angle-polar</span> (<span class="name">contents</span> z)))</span><br><span class="line">        (<span class="name">else</span> (<span class="name">error</span> <span class="string">"Unknown type -- ANGLE"</span> z))))</span><br></pre></td></tr></table></figure><p>实现复数算术运算时，原有的<code>add-complex</code>过程保持不变，因为它们调用的选择函数现在都是通用型，对任何表示都能工作。</p><p>现在我们还需要选择合理的构造函数，合理的选择是手头有实部和虚部时采用直角坐标表示，有模和幅角就采用极坐标表示。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">add-complex</span> z1 z2)</span><br><span class="line">  (<span class="name">make-from-real-imag</span> (<span class="name">+</span> (<span class="name">real-part</span> z1) (<span class="name">real-part</span> z2))</span><br><span class="line">                       (<span class="name">+</span> (<span class="name">imag-part</span> z1) (<span class="name">imag-part</span> z2))))</span><br><span class="line"></span><br><span class="line"><span class="comment">;; 调用合理的构造函数</span></span><br><span class="line"></span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">  (<span class="name">make-from-real-imag-rectangular</span> x y))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">  (<span class="name">make-from-mag-ang-polar</span> r a))</span><br></pre></td></tr></table></figure><p>在给定的一种表示实现中，复数是一种无类型的对偶（模，幅角）。当一个通用型选择函数对一个polar类型的复数进行操作的时，它会剥去标志并将相应内容传递给处理极坐标的代码。与此对应，当极坐标表示构造一个供一般性使用的复数时，也需要为其加上类型标志，使这个对象可以为高层过程所识别。在将数据对象从一个层次传到另一个层次的过程中，这种剥去和加上标志的规范方式可以成为一种重要的组织策略。</p><h2 id="类型分派数据导向消息传递">类型分派，数据导向，消息传递</h2><p>在需要处理针对不同类型的一集公共通用型操作时，事实上，我们所在处理的是一个二维表格，其中一维包含着所有的可能操作，另一维就是所有的可能类型。表格中的项目是一些过程，它们针对作为参数的每个类型实现每一个操作。在前一节中开发的复数系统里，操作名字、数据类型和实际过程之间的对应关系散布在各个通用界面过程的各个条件子句。</p><table><thead><tr class="header"><th>操作</th><th>Polar</th><th>Rectangular</th></tr></thead><tbody><tr class="odd"><td>real-part</td><td>real-part-polar</td><td>real-part-rectangular</td></tr><tr class="even"><td>imag-part</td><td>imag-part-polar</td><td>imag-part-rectangular</td></tr><tr class="odd"><td>magnitude</td><td>magnitude-polar</td><td>magnitude--rectangular</td></tr><tr class="even"><td>angle</td><td>angle-polar</td><td>angle-rectangular</td></tr></tbody></table><h3 id="基于类型的分派">基于类型的分派</h3><blockquote><p>检查一个数据项的类型，并据此去调用某个适当过程称为 <strong>基于类型的分派</strong></p></blockquote><p>类型分派有两个显著的弱点：</p><ol type="1"><li><p>对于处理不同函数类型的通用型选择函数，必须知道所有类型的不同表示。</p></li><li><p>独立的类型标识形式需要避免命名冲突。</p></li></ol><p>上述两个弱点之下的基础问题是，基于类型的分派实现的系统不具有<strong>可加性</strong>。每次新增一种表达形式时，实现通用选择函数的人，必须去修改他们的过程，做单独的类型函数的人也必须修改他们的代码，避免命名冲突。所有的修改直接对代码去做，极易产生错误。再假设，如果我们的系统有上百种不同的复数表示形式？将再难以维护。</p><h3 id="数据导向的程序设计">数据导向的程序设计</h3><p>数据导向的程序设计是一种使程序能直接利用上图表格工作的程序设计技术。</p><p>我们需要实现一个过程，由它用操作名和参数类型的组合到表格中查找，来找出应该调用的适当过程，并将这一过程应用与参数的内容。</p><p>添加新的表示包到系统中，就不需要修改任何现存的代码。</p><p>处理<code>操作/类型</code>表格需要两种方法：(op =&gt; 操作；type =&gt; 类型；item =&gt; 函数)</p><ol type="1"><li><p>将函数放入表格中：<code>(put &lt;op&gt; &lt;type&gt; &lt;item&gt;)</code></p></li><li><p>查找与操作和类型对应的项，获取函数： <code>(get &lt;op&gt; &lt;type&gt;)</code></p></li></ol><p><strong>直角坐标表示的实现</strong></p><p>我们需要定义一组过程或者说一个<strong>程序包</strong>，并通过向表格中加入一些项的方法，告诉系统如何去操作直角坐标形式表示的数。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">install-rectangular-package</span>)</span><br><span class="line">  <span class="comment">;; internal procedures</span></span><br><span class="line">  (<span class="name">define</span> (<span class="name">real-part</span> z) (<span class="name">car</span> z))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">imag-part</span> z) (<span class="name">cdr</span> z))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">make-from-real-imag</span> x y) (<span class="name">cons</span> x y))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">magnitude</span> z)</span><br><span class="line">    (<span class="name">sqrt</span> (<span class="name">+</span> (<span class="name">square</span> (<span class="name">real-part</span> z))</span><br><span class="line">             (<span class="name">square</span> (<span class="name">imag-part</span> z)))))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">angle</span> z)</span><br><span class="line">    (<span class="name">atan</span> (<span class="name">imag-part</span> z) (<span class="name">real-part</span> z)))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">    (<span class="name">cons</span> (<span class="name">*</span> r (<span class="name">cos</span> a)) (<span class="name">*</span> r (<span class="name">sin</span> a))))</span><br><span class="line">  <span class="comment">;; interface to the rest of the system</span></span><br><span class="line">  (<span class="name">define</span> (<span class="name">tag</span> x) (<span class="name">attach-tag</span> 'rectangular x))</span><br><span class="line">  (<span class="name">put</span> 'real-part '(rectangular) real-part)</span><br><span class="line">  (<span class="name">put</span> 'imag-part '(rectangular) imag-part)</span><br><span class="line">  (<span class="name">put</span> 'magnitude '(rectangular) magnitude)</span><br><span class="line">  (<span class="name">put</span> 'angle '(rectangular) angle)</span><br><span class="line">  (<span class="name">put</span> 'make-from-real-imag 'rectangular</span><br><span class="line">       (<span class="name">lambda</span> (<span class="name">x</span> y) (<span class="name">tag</span> (<span class="name">make-from-real-imag</span> x y))))</span><br><span class="line">  (<span class="name">put</span> 'make-from-mag-ang 'rectangular</span><br><span class="line">       (<span class="name">lambda</span> (<span class="name">r</span> a) (<span class="name">tag</span> (<span class="name">make-from-mag-ang</span> r a))))</span><br><span class="line">  'done)</span><br></pre></td></tr></table></figure><p>这笔，直角坐标表示形式的<code>real-part</code>过程安装在操作名字<code>real-part</code>和类型(rectangular)表之下，其余选择函数与之类似。这个过程还提供给外部系统的构造函数。</p><p><strong>极坐标表示的实现</strong> <figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">install-polar-package</span>)</span><br><span class="line">  <span class="comment">;; internal procedures</span></span><br><span class="line">  (<span class="name">define</span> (<span class="name">magnitude</span> z) (<span class="name">car</span> z))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">angle</span> z) (<span class="name">cdr</span> z))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">make-from-mag-ang</span> r a) (<span class="name">cons</span> r a))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">real-part</span> z)</span><br><span class="line">    (<span class="name">*</span> (<span class="name">magnitude</span> z) (<span class="name">cos</span> (<span class="name">angle</span> z))))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">imag-part</span> z)</span><br><span class="line">    (<span class="name">*</span> (<span class="name">magnitude</span> z) (<span class="name">sin</span> (<span class="name">angle</span> z))))</span><br><span class="line">  (<span class="name">define</span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">    (<span class="name">cons</span> (<span class="name">sqrt</span> (<span class="name">+</span> (<span class="name">square</span> x) (<span class="name">square</span> y)))</span><br><span class="line">          (<span class="name">atan</span> y x)))</span><br><span class="line">  <span class="comment">;; interface to the rest of the system</span></span><br><span class="line">  (<span class="name">define</span> (<span class="name">tag</span> x) (<span class="name">attach-tag</span> 'polar x))</span><br><span class="line">  (<span class="name">put</span> 'real-part '(polar) real-part)</span><br><span class="line">  (<span class="name">put</span> 'imag-part '(polar) imag-part)</span><br><span class="line">  (<span class="name">put</span> 'magnitude '(polar) magnitude)</span><br><span class="line">  (<span class="name">put</span> 'angle '(polar) angle)</span><br><span class="line">  (<span class="name">put</span> 'make-from-real-imag 'polar</span><br><span class="line">       (<span class="name">lambda</span> (<span class="name">x</span> y) (<span class="name">tag</span> (<span class="name">make-from-real-imag</span> x y))))</span><br><span class="line">  (<span class="name">put</span> 'make-from-mag-ang 'polar</span><br><span class="line">       (<span class="name">lambda</span> (<span class="name">r</span> a) (<span class="name">tag</span> (<span class="name">make-from-mag-ang</span> r a))))</span><br><span class="line">  'done)</span><br></pre></td></tr></table></figure></p><p><strong>复数运算</strong> 虽然极坐标和直角坐标有些过程有相同的名字（如real-part），但对其他部分而言，这是内部的，不会有名字冲突问题。</p><p>复数系统的选择函数需要通过一个中间函数来访问有关类型<code>apply-generic</code>，访问表格中操作名和参数剋行所适用的过程。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">apply-generic</span> op . args)</span><br><span class="line">  (<span class="name">let</span> ((<span class="name">type-tags</span> (<span class="name">map</span> type-tag args)))</span><br><span class="line">    (<span class="name">let</span> ((<span class="name">proc</span> (<span class="name">get</span> op type-tags)))</span><br><span class="line">      (<span class="name">if</span> proc</span><br><span class="line">          (<span class="name">apply</span> proc (<span class="name">map</span> contents args))</span><br><span class="line">          (<span class="name">error</span></span><br><span class="line">            <span class="string">"No method for these types -- APPLY-GENERIC"</span></span><br><span class="line">            (<span class="name">list</span> op type-tags))))))</span><br></pre></td></tr></table></figure><p>通用型选择函数定义 <figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">real-part</span> z) (<span class="name">apply-generic</span> 'real-part z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">imag-part</span> z) (<span class="name">apply-generic</span> 'imag-part z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">magnitude</span> z) (<span class="name">apply-generic</span> 'magnitude z))</span><br><span class="line">(<span class="name">define</span> (<span class="name">angle</span> z) (<span class="name">apply-generic</span> 'angle z))</span><br></pre></td></tr></table></figure></p><p>实际算数运算中，过程<code>add-complex</code>等保持不变，调用相同的选择函数。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">  ((<span class="name">get</span> 'make-from-real-imag 'rectangular) x y))</span><br><span class="line">(<span class="name">define</span> (<span class="name">make-from-mag-ang</span> r a)</span><br><span class="line">  (<span class="name">get</span> 'make-from-mag-ang 'polar) r a)</span><br></pre></td></tr></table></figure><h3 id="消息传递">消息传递</h3><blockquote><p><strong>消息传递</strong>风格的程序设计来源于，将数据对象设想为一个实体，它以“消息”的方式接受所需操作的名字。</p></blockquote><p>数据传递的程序设计中，最关键的想法就是显式处理<code>操作-类型</code>表格的方式，管理程序中的各种通用型操作。基于类型的分派的组织方式中，让每个操作管理自己的分派。从效果上来看，这种方式就是将<code>操作-类型</code>表格分解成一行一行，每个通用型过程表示为表格的一行。</p><p>消息传递的实现策略是：将表格按列进行分解，不是采用一批“智能操作”去基于数据类型分类，而是采用“智能数据对象”，基于操作名完成分派。我们将数据对象（如一个采用直角坐标表示的复数）表示为一个过程，以操作的名字作为输入，能够去执行指定的操作。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">make-from-real-imag</span> x y)</span><br><span class="line">  (<span class="name">define</span> (<span class="name">dispatch</span> op)</span><br><span class="line">    (<span class="name">cond</span> ((<span class="name">eq</span>? op 'real-part) x)</span><br><span class="line">          ((<span class="name">eq</span>? op 'imag-part) y)</span><br><span class="line">          ((<span class="name">eq</span>? op 'imagnitude)</span><br><span class="line">           (<span class="name">sqrt</span> (<span class="name">+</span> (<span class="name">square</span> x) (<span class="name">square</span> y))))</span><br><span class="line">          ((<span class="name">eq</span>? op 'angle) (<span class="name">atan</span> x y))</span><br><span class="line">          (<span class="name">else</span></span><br><span class="line">           (<span class="name">error</span> <span class="string">"Unkown op -- MAKE-FORM-REAL-IMAG"</span> op))))</span><br><span class="line">  dispatch)</span><br></pre></td></tr></table></figure><p>调用<code>make-from-real-imag</code>返回的是一个过程---内部的dispatch过程。相当于一个整体数据对象。</p><p>对应的<code>apply-generic</code>过程对参数应用一个通用型操作，将操作名传递给数据对象，并让那个对象完成剩下工作。</p><p>消息传递不是一种数学技巧，而是一种有价值的技术，可以用于组织带有通用型操作的系统。</p><h3 id="思考">思考</h3><p>一个带有通用型操作的大型系统可能不断演化，在演化过程中常需要添加新的数据类型或者新的操作。对于上面讨论的三种策略：带有显示分派的通用型操作，数据导向的风格，以及消息传递的风格。请描述在加入一个新类型或者新操作时，系统所必须做的修改。哪种组织方式最适合那些经常需要加入新类型的系统？哪种组织方式最适合那些需要加入新操作的系统。</p><ul><li><p><strong>显示分派</strong>：这种策略在增加新操作时需要使用者避免命名冲突，而且每当增加新类型时，所有通用操作都需要做相应的改动，这种策略不具有可加性，因此无论是增加新操作还是增加新类型，这种策略都不适合。</p></li><li><p><strong>数据导向</strong>：数据导向可以很方便地通过包机制增加新类型和新的通用操作，因此无论是增加新类型还是增加新操作，这种策略都很适合。</p></li><li><p><strong>消息传递</strong>：消息传递将数据对象和数据对象所需的操作整合在一起，因此它可以很方便地增加新类型，但是这种策略不适合增加新操作，因为每次为某个数据对象增加新操作之后，这个数据对象已有的实例全部都要重新实例化才能使用新操作。</p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;主要是对SICP(Structure and Interpretation of Computer Programs)，第二章四节的读书笔记。&lt;/p&gt;
&lt;p&gt;文中由复数的两种表达形式引出了，基于类型分派(Tagged Data)， 消息传递(Message Passing), 数据导向(Data Directed)。
    
    </summary>
    
      <category term="sicp" scheme="https://hddhyq.github.io/categories/sicp/"/>
    
    
      <category term="设计模式" scheme="https://hddhyq.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
      <category term="sicp" scheme="https://hddhyq.github.io/tags/sicp/"/>
    
  </entry>
  
  <entry>
    <title>你所需要了解的CSS变量知识点</title>
    <link href="https://hddhyq.github.io/2019/11/18/%E4%BD%A0%E6%89%80%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84CSS%E5%8F%98%E9%87%8F%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    <id>https://hddhyq.github.io/2019/11/18/你所需要了解的CSS变量知识点/</id>
    <published>2019-11-18T15:29:10.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>大多数的编程语言都支持变量，CSS则从一开始就缺乏对原生变量的支持。好在有 <code>Sass</code> 之类的预处理器，使其在编译时期引入变量。好在 CSS 现在已经支持变量了。尽管预处理增加了对变量的支持，但使用原生的CSS变量也是一个很好的选择，这样可以使我们的页面更加接近未来。 下面会介绍 CSS 的用法和一些案例。</p><a id="more"></a><h2 id="css变量优点">CSS变量优点</h2><p><strong>1. 使代码更具可读性。</strong></p><p>很容易就能分辨出使用了可读性和可维护性强的变量代码库。</p><p><strong>2. 轻松更改大型文档</strong></p><p>如果将所有变量保存在单独的文件中，更改变量的时候，不需要在多个文件之间跳来跳去，只需在单独的文件中更改变量的值就可以了。</p><p><strong>3. 可以更快的发现拼写类型错误</strong></p><p>搜索可能有错误的代码是一件十分痛苦的事，如果错误是由简单的拼写产生的就更加的难受了，使用变量可以很好的消除这些麻烦。</p><p>总的来说，可读性和可维护性是最大的好处。多亏了CSS变量，我们可以在原生的CSS中使用这些变量。</p><h2 id="如何定义-css-变量">如何定义 CSS 变量</h2><p>CSS变量通常以两个破折号开头<code>--</code>。CSS变量也成为<strong>自定义属性</strong>。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.black</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#8cacea</span>;</span><br><span class="line">  <span class="attribute">--color</span>: blue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在JavaScript中，变量是有作用域的，可能是全局作用域或者局部作用域。CSS变量中也有这样的说法。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123;</span><br><span class="line">  <span class="attribute">--main-color</span>: red</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>:root</code>选择器是你可以定位DOM或文档树中的最高级别元素。所以以这种方式声明的变量可以被称作全局作用域的变量。当然，局部作用域的变量也是局单个选择器声明中可以取代全局作用域的变量。</p><h3 id="example-1">Example 1</h3><p>假设您想创建一个CSS变量来存储主题网站的原色。你该怎么做呢？</p><ol type="1"><li>您创建范围选择器。使用<code>:root</code>作为“全局”变量。</li></ol><p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123; &#125;</span><br></pre></td></tr></table></figure></p><ol start="2" type="1"><li>定义变量。</li></ol><p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123; <span class="attribute">--primary-color</span>: red&#125;</span><br></pre></td></tr></table></figure></p><h2 id="使用-css-变量">使用 CSS 变量</h2><p>一旦定义了变量并为其分配了值，就可以继续在属性值中使用它。</p><p>在预处理中，我们必须通过引用声明的变量名来使用它。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$font-size: 20px;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.test</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: $font-size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在原生的CSS变量中，使用方法有所不同。我们通过使用<code>var()</code>函数来引用变量。上例中的写法如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123;</span><br><span class="line">  <span class="attribute">--font-size</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.test</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="built_in">var</span>(--font-size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CSS变量有许多限制。如，你只能将属性值设置给变量；不能使用数学计算，如果要使用数学计算，需要使用<code>calc()</code>函数。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*this is wrong */</span></span><br><span class="line">.margin &#123;--space: 20px * 2;font-size:  var(--space);  //not 40px&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* right way */</span></span><br><span class="line"><span class="selector-class">.margin</span> &#123;<span class="attribute">--space</span>: <span class="built_in">calc</span>(<span class="number">20px</span> * <span class="number">2</span>);<span class="attribute">font-size</span>:  <span class="built_in">var</span>(--space);  <span class="comment">/*equals 40px*/</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="属性值的用法">属性值的用法</h2><p><strong>1. 自定义属性是普通属性，因此可以在任何元素上声明它们。</strong></p><p><strong>2. CSS变量使用常规继承和级联规则进行解析</strong></p><p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123; <span class="attribute">--color</span>: red; &#125;</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.test</span> &#123; <span class="attribute">color</span>: <span class="built_in">var</span>(--color); &#125;</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.ew</span> &#123; <span class="attribute">color</span>: <span class="built_in">var</span>(--color); &#125;</span><br></pre></td></tr></table></figure></p><p><strong>3. CSS变量可以使用@media和其他条件规则作为条件</strong></p><p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123; <span class="attribute">--gutter</span>: <span class="number">10px</span>; &#125;</span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">768px</span>) &#123; <span class="selector-tag">--gutter</span>: 30<span class="selector-tag">px</span>; &#125;</span><br></pre></td></tr></table></figure></p><p><strong>4. CSS变量可以在HTML的style属性中使用</strong> 您可以选择设置内联变量的值，它们仍将按预期运行。</p><p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--HTML--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">style</span>=<span class="string">"--color: red"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-tag">body</span> &#123;  <span class="attribute">color</span>: <span class="built_in">var</span>(--color)&#125;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意，变量声明分辨大小写。尽量使用小写来书写变量。</p><h2 id="关于多个声明">关于多个声明</h2><p>与其他属性一样，使用标准级联可以解析多个声明。 让我们来看一个例子：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*define the variables*/</span></span><br><span class="line"><span class="selector-pseudo">:root</span> &#123; <span class="attribute">--color</span>: blue; &#125;</span><br><span class="line"><span class="selector-tag">div</span> &#123; <span class="attribute">--color</span>: green; &#125;</span><br><span class="line"><span class="selector-id">#alert</span> &#123; <span class="attribute">--color</span>: red; &#125;</span><br><span class="line"><span class="comment">/*use the variable */</span></span><br><span class="line">* &#123; <span class="attribute">color</span>: <span class="built_in">var</span>(--color); &#125;</span><br></pre></td></tr></table></figure><p>使用上面的变量声明，以下元素的颜色是什么？</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- blue --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>What's my color?<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- green --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>and me?<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- red --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'alert'</span>&gt;</span></span><br><span class="line">  What's my color too?</span><br><span class="line">  <span class="comment">&lt;!-- red --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>color?<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面的最后一个<code>&lt;p&gt;color？&lt;/p&gt;</code>你可能期望是<code>blue</code>,但和其他属性一样，CSS变量也是继承的。该值是从父级<code>#alert</code>继承的。</p><h2 id="解决循环依赖">解决循环依赖</h2><p>循环依赖的发生情况。</p><p><strong>1. 何时变量取决于自身。也就是说，它使用引用自身的<code>var（）</code></strong></p><p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123;  <span class="attribute">--m</span>: <span class="built_in">var</span>(--m)&#125;<span class="selector-tag">body</span> &#123;  <span class="attribute">margin</span>: <span class="built_in">var</span>(--m)&#125;</span><br></pre></td></tr></table></figure></p><p><strong>2.当两个或多个变量相互引用时</strong></p><p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123;</span><br><span class="line">  <span class="attribute">--one</span>: <span class="built_in">calc</span>(var(--two) + <span class="number">10px</span>);</span><br><span class="line">  <span class="attribute">--two</span>: <span class="built_in">calc</span>(var(--one) - <span class="number">10px</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注意不要在代码中创建循环依赖关系。</p><h2 id="无效变量会发生什么">无效变量会发生什么？</h2><p>语法错误不会报错，但是无效的<code>var()</code>将会替换默认为相关属性的初始值或继承值。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123; <span class="attribute">--color</span>: <span class="number">20px</span>; &#125;</span><br><span class="line"><span class="selector-tag">p</span> &#123; <span class="attribute">background-color</span>: red; &#125;</span><br><span class="line"><span class="selector-tag">p</span> &#123; <span class="attribute">background-color</span>: <span class="built_in">var</span>(--color); &#125;</span><br></pre></td></tr></table></figure><p>如预期的那样，<code>--color</code>被替换为<code>var()</code>，但替换后的属性值<code>background-color：20px</code>无效。由于<code>background-color</code>不是可继承的属性，因此该值将默认为其透明的初始值。</p><h2 id="构建字段时要小心">构建字段时要小心</h2><p>如下所示设置属性的值时，<code>20px</code>被解释为单个标记。</p><p>一种简单的输入方法是，将值<code>20px</code>视为一个“实体”。</p><p>使用CSS变量构建单个标记时，请务必小心。</p><p>例如，考虑以下代码块：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-pseudo">:root</span> &#123; <span class="attribute">--size</span>: <span class="number">20</span>&#125;</span><br><span class="line"><span class="selector-tag">div</span> &#123;  <span class="attribute">font-size</span>: <span class="built_in">var</span>(--size)<span class="built_in">px</span> <span class="comment">/*WRONG*/</span>&#125;</span><br></pre></td></tr></table></figure><p>您可能期望<code>font-size</code>的值产生<code>20px</code>，但这是错误的。 浏览器将其解释为<code>20 px</code> 注意20后的空格。</p><p>因此，如果您必须创建单个令牌，则用一个变量代表整个令牌。例如<code>--size：20px</code>，或使用<code>calc</code>函数，例如<code>calc（var（-size）* 1px）</code>，其中<code>--size</code>等于20</p><h2 id="使用技巧">使用技巧</h2><h3 id="使用css变量创建组件变体">1. 使用CSS变量创建组件变体</h3><p><code>background: var(--color, black)</code>，如<code>var()</code>函数的第二个属性，设置背景色的回退值。如果变量失效或者不存在，则采用<code>black</code>作为后备选项。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/css/css_variables.png" /></p><p>使用CSS变量能够省去很多重复的书写。</p><h3 id="具有css变量的主题网站">2. 具有CSS变量的主题网站</h3><p>主体CSS，假设给一个按钮绑定事件监听器，一段JS。 <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">var</span>(--bg, white);</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">var</span>(--bg-text, black);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>js代码： <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> root = <span class="built_in">document</span>.documentElement;</span><br><span class="line"><span class="keyword">const</span> themeBtns = <span class="built_in">document</span>.querySelectorAll(<span class="string">'.theme &gt; button'</span>);themeBtns.forEach(<span class="function">(<span class="params">btn</span>) =&gt;</span> &#123;</span><br><span class="line">  btn.addEventListener(<span class="string">'click'</span>, handleThemeUpdate)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleThemeUpdate</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(e.target.value) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'dark'</span>:</span><br><span class="line">      root.style.setProperty(<span class="string">'--bg'</span>, <span class="string">'black'</span>);      root.style.setProperty(<span class="string">'--bg-text'</span>, <span class="string">'white'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'calm'</span>:</span><br><span class="line">      root.style.setProperty(<span class="string">'--bg'</span>, <span class="string">'#B3E5FC'</span>);       root.style.setProperty(<span class="string">'--bg-text'</span>, <span class="string">'#37474F'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'light'</span>:</span><br><span class="line">      root.style.setProperty(<span class="string">'--bg'</span>, <span class="string">'white'</span>);      root.style.setProperty(<span class="string">'--bg-text'</span>, <span class="string">'black'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="关于浏览器的支持">关于浏览器的支持</h2><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/css/4ycpka14Kg2tCJLF6y3b0Zc-XHWCvbwOayAB.png" /></p><p>支持率可以说是非常的好了。</p><h2 id="参考">参考</h2><ul><li><a href="https://www.freecodecamp.org/news/everything-you-need-to-know-about-css-variables-c74d922ea855/"></a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;大多数的编程语言都支持变量，CSS则从一开始就缺乏对原生变量的支持。好在有 &lt;code&gt;Sass&lt;/code&gt; 之类的预处理器，使其在编译时期引入变量。好在 CSS 现在已经支持变量了。尽管预处理增加了对变量的支持，但使用原生的CSS变量也是一个很好的选择，这样可以使我们的页面更加接近未来。 下面会介绍 CSS 的用法和一些案例。&lt;/p&gt;
    
    </summary>
    
      <category term="CSS" scheme="https://hddhyq.github.io/categories/CSS/"/>
    
    
      <category term="CSS" scheme="https://hddhyq.github.io/tags/CSS/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript异步处理(一)：Parallel VS Async &amp;&amp; Callbacks</title>
    <link href="https://hddhyq.github.io/2019/04/19/JavaScript%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%861/"/>
    <id>https://hddhyq.github.io/2019/04/19/JavaScript异步处理1/</id>
    <published>2019-04-19T15:03:11.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>总结 JavaScript 中的五种异步方式及比较。</p><ul><li><a href="/2019/04/19/JavaScript异步处理1/#more">Parallel VS Async</a></li><li><a href="/2019/04/19/JavaScript异步处理1/#more">Callbacks</a></li><li><a href="#">Thunks</a></li><li><a href="#">Promises</a></li><li><a href="#">Generators/Coroutines</a></li><li><a href="#">Event Reactive （Obervables）</a></li><li><a href="#">CSP (channel-oriented cocurrency)</a> <a id="more"></a></li></ul><h2 id="parallel-vs-async">Parallel VS Async</h2><p>并行编程（parallel programming）的编程语言，大致方向都在 CPU 的多核调用、线程的创建和拆除。JavaScript 则是异步调用的方式。</p><p>异步调用（asynchronous） 主要就是避免程序调用中的阻塞发生。举个例子，当你需要对数据库运行查询或从本地磁盘中提取文件，这时通常需要使用异步调用。这个调用将从现存的线程中（例如I/O线程）分离，并在可能的情况下执行它。异步调用可以在同一台电脑上调用，也可以在其他地方的其他电脑上调用（例如访问网上其他服务器的API），它可以有效地防止用户界面不被 “卡住” 或对操作无响应。</p><p>在并行编程中，你仍然可以分解工作或者任务，但关键区别在你可以问每个任务块（chunk）启动新的线程，并且每个线程都可以到达公共变量池。在大多数的情况下，并行编程仅在本地计算器上进行，并且永远不会发送到其他计算机。同样，这是因为对并行任务的每次调用都会创建一个和全新的线程来执行。并行编程也可以保持用户界面快速，并且在运行挑战性的任务时不会感到 “卡住” 。</p><p>也许你现在觉得并行和异步看起来似乎像在做同一件事，事实上，他们完全是两种机制。使用异步调用意味着你将无法控制线程或者线程池（线程的集合），并且依赖系统来处理请求。使用并行编程，你可以很好的控制任务块，甚至可以创建许多线程，来充分利用处理器中可用核心来处理。然而，每次调用创建和拆除线程都是非常系统密集型的，因此编程的时候都需要十分小心。</p><p>最后总结一下，两种模式都是防止阻塞。简单来说，请记住，异步调用使用的是系统已经在使用的线程，并行编程需要开发人员将大的任务打散，注册和拆卸所需线程。</p><blockquote><p>在browser环境下，可以通过使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers">Web Workers</a> 来创建新的线程，这样可以不占用 主UI线程。</p></blockquote><h2 id="callbacks">Callbacks</h2><p>说到回调编写异步程序 ，一定会谈到的就是 <strong>callback hell</strong>。</p><h3 id="什么是-回调地狱">什么是 "回调地狱"？</h3><p>它就是使用回调来执行的异步 JavaScript ，是很难凭直觉取得正确的执行顺序和结果的。大多数的代码就像这样： <img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/js/callbackhell.png" /></p><p>可以看到结尾处的 <code>})</code> 和类似金字塔的结构。这被称作 回调地狱 。</p><p>造成回调地狱的原因是大家试图按照执行的顺序从头到尾的书写 JavaScript 。 JavScript 不像 C ，Ruby，或Python一样需要一行一行的执行代码。</p><h3 id="什么是回调">什么是回调？</h3><p>回调只是对使用 JavaScript 函数的便利的说法。JavaScript 并没有特殊的称作 “callback” 的东西。函数使用回调在一定时间后产出结果，而不是直接获取函数执行的返回值。异步表达的是，“需要一些时间” 或者是 “在将来发生”。通常使用回调的例子诸如，I/O 操作，下载东西，读文件，访问数据库等、</p><p>当你使用一个和正常的函数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = multiplyTwoNumbers(<span class="number">5</span>, <span class="number">10</span>)</span><br><span class="line"><span class="built_in">console</span>.log(result)</span><br><span class="line"><span class="comment">// 50 gets printed out</span></span><br></pre></td></tr></table></figure><p>异步调用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> photo = downloadPhoto(<span class="string">'http://coolcats.com/cat.gif'</span>)</span><br><span class="line"><span class="comment">// photo is "undefined"!</span></span><br></pre></td></tr></table></figure><p>上面的例子中，可能这个 gif 图需要很久才能下载下来，你不想你的程序暂停（阻塞）等待图片的下载完成。而是在函数中储存下载完成后应该运行的代码，这就是回调。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">downloadPhoto(<span class="string">'http://coolcats.com/cat.gif'</span>, handlePhoto)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlePhoto</span> (<span class="params">error, photo</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="built_in">console</span>.error(<span class="string">'Download error!'</span>, error)</span><br><span class="line">  <span class="keyword">else</span> <span class="built_in">console</span>.log(<span class="string">'Download finished'</span>, photo)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Download started'</span>)</span><br></pre></td></tr></table></figure><p>大家试图理解回调最困难的部分就是理解程序执行的顺序。上面下载图片中的例子中，程序执行了三件事，分别是首先打印了 <code>handlePhoto</code> 函数， 然后调用 <code>downloadPhoto</code> 函数，并将 <code>handlePhoto</code> 作为其回调传递，最后打印出 <code>“Download started”</code> 。</p><p>我们需要留意到，<code>handlePhoto</code> 并没有被调用，它只是作为回调被创建和传递到 <code>downloadPhoto</code>。它在 <code>downloadPhoto</code> 任务完成之前都不会被调用。它所调用取决的时间依赖于网络的连接速度。</p><p>这个例子有两个核心的概念：</p><ul><li><p><code>handlePhoto</code> 回调只是一种在以后存储之后会调用的函数。</p></li><li><p>事件的执行顺序不是从上到下来理解的，而是根据时间完成的时机来跳转。</p></li></ul><h3 id="如何修复回调地狱">如何修复回调地狱</h3><p>回调地狱来源于编码经验不足所书写的代码，幸运的是书写好的代码并不是很难。你需要遵守下列三点：</p><h4 id="避免你的代码过度嵌套">避免你的代码过度嵌套</h4><p>这里有一些混乱的在浏览器中运行的请求代码： <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> form = <span class="built_in">document</span>.querySelector(<span class="string">'form'</span>)</span><br><span class="line">form.onsubmit = <span class="function"><span class="keyword">function</span> (<span class="params">submitEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name = <span class="built_in">document</span>.querySelector(<span class="string">'input'</span>).value</span><br><span class="line">  request(&#123;</span><br><span class="line">    uri: <span class="string">"http://example.com/upload"</span>,</span><br><span class="line">    body: name,</span><br><span class="line">    method: <span class="string">"POST"</span></span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, response, body</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> statusMessage = <span class="built_in">document</span>.querySelector(<span class="string">'.status'</span>)</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> statusMessage.value = err</span><br><span class="line">    statusMessage.value = body</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>现在让我们给这两个匿名函数命名，</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> form = <span class="built_in">document</span>.querySelector(<span class="string">'form'</span>)</span><br><span class="line">form.onsubmit = <span class="function"><span class="keyword">function</span> <span class="title">formSubmit</span> (<span class="params">submitEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name = <span class="built_in">document</span>.querySelector(<span class="string">'input'</span>).value</span><br><span class="line">  request(&#123;</span><br><span class="line">    uri: <span class="string">"http://example.com/upload"</span>,</span><br><span class="line">    body: name,</span><br><span class="line">    method: <span class="string">"POST"</span></span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span> <span class="title">postResponse</span> (<span class="params">err, response, body</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> statusMessage = <span class="built_in">document</span>.querySelector(<span class="string">'.status'</span>)</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> statusMessage.value = err</span><br><span class="line">    statusMessage.value = body</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到给具名函数有直观的一些好处：</p><ul><li><p>由于描述性的函数名称，使代码更容易阅读。</p></li><li><p>当异常发生时，您将获得引用实际函数名称而不是“匿名”的堆栈跟踪。</p></li><li><p>允许你移动函数并按名称引用它们。</p></li></ul><p>由于函数声明，我们甚至能随意改变函数的位置，放到文件的底部。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'form'</span>).onsubmit = formSubmit</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formSubmit</span> (<span class="params">submitEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name = <span class="built_in">document</span>.querySelector(<span class="string">'input'</span>).value</span><br><span class="line">  request(&#123;</span><br><span class="line">    uri: <span class="string">"http://example.com/upload"</span>,</span><br><span class="line">    body: name,</span><br><span class="line">    method: <span class="string">"POST"</span></span><br><span class="line">  &#125;, postResponse)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postResponse</span> (<span class="params">err, response, body</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> statusMessage = <span class="built_in">document</span>.querySelector(<span class="string">'.status'</span>)</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> statusMessage.value = err</span><br><span class="line">  statusMessage.value = body</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="模块化">模块化</h4><p>这是最重要的一部分，任何人都能够创建模块（即 库 ）。引用 <a href="http://twitter.com/izs">Isaac Schlueter</a> (node.js项目):</p><blockquote><p>编写小模块来，每个模块都只做一件事，并将它们组装成其他模块来做更大的事。如果你这么做，你永远都不会进入到回调地狱。</p></blockquote><p>我们接着看上面那个例子，然后将其分成多个文件转换成模块。下面将展示适用于浏览器或服务器的模块模式：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 新建一个文件 formupload.js */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formSubmit</span> (<span class="params">submitEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name = <span class="built_in">document</span>.querySelector(<span class="string">'input'</span>).value</span><br><span class="line">  request(&#123;</span><br><span class="line">    uri: <span class="string">"http://example.com/upload"</span>,</span><br><span class="line">    body: name,</span><br><span class="line">    method: <span class="string">"POST"</span></span><br><span class="line">  &#125;, postResponse)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postResponse</span> (<span class="params">err, response, body</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> statusMessage = <span class="built_in">document</span>.querySelector(<span class="string">'.status'</span>)</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> statusMessage.value = err</span><br><span class="line">  statusMessage.value = body</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.submit = formSubmit</span><br></pre></td></tr></table></figure><p>现在我们能在别处引用代码了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> formUpload = <span class="built_in">require</span>(<span class="string">'formuploader'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'form'</span>).onsubmit = formUploader.submit</span><br></pre></td></tr></table></figure><p>我们的主程序调用仅仅只需要两行代码了，而且还有以下的一些好处：</p><ul><li><p>新来的开发者更容易理解，不会因为需要去读冗长的回调代码产生疑惑。</p></li><li><p><code>formUploader</code> 可以再其他地方使用而无需复制代码，可以在 github 或 npm 上轻松共享。</p></li></ul><h4 id="处理每一个错误">处理每一个错误</h4><p>程序运行中，会产生许多错误：语法错误，运行时错误等等。</p><p>前两条准则是保持你的程序更加可读，这条规则则是保证你的程序的可靠性。处理回调时，你可以根据定义处理每一个已分配任务，可以在后台执行某些操作，来监测程序成功完成或者因为错误终止。有经验的开发者常常会告诉你，你不可能知道错误什么时候发生，所以你要做的就是假想他们已经发生。</p><p>Node.js 中常用的处理错误的方式就是 <strong>error-first</strong> 风格，其回调的第一个参数始终为错误保留。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'/Does/not/exist'</span>, handleFile)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleFile</span> (<span class="params">error, file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> <span class="built_in">console</span>.error(<span class="string">'Uhoh, there was an error'</span>, error)</span><br><span class="line">  <span class="comment">// otherwise, continue on and use `file` in your code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>让第一个参数成为错误是一种简单的约定，鼓励你记住处理错误，如果是第二个参数来作为错误处理，就很容易忘记。</p><p>使用一个代码检查工具也能够很好的避免处理错误。</p><h4 id="小结">小结</h4><ol type="1"><li><p>不要嵌套函数，为函数命名并将它们放到程序顶层。</p></li><li><p>使用 函数提升（function hoisting），有利于你将函数转移到程序底部。</p></li><li><p>处理回调中 <strong>每一个错误</strong> 。使用 <a href="http://standardjs.com/">standard</a> 帮助你来处理。</p></li><li><p>创建可重用的函数并将它们放在一个模块中，以减少理解代码所需的认知负担。将代码拆分成这样的小块也可以帮助您处理错误，编写测试，强制你为代码创建稳定且记录的公共API，并有助于重构。</p></li></ol><p>避免回调地狱最有效的方式就是将函数分离出来。这样程序流程可以更易于理解，新接手程序的人不必去了解功能的所有模块也能尝试理解函数正在做什么。</p><p>你可以将函数移到文件底部，或者创建成模块来引用。</p><p>关于创建模块也有一些建议：</p><ul><li><p>将重复使用的代码移到一个函数中。</p></li><li><p>当你的函数（或者相关的函数）变得足够大时，将它们移到另一个文件并使用 module.exports 公开它们，以便于在其他地方加载它们。</p></li><li><p>如果你有一些代码需要在多个项目中使用，请为它书写 readme， tests 和 package.json，并将它发布到 github 和 npm 上。</p></li><li><p>一个好的模块是足够小并且关注于解决一个问题。</p></li><li><p>模块中的单个文件建议不超过150行。</p></li><li><p>一个模块最好不具有超过一层以上的 JavaScript 文件的文件夹，如果超过了，或许它做了过多的事情。</p></li><li><p>了解更多经验丰富的程序员所书写的代码。简洁的模块都是易于理解的。</p></li></ul><h2 id="引用">引用</h2><ul><li>https://frontendmasters.com/courses/rethinking-async-js/</li><li><a href="https://frontendmasters.com/assets/resources/kylesimpson/async.zip">slides&amp;code</a></li><li><a href="http://urda.com/blog/2010/10/04/asynchronous-versus-parallel-programming">asynchronous-versus-parallel-programming</a></li><li>http://callbackhell.com/</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;总结 JavaScript 中的五种异步方式及比较。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2019/04/19/JavaScript异步处理1/#more&quot;&gt;Parallel VS Async&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2019/04/19/JavaScript异步处理1/#more&quot;&gt;Callbacks&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Thunks&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Promises&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Generators/Coroutines&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Event Reactive （Obervables）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;#&quot;&gt;CSP (channel-oriented cocurrency)&lt;/a&gt;
    
    </summary>
    
      <category term="asynchronous" scheme="https://hddhyq.github.io/categories/asynchronous/"/>
    
    
      <category term="async" scheme="https://hddhyq.github.io/tags/async/"/>
    
      <category term="JavaScript" scheme="https://hddhyq.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>webpack 基础(四)： 简单配置</title>
    <link href="https://hddhyq.github.io/2019/04/18/webpack%E5%9F%BA%E7%A1%804/"/>
    <id>https://hddhyq.github.io/2019/04/18/webpack基础4/</id>
    <published>2019-04-18T14:46:08.000Z</published>
    <updated>2020-03-27T08:06:33.233Z</updated>
    
    <content type="html"><![CDATA[<p>webpack 基础最后一篇，总结了一些loader和plugin的使用。 <a id="more"></a></p><h2 id="分割开发环境配置文件">分割开发环境配置文件</h2><p>开发环境中需要更具对应的开发环境选择相应的配置文件，这里总结了下简单的根据环境的配置文件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* webpack.config.js */</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="keyword">const</span> webpackMerge = <span class="built_in">require</span>(<span class="string">"webpack-merge"</span>);</span><br><span class="line"><span class="keyword">const</span> loadPresets = <span class="built_in">require</span>(<span class="string">"./build-utils/loadPresets"</span>);</span><br><span class="line"><span class="keyword">const</span> modeConfig = <span class="function"><span class="params">env</span> =&gt;</span> <span class="built_in">require</span>(<span class="string">`./build-utils/webpack.<span class="subst">$&#123;env&#125;</span>`</span>)(env);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">"html-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">&#123; mode, presets &#125; = &#123; mode: <span class="string">"production"</span>, presets: []&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  webpackMerge(</span><br><span class="line">    &#123;</span><br><span class="line">      mode,</span><br><span class="line">      plugins: [<span class="keyword">new</span> HtmlWebpackPlugin(), <span class="keyword">new</span> webpack.ProgressPlugin()]</span><br><span class="line">    &#125;,</span><br><span class="line">    modeConfig(mode),</span><br><span class="line">    loadPresets(&#123; mode, presets &#125;)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置了上面的环境，可以通过命令行传值给 <code>env</code> 的时候，对应的调用相应的 <code>webpack.&lt;config&gt;.js</code>。</p><p>当让也可以设置一个通用 <code>webpack.base.js</code> 配置。再配置 <code>webpack.prod.js</code> 和 <code>webpack.dev.js</code>，对应的配置文件中，合并 <code>webpack.base.js</code>。</p><p>两种方式都可以使用，如何配置看个人啦。</p><h2 id="使用webpack处理css">使用Webpack处理CSS</h2><p>首先需要在我们的webpack配置文件中，添加对应<code>rules</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: [ <span class="string">"css-loader"</span> ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>下面我们写一个最简单的css文件，并在一个文件中引用，并打印下来，可以看到</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> css <span class="keyword">from</span> <span class="string">'./style.css'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(css);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 转换css文件 */</span></span><br><span class="line"><span class="number">0</span>: (<span class="number">3</span>) [<span class="string">"./src/footer.css"</span>, <span class="string">"header &#123;↵  background: #fff;↵&#125;↵↵footer &#123;↵  background: #000;↵&#125;↵"</span>, <span class="string">""</span>]</span><br><span class="line">i: ƒ (modules, mediaQuery)</span><br><span class="line">toString: ƒ toString()</span><br></pre></td></tr></table></figure><p>紧接着我们在之前的 <code>rules</code> 添加 <code>style-loader</code>。 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">  use: [ <span class="string">"style-loader"</span>, <span class="string">"css-loader"</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在浏览器打开我们的页面，可以看到，<code>&lt;head&gt;&lt;/head&gt;</code> 之间添加了之前定义的css内容。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line">header &#123;</span><br><span class="line"><span class="css">  <span class="selector-tag">background</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">footer &#123;</span><br><span class="line"><span class="css">  <span class="selector-tag">background</span>: <span class="selector-id">#000</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>多个css文件的引入，最终打包成的一个css文件，并且引入标签引入。</p><h2 id="fileloaderurlloader">FileLoader&amp;UrlLoader</h2><p>现在假如我们想在页面中引入一个</p><p><img src="https://raw.githubusercontent.com/webpack/media/master/logo/icon-square-small.jpg" alt="webpack-logo" width="200"/></p><p>那么在配置文件中添加 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* webpack.config.js =&gt; rules */</span></span><br><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.jpe?g$/</span>,</span><br><span class="line">  use: [<span class="string">"url-loader"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* index.js */</span></span><br><span class="line"><span class="keyword">import</span> image <span class="keyword">from</span> <span class="string">'./webpack-logo.jpg'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(image);</span><br></pre></td></tr></table></figure></p><p>我们可以打印出来 <code>base64</code> 格式的图片数据：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QBMRXhpZgAATU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAADaqADAAQAAAABAAAD3QAAAAD/7QA4UGhvdG9zaG9wIDMuMAA4QklNBAQAAAAAAAA4QklNBCUAAAAAABDUHYzZjwCyBOmACZjs+EJ+/...</span><br></pre></td></tr></table></figure><p>现在，如果我们想加载一个图片的话，把引用的 <code>image</code> 赋值给对应的 <code>src</code> 属性就可以了。不过这里我们可以看到一些问题，那就是，直接的图片引用转换成 <code>base64</code> 太大了。我引用的图片的大小是100kb，转换后还会大约增加1/3的体积，所以下面需要限制直接装换成 <code>base64</code> 图片的大小。回到 <code>webpack.config.js</code>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  loader: <span class="string">"url-loader"</span>,</span><br><span class="line">  options: &#123;</span><br><span class="line">    limit: <span class="number">5000</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="应用预设presets">应用预设presets</h2><p>我们的打包过程经常需要，根据不同的流程添加不同的插件，所以我们可以设置一个 <code>loadPresets.js</code> 来动态加载我们所需的 <code>plugins</code> 或 <code>loader</code> 等。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* build-utils/loadPresets.js */</span></span><br><span class="line"><span class="keyword">const</span> webpackMerge = <span class="built_in">require</span>(<span class="string">"webpack-merge"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> applyPresets = <span class="function">(<span class="params">env = &#123;presets: []&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> presets = env.presets || [];</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string[]&#125;</span> </span>*/</span></span><br><span class="line">  <span class="keyword">const</span> mergedPresets = [].concat(...[presets]);</span><br><span class="line">  <span class="keyword">const</span> mergedConfigs = mergedPresets.map(<span class="function"><span class="params">presetName</span> =&gt;</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">`./presets/webpack.<span class="subst">$&#123;presetName&#125;</span>`</span>)(env) <span class="comment">// call the preset and pass env</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> webpackMerge(&#123;&#125;, ...mergedConfigs);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = applyPresets;</span><br></pre></td></tr></table></figure><p>有了这个插件加载，配上我们的 <code>npm scripts</code> 就能很好的加载插件了:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"prod"</span>: <span class="string">"npm run webpack -- --env.mode production"</span>,</span><br><span class="line">  <span class="attr">"prod:typescript"</span>: <span class="string">"npm run prod -- --env.presets typescript"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上所示，我们需要，<code>prod</code> 的时候打包对应的 <code>typescript</code> 文件，这样的命令就能加载对应的组件。有了这个，我们可以根据需求，动态的加载所需的多种预设了。</p><h2 id="添加打包分析插件">添加打包分析插件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add -D webpack-bundle-analyzer</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"prod"</span>: <span class="string">"npm run webpack -- --env.mode production"</span>,</span><br><span class="line">  <span class="attr">"prod:analyze"</span>: <span class="string">"npm run prod -- --env.presets analyze"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加文件: <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WebpackBundleAnalyzer = <span class="built_in">require</span>(<span class="string">"webpack-bundle-analyzer"</span>).BundleAnalyzerPlugin;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  plugins: [ <span class="keyword">new</span> WebpackBundleAnalyzer() ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h2 id="sourcemaps">SourceMaps</h2><p><a href="https://webpack.js.org/configuration/devtool">SourceMaps</a></p><p>可以根据不同的环境，添加不同的 <code>SourceMaps</code> 到 <code>presets</code> ，这样，根据不同的开发目的（调试，正常开发，生产环境等），可以使用不同的 <code>SouceMaps</code>。</p><h2 id="总结">总结</h2><p>webpack基础篇总结结束，后面会加上 webpack进阶篇。</p><p>可以到 https://github.com/webpack-contrib 找优秀的loader和plugins哦。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;webpack 基础最后一篇，总结了一些loader和plugin的使用。
    
    </summary>
    
      <category term="Webpack" scheme="https://hddhyq.github.io/categories/Webpack/"/>
    
    
      <category term="Webpack" scheme="https://hddhyq.github.io/tags/Webpack/"/>
    
      <category term="foundation" scheme="https://hddhyq.github.io/tags/foundation/"/>
    
  </entry>
  
  <entry>
    <title>webpack 基础(三)： 核心概念</title>
    <link href="https://hddhyq.github.io/2019/04/07/Webpack%E5%9F%BA%E7%A1%803/"/>
    <id>https://hddhyq.github.io/2019/04/07/Webpack基础3/</id>
    <published>2019-04-07T06:33:54.000Z</published>
    <updated>2020-03-27T08:06:33.233Z</updated>
    
    <content type="html"><![CDATA[<p>这篇主要谈一下Webpack核心概念 <a id="more"></a></p><h2 id="entry">Entry</h2><p>entry会根据入口文件分析依赖生成依赖关系图。</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/webpack/webpack_entry.png" alt="" /><figcaption>webpack_entry</figcaption></figure><h2 id="ouput">Ouput</h2><p>告诉 Webpack 如何及在哪里分发 bundles (编译后文件)，和 Entry 一起工作。</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/webpack/webpack_output.png" alt="" /><figcaption>webpack_output</figcaption></figure><h2 id="loaderrules">Loader+Rules</h2><h3 id="loaders">loaders</h3><p>Webpack 4.0 中将每一个依赖都当作一个JavaScript Module处理。所以我们需要定义一个规则，如何把一个文件当作JavaScript文件处理。Webpack处理文件依赖的时候，遇到这些文件就会去rules中寻找相对应的loader，处理后将文件加入依赖关系图。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: &#123;</span><br><span class="line">    &#123;<span class="attr">test</span>: <span class="regexp">/\.ts$/</span>, <span class="attr">use</span>: <span class="string">'ts-loader'</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">test</span>: <span class="regexp">/\.js$/</span>, <span class="attr">use</span>: <span class="string">'babel-loader'</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: <span class="string">'css-loader'</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// module: &#123;</span></span><br><span class="line"><span class="comment">//   rules: [</span></span><br><span class="line">    &#123;</span><br><span class="line">      test: regex,</span><br><span class="line">      use: (<span class="built_in">Array</span>|<span class="built_in">String</span>|<span class="built_in">Function</span>),</span><br><span class="line">      include: <span class="built_in">RegExp</span>[],</span><br><span class="line">      exclude: <span class="built_in">RegExp</span>[],</span><br><span class="line">      issuer: (<span class="built_in">RegExp</span>|<span class="built_in">String</span>)[],</span><br><span class="line">      enforce: <span class="string">"pre"</span>|<span class="string">"post"</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//   ]</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><ul><li><p><strong>test</strong>: 一个正则表达式，指定compiler运行loader的文件格式</p></li><li><p><strong>use</strong>: 使用loader对象的array/string/function</p></li><li><p><strong>enforce</strong>: 可以是"pre"or"post"，告诉Webpack这条规则在所有其他规则前面或者后面。</p></li><li><p><strong>include</strong>: 一个正则表达式数组，用来指示compiler哪些文件或者文件夹被包含。complier将仅搜索提供的路径。</p></li><li><p><strong>exclude</strong>: 一个正则表达式数组，用来指示compiler哪些文件或者文件夹被忽略。</p></li></ul><h3 id="链式loaderschaining-loaders">(链式loaders)chaining loaders</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rules: [</span><br><span class="line">  &#123;</span><br><span class="line">    test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">    use: [<span class="string">'style'</span>, <span class="string">'css'</span>, <span class="string">'less'</span>]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">// 调用方法顺序展示</span></span><br><span class="line"><span class="comment">// style(css(less()))</span></span><br></pre></td></tr></table></figure><p>假设我们有一个style.less文件，那么它的调用顺序就是 <strong>style.less</strong> =&gt; less-loader =&gt; css-loader =&gt; style-loader =&gt; <strong>inlineStyleBrowser.js</strong>。</p><p>当然Webpack能通过loader处理大量的文件，如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">son, hson, raw, val, to-string, imports, exports, expose, script, apply, callback, ifdef-loader, source-map, sourceMappingURL,</span><br><span class="line">checksum, cowsay, dsv, glsl, glsl-template, render-placement, xml, svg-react, svg-url, svg-as-symbol, symbol, base64, ng-annotate,</span><br><span class="line">node, required, icons, markup-inline, block-loader, bundler-configuration, console, solc, .sol, web3, includes, combine,</span><br><span class="line">regexp-replace, file, url, extract, worker, shared-worker, serviceworker, bundle, require.ensure, promise, async-module, bundle,</span><br><span class="line">require.ensure, react-proxy, react-hot, image, file, url, img, base64-image, responsive, srcset, svgo, svg-sprite, symbol,</span><br><span class="line">svg-fill, fill, line-art, baggage, polymer, uglify, html-minify, vue, tojson, zip-it, file, lzstring, modernizr, s3, path-replace,</span><br><span class="line">react-intl, require.ensure, font-subset, w3c-manifest, web-app-manifest, manifest-scope, coffee, coffee-jsx, coffee-redux, json5,</span><br><span class="line">es6, esnext, babel, regenerator, livescript, sweetjs, traceur, ts, typescript, awesome-typescript, webpack-typescript, purs, oj,</span><br><span class="line">elm-webpack, miel, wisp, sibilant, ion, html, dom, riot, pug, jade-html, jade-react, virtual-jade, virtual-dom, template-html,</span><br><span class="line">handlebars, handlebars-template-loader, dust, ractive, jsx, react-templates, em, ejs, ejs-html, mustache, yaml, yml,</span><br><span class="line">react-markdown, front-matter, markdown, remarkable, markdown-it, markdownattrs, ng-cache, ngtemplate, hamlc, haml, jinja, nunjucks,</span><br><span class="line">soy, smarty, swagger, template-string, ect, tmodjs, layout, swig, twig, mjml-, bootstrap-webpack, font-awesome-webpack,</span><br><span class="line">bootstrap-sass, bootstrap, bootstrap, font-awesome, style, isomorphic-style, style-loader, css, cess, less, sass, stylus, csso,</span><br><span class="line">rework, postcss, autoprefixer, namespace-css, fontgen, classnames, theo, bulma, css-to-string, css-loader, po, po2mo,</span><br><span class="line">format-message, jsxlate, angular-gettext, json, angular-gettext, webpack-angular-translate, angular-gettext-extract, .pot,</span><br><span class="line">gettext, preprocessor, amdi18n-loader, .json, .js, .coffee, sprockets-preloader, properties, transifex, mocha, coverjs,</span><br><span class="line">istanbul-instrumenter, ibrik-instrumenter, eslint, jshint, jscs, standard, inject, transform, falafel, image-size, csslint,</span><br><span class="line">coffeelint, tslint, parker, sjsp, amdcheck, manifest, gulp-rev, html-test, stylelint, stylefmt, scsslint, htmlhint, documentation,</span><br><span class="line">sassdoc, performance-loader</span><br></pre></td></tr></table></figure><h2 id="plugins">Plugins</h2><p>首先Plugin是一个带有apply属性的对象，它能允许挂载到整个编译生命周期。Webpack本身拥有丰富的内置插件。</p><p>首先来看一个插件例子：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack 3.0 api</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BellOnBundlerErrorPlugin</span> (<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">BellOnBundlerErrorPlugin.prototype.apply = <span class="function"><span class="keyword">function</span>(<span class="params">compiler</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span>(process) !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compiler events that are emitted and handled</span></span><br><span class="line">    compiler.plugin(<span class="string">'done'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">stats</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (stats.hasErrors()) &#123;</span><br><span class="line">        process.stderr.write(<span class="string">'\x07'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    compiler.plugin(<span class="string">'failed'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      process.stderr.write(<span class="string">'\x07'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = BellOnBundlerErrorPlugin;</span><br></pre></td></tr></table></figure><p>我们需要做的就是 new 一个新的实例放到plugins里面。这样有一些基础的插件也能够被复用和修改。</p><p>下面是调用的例子：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> BellOnBundlerErrorPlugin = <span class="built_in">require</span>(‘bell-on-error’);</span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(‘webpack’);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  plugins: [</span><br><span class="line"><span class="keyword">new</span> BellOnBundlerErrorPlugin(),</span><br><span class="line"></span><br><span class="line"><span class="comment">// Just a few of the built in plugins</span></span><br><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(‘vendors’),</span><br><span class="line"><span class="keyword">new</span> webpack.optimize.UglifyJsPlugin()</span><br><span class="line">  ]</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Webpack的80%都是由它自己的插件系统构成的。相较于loader知识处理文件转换成模块，plugin能做的更多。它能访问ComplierAPI，在编译期间做一些事情。</p><h2 id="总结">总结</h2><ul><li><p><strong>Entry</strong>: 告诉 Webpack 哪些文件需要加载到浏览器；编译输出到 output 属性中。</p></li><li><p><strong>Output</strong>: 告诉 Webpack 如何及在哪里分发 bundles (编译后文件)，和 Entry 一起工作。</p></li><li><p><strong>Loaders</strong>: 告诉Webpack如何解释和翻译文件。再将文件添加到依赖关系图之前，对每个文件进行转换。</p></li><li><p><strong>Plugins</strong>: 为编译过程添加更多的功能模块。又有更强大的访问ComplierAPI的能力。</p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这篇主要谈一下Webpack核心概念
    
    </summary>
    
      <category term="Webpack" scheme="https://hddhyq.github.io/categories/Webpack/"/>
    
    
      <category term="Webpack" scheme="https://hddhyq.github.io/tags/Webpack/"/>
    
      <category term="foundation" scheme="https://hddhyq.github.io/tags/foundation/"/>
    
  </entry>
  
  <entry>
    <title>webpack基础(二):认识Webpack</title>
    <link href="https://hddhyq.github.io/2019/04/03/webpack%E5%9F%BA%E7%A1%802/"/>
    <id>https://hddhyq.github.io/2019/04/03/webpack基础2/</id>
    <published>2019-04-03T14:13:58.000Z</published>
    <updated>2020-03-27T08:06:33.233Z</updated>
    
    <content type="html"><![CDATA[<p>Webpack 基础第二部分，认识 Webpack 。从最简单的一个 index.js 文件认识 Webpack。</p><a id="more"></a><p>在开始了解 Webpack 核心概念之前，让我们先看看 Webpack 的生成文件。</p><p>我们先讨论的最简单的 js 文件，不包含 html 及 Webpack jsonp 等加载知识。</p><h2 id="index.js-入口文件">index.js 入口文件</h2><p>我定义了一个最简单的 index.js 作为入口文件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* index.js */</span></span><br><span class="line"><span class="keyword">import</span> nav <span class="keyword">from</span> <span class="string">'./nav'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; top, bottom &#125; <span class="keyword">from</span> <span class="string">'./footer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(nav(), top, bottom);</span><br><span class="line"><span class="comment">/*********************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* footer.js */</span></span><br><span class="line"><span class="keyword">const</span> top = <span class="string">'top'</span>;</span><br><span class="line"><span class="keyword">const</span> bottom = <span class="string">'bottom'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; top, bottom &#125;;</span><br><span class="line"><span class="comment">/*********************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* nav.js */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; <span class="string">'nav'</span>;</span><br><span class="line"><span class="comment">/*********************************************/</span></span><br></pre></td></tr></table></figure><p>这里我们就能够跑一下 Webpack 生成对应的 runtime 文件（要先安装 webpack-cli 哦）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yarn add webpack-cli webpack</span><br><span class="line">$ npm run webpack -- --mode development</span><br></pre></td></tr></table></figure><h2 id="生成-webpackbootstrap-代码">生成 WebpackBootstrap 代码</h2><p>下面来对应的分析下<code>dist</code>目录下的生成代码（代码经过精简）：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Webpack引导</span></span><br><span class="line">  <span class="comment">// 1. 模块缓存</span></span><br><span class="line">  <span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. The require function</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 检查请求模块是否在缓存中，如果在，直接返回缓存中模块</span></span><br><span class="line">    <span class="keyword">if</span> (installedModules[moduleId]) &#123;</span><br><span class="line">      <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建一个新的模块（并将新创建的模块放入缓存中）</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = (installedModules[moduleId] = &#123;</span><br><span class="line">      i: moduleId,</span><br><span class="line">      l: <span class="literal">false</span>,</span><br><span class="line">      exports: &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行模块</span></span><br><span class="line">    modules[moduleId].call(</span><br><span class="line">      <span class="built_in">module</span>.exports,</span><br><span class="line">      <span class="built_in">module</span>,</span><br><span class="line">      <span class="built_in">module</span>.exports,</span><br><span class="line">      __webpack_require__</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标记模块为已加载完成</span></span><br><span class="line">    <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回模块的 exports</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 公开模块对象 (__webpack_modules__)</span></span><br><span class="line">  __webpack_require__.m = modules;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. 公开模块缓存</span></span><br><span class="line">  __webpack_require__.c = installedModules;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  5. 为 harmony exports(ES module exports) 定义 getter 函数</span></span><br><span class="line">  __webpack_require__.d = <span class="function"><span class="keyword">function</span>(<span class="params">exports, name, getter</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!__webpack_require__.o(exports, name)) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(exports, name, &#123;</span><br><span class="line">        configurable: <span class="literal">false</span>,</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        <span class="keyword">get</span>: getter</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  // 6. 为 exports 定义 __esModule 属性</span><br><span class="line">  __webpack_require__.r = function(exports) &#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(exports, <span class="string">'__esModule'</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 7. 定义 getDefaultExport function 用来兼容 non-harmony modules</span></span><br><span class="line">  __webpack_require__.n = <span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> getter =</span><br><span class="line">      <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.__esModule</span><br><span class="line">        ? <span class="function"><span class="keyword">function</span> <span class="title">getDefault</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">module</span>[<span class="string">'default'</span>];</span><br><span class="line">          &#125;</span><br><span class="line">        : <span class="function"><span class="keyword">function</span> <span class="title">getModuleExports</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">          &#125;;</span><br><span class="line">    __webpack_require__.d(getter, <span class="string">'a'</span>, getter);</span><br><span class="line">    <span class="keyword">return</span> getter;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 8. Object.prototype.hasOwnProperty.call</span></span><br><span class="line">  __webpack_require__.o = <span class="function"><span class="keyword">function</span>(<span class="params">object, property</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.hasOwnProperty.call(object, property);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 9. __webpack_public_path__</span></span><br><span class="line">  __webpack_require__.p = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 10. 加载入口模块并返回 exports</span></span><br><span class="line">  <span class="keyword">return</span> __webpack_require__((__webpack_require__.s = <span class="string">'./src/index.js'</span>));</span><br><span class="line">&#125;)(</span><br><span class="line">  <span class="comment">/************************************************************************/</span></span><br><span class="line">  <span class="comment">/******/</span> &#123;</span><br><span class="line">    <span class="comment">/***/</span> <span class="string">'./src/footer.js'</span>:</span><br><span class="line">      <span class="comment">/*!***********************!*\</span></span><br><span class="line"><span class="comment">  !*** ./src/footer.js ***!</span></span><br><span class="line"><span class="comment">  \***********************/</span></span><br><span class="line">      <span class="comment">/*! no static exports found */</span></span><br><span class="line">      <span class="comment">/***/</span> <span class="function"><span class="keyword">function</span>(<span class="params">module, exports</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">eval</span>(</span><br><span class="line">          <span class="string">`const top = 'top';</span></span><br><span class="line"><span class="string">          const bottom = 'bottom';</span></span><br><span class="line"><span class="string">          module.exports = &#123; top, bottom &#125;;</span></span><br><span class="line"><span class="string">          //# sourceURL=webpack:///./src/footer.js?`</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***/</span></span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***/</span> <span class="string">'./src/index.js'</span>:</span><br><span class="line">      <span class="comment">/*!**********************!*\</span></span><br><span class="line"><span class="comment">  !*** ./src/index.js ***!</span></span><br><span class="line"><span class="comment">  \**********************/</span></span><br><span class="line">      <span class="comment">/*! no exports provided */</span></span><br><span class="line">      <span class="comment">/***/</span> <span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">        'use strict'</span>;</span><br><span class="line">        <span class="built_in">eval</span>(</span><br><span class="line">          <span class="string">`__webpack_require__.r(__webpack_exports__);</span></span><br><span class="line"><span class="string">          /* harmony import */ var _nav__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./nav */ "./src/nav.js");</span></span><br><span class="line"><span class="string">          const &#123; top, bottom &#125; = __webpack_require__(/*! ./footer */ "./src/footer.js");</span></span><br><span class="line"><span class="string">          console.log(Object(_nav__WEBPACK_IMPORTED_MODULE_0__["default"])(), top, bottom);</span></span><br><span class="line"><span class="string">          //# sourceURL=webpack:///./src/index.js?`</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***/</span></span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***/</span> <span class="string">'./src/nav.js'</span>:</span><br><span class="line">      <span class="comment">/*!********************!*\</span></span><br><span class="line"><span class="comment">  !*** ./src/nav.js ***!</span></span><br><span class="line"><span class="comment">  \********************/</span></span><br><span class="line">      <span class="comment">/*! exports provided: default */</span></span><br><span class="line">      <span class="comment">/***/</span> <span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">        'use strict'</span>;</span><br><span class="line">        <span class="built_in">eval</span>(</span><br><span class="line">          <span class="string">`__webpack_require__.r(__webpack_exports__);</span></span><br><span class="line"><span class="string">          /* harmony default export */ __webpack_exports__["default"] = (() =&gt; "nav");</span></span><br><span class="line"><span class="string">          //# sourceURL=webpack:///./src/nav.js?`</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***/</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/******/</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="分析-webpackbootstrap">分析 WebpackBootstrap</h2><p>上面的生成的代码主要生成了一个大的 IIFE （立即执行函数）。观察可以发现，三个 js 文件被封装成了三个函数传给这个 IIFE 立即执行函数。Webpack 通过 IIFE 函数作用域来实现模块化。</p><p>执行过程是：</p><ol type="1"><li>定义模块缓存</li><li>定义 <code>__webpack_require__</code> 函数<ul><li>检查请求模块是否在缓存中，如果在，直接返回缓存中模块</li><li>创建一个新的模块（并将新创建的模块放入缓存中）</li><li>执行模块</li><li>标记模块为已加载完成</li><li>返回模块的 exports</li></ul></li><li>定义公开模块对象 (<code>__webpack_require__.m</code>)</li><li>公开模块缓存 (<code>__webpack_require__.c</code>)</li><li>为 harmony exports (ES module exports) 定义 getter 函数</li><li>为 exports 定义 <code>__esModule</code> 属性</li><li>定义 getDefaultExport function 用来兼容 non-harmony modules</li><li>Object.prototype.hasOwnProperty.call</li><li>定义<code>__webpack_public_path__</code></li><li>加载入口模块并返回 exports</li></ol><p>其中，第 10 步调用入口模块之后，可以看到，传入的参数的函数中，模块的请求，继续调用<code>__webpack_require__</code>,实现了一个递归调用和解析模块，递归完成之后，Webpack 也就能生成对应的模块依赖图，相关的调用关系也就很清晰了。</p><p>因为有了模块缓存机制，所以请求过的模块执行过一次之后，就会加入<code>installedModules</code>中，下次调用所需模块就会直接从缓存对象中提取。</p><h2 id="webpack-模块加载对-esm-和-commonjs-的实现对比">Webpack 模块加载对 ESM 和 CommonJs 的实现对比</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  'use strict'</span>;</span><br><span class="line">  <span class="built_in">eval</span>(</span><br><span class="line">    <span class="string">`__webpack_require__.r(__webpack_exports__);</span></span><br><span class="line"><span class="string">    /* harmony import */ var _nav__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./nav */ "./src/nav.js");</span></span><br><span class="line"><span class="string">    const &#123; top, bottom &#125; = __webpack_require__(/*! ./footer */ "./src/footer.js");</span></span><br><span class="line"><span class="string">    console.log(Object(_nav__WEBPACK_IMPORTED_MODULE_0__["default"])(), top, bottom);</span></span><br><span class="line"><span class="string">    //# sourceURL=webpack:///./src/index.js?`</span></span><br><span class="line">  );</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// nav.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="meta">  'use strict'</span>;</span><br><span class="line">  <span class="built_in">eval</span>(</span><br><span class="line">    <span class="string">`__webpack_require__.r(__webpack_exports__);</span></span><br><span class="line"><span class="string">    /* harmony default export */ __webpack_exports__["default"] = (() =&gt; "nav");</span></span><br><span class="line"><span class="string">    //# sourceURL=webpack:///./src/nav.js?`</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// footer.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">module, exports</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">eval</span>(</span><br><span class="line">    <span class="string">`const top = 'top';</span></span><br><span class="line"><span class="string">    const bottom = 'bottom';</span></span><br><span class="line"><span class="string">    module.exports = &#123; top, bottom &#125;;</span></span><br><span class="line"><span class="string">    //# sourceURL=webpack:///./src/footer.js?`</span></span><br><span class="line">  );</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>上面代码<code>__webpack_require__.r(__webpack_exports__)</code>标记了这个模块使用了 ESM ，关于 ESM 的使用方法，定义的<code>__webpack_require__</code>中，去调用<code>nav.js</code>, <code>__webpack_exports__["default"] = (() =&gt; "nav");</code> 通过定义在'default'上的函数来封装了返回的值，只有在需要调用的时候，再进一步去执行获取值，而 footer.js 则是直接执行获取了<code>module.exports = { top, bottom };</code>。</p><p>关于 ESM 和 CommonJS 的互相引用则是利用了<code>__webpack_require__.n</code>来进行包装获取对应的 modules 对象的值。可以看对应的代码。</p><p>=&gt; 7. 定义 getDefaultExport function 用来兼容 non-harmony module</p><p>最后，上面的生成的 WebpackBootstrap 代码 强烈建议放在浏览器的 devtools 的 snippet 中打上断点<strong>运行一遍</strong>来细细的感受一下。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Webpack 基础第二部分，认识 Webpack 。从最简单的一个 index.js 文件认识 Webpack。&lt;/p&gt;
    
    </summary>
    
      <category term="Webpack" scheme="https://hddhyq.github.io/categories/Webpack/"/>
    
    
      <category term="Webpack" scheme="https://hddhyq.github.io/tags/Webpack/"/>
    
      <category term="foundation" scheme="https://hddhyq.github.io/tags/foundation/"/>
    
  </entry>
  
  <entry>
    <title>webpack基础(一)：为什么选择Webpack</title>
    <link href="https://hddhyq.github.io/2019/03/30/webpack%E5%9F%BA%E7%A1%80-1/"/>
    <id>https://hddhyq.github.io/2019/03/30/webpack基础-1/</id>
    <published>2019-03-30T07:20:49.000Z</published>
    <updated>2020-03-27T08:06:33.233Z</updated>
    
    <content type="html"><![CDATA[<p>这是半个月前在 FrontendMasters 看的 <code>Webpack</code> 视频，过了半个月，做一下总结以及回顾。这篇时第一部分，Webpack 基础。</p><a id="more"></a><h2 id="script-标签加载问题">script 标签加载问题</h2><h3 id="难题">难题</h3><p>回到没有前端工具的最原始的时代，如果我们有一段 <code>Javascript</code> 代码，我们有两种方式加载它：</p><ol type="1"><li><p>直接在 html 书写这段 script。</p></li><li><p>使用<code>&lt;script src="*.js"&gt;&lt;/script&gt;</code></p></li></ol><p>随之带来的问题有：</p><ol type="1"><li><p>无法被压缩。</p></li><li><p>过多的<code>script</code>标签。</p><p>在 <code>HTTP1.1</code> 情况下，浏览器的同时最大连接数为:</p></li></ol><table><thead><tr class="header"><th>version</th><th>Maximun connections</th></tr></thead><tbody><tr class="odd"><td>Internet Explorer® 7.0</td><td>2</td></tr><tr class="even"><td>Internet Explorer 8.0 and 9.0</td><td>6</td></tr><tr class="odd"><td>Internet Explorer 10.0</td><td>8</td></tr><tr class="even"><td>Internet Explorer 11.0</td><td>13</td></tr><tr class="odd"><td>Firefox®</td><td>6</td></tr><tr class="even"><td>Chrome™</td><td>6</td></tr><tr class="odd"><td>Safari®</td><td>6</td></tr><tr class="even"><td>Opera®</td><td>6</td></tr><tr class="odd"><td>iOS®</td><td>6</td></tr><tr class="even"><td>Android™</td><td>6</td></tr></tbody></table><ol start="3" type="1"><li>脚本难以维护。<ul><li>作用域</li><li>脚本尺寸</li><li>可读性</li><li>及其脆弱</li><li>整体文件过大</li></ul></li></ol><h3 id="解决方法">解决方法？</h3><p>这时 IIFE（Immediately Invoked Function Expression）立即执行函数出现在人们眼前。</p><p>一个最简单的 IIFE 函数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> outerScope = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> whatever = <span class="function"><span class="keyword">function</span>(<span class="params">dataNowUsedInside</span>) </span>&#123;</span><br><span class="line">  outerScope = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    someAttribute: <span class="string">'youwant'</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(outerScope);</span><br><span class="line"><span class="comment">// &gt; 1</span></span><br><span class="line"><span class="comment">// 内部赋值没有影响外部作用域</span></span><br><span class="line"><span class="comment">// whatever.someAttribute</span></span><br><span class="line"><span class="comment">// &gt; 'youwant'</span></span><br></pre></td></tr></table></figure><p>那么现在我们需要做的就是，把每一个文件都当作一个 IIFE（揭示模块）调用。</p><p>现在我们可以利用 Make, Grunt, Gulp, Broccoli, Brunch, StealJS 等 “安全” 的组合文件，而不用担心作用域冲突。但是，这样就完美了吗？</p><p>这样大量的使用 IIFE，也带来了很多 <strong>问题</strong> ：</p><ol type="1"><li><p>每一次文件改变都需要所有 IIFE 全部执行一遍。</p></li><li><p>DEAD CODE: 连接文件并没有助于我们跨文件使用代码。利用使用 lodash.js 等库，需全部加载。</p></li><li><p>大量使用 IIFE，调用会非常慢。</p></li><li><p>只能同步加载，没有异步加载，无法实现 <code>lazy code</code>。</p></li></ol><h2 id="模块的历史">模块的历史</h2><p>伴随着 <code>Node.js</code> 诞生的 <code>CommonJs ( Module 1.0 )</code>。采用静态语法分析，使用 <code>NPM + Node + Modules</code> 的生态。</p><p><code>Node.js</code> 的 <code>CommonJs</code> 存在的问题:</p><ol type="1"><li><p>不支持浏览器</p></li><li><p>没有活动绑定，存在循环引用的问题。</p></li><li><p>模块同步解析加载，会很慢。</p></li></ol><h3 id="不支持浏览器的解决方法">不支持浏览器的解决方法</h3><ul><li>使用类似 Browserify (static) 工具。</li><li>使用 RequireJS (loader)。</li><li>使用 SystemJS (loader)。</li></ul><h3 id="模块同步解析加载的难题">模块同步解析加载的难题</h3><p><code>CommonJS</code> 模块方式不支持静态异步/延迟加载，所有模块都绑定在文件顶部。</p><p>在浏览器中，我们则需要动态的 <code>CommonJS</code> 。</p><p>浏览器中，可以使用 <code>AMD</code> 模块， 或者还有 <code>AMD + CommonJS</code> 方式。不过这些方式对于需要延迟加载的模块来讲还是太同步了。而且，这么多种上传方式，没有一种标准的语法，没有一个真正的模块系统。</p><h2 id="esmecmascriptmodule模块">ESM（EcmaScriptModule）模块</h2><p>ESM 的出现解决了 CommonJS 的不支持静态异步和延迟加载功能。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; uniq, forOf, bar &#125; <span class="keyword">from</span> <span class="string">'lodash-es'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> utils <span class="keyword">from</span> <span class="string">'utils'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> uniqConst = uniq([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br></pre></td></tr></table></figure><p>现在我们直接看下 ESM 的优点：</p><ol type="1"><li><p>可重复使用。</p></li><li><p>良好的封装性。</p></li><li><p>易于组织。</p></li><li><p>便于使用。</p></li></ol><p>当然 ESM 也有缺点：</p><ol type="1"><li><p>ESM 在 Node 的模块中，使用的很少。</p></li><li><p>ESM 可以直接在浏览器中使用，但非常非常非常慢。（因为经常容易出一些错，使代码崩溃）。</p></li></ol><p>除此之外，还有一些问题，每一个库的作者都有自己喜欢的模块加载方式，代码也是不同的。目前为止我们讨论的都是 <strong>JavaScript</strong> 。到目前为止，每种文件类型都必须有处理它的特定方法。所以接下来就要介绍 Webpack 了。</p><h2 id="介绍-webpack">介绍 Webpack</h2><p>Webpack 是模块打包器，可以让你编写任意的模块格式，甚至混合的格式，通过 Webpack 打包，使浏览器能够读取他们。</p><p>Webpack 支持 <strong>静态异步打包</strong> ，而且它具有丰富的生态系统，可以说是今天发布 JavaScript 的最佳方式了。</p><p>Webpack 诞生于 <a href="https://github.com/medikoo/modules-webmake">modules-webmake</a>, 为了给 modules-webmake 添加 Code splitting ，诞生了 Webpack。</p><h2 id="配置-webpack">配置 Webpack</h2><p>所以如何配置 Webpack 呢？</p><ol type="1"><li>使用 config ，如 webpack.config.js ，配置文件本身就是一个模块。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    vendor: <span class="string">'./src/vendors.ts'</span>,</span><br><span class="line">    main: <span class="string">'./src/main.browser.ts'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: <span class="string">'dist/'</span>,</span><br><span class="line">    filename: <span class="string">'[name].bundle.js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="2" type="1"><li>使用 Webpack-Cli 。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ webpack &lt;entry.js&gt; &lt;result.js&gt; --colors --progress</span><br><span class="line"></span><br><span class="line">$ webpack-dev-server --port=9000</span><br></pre></td></tr></table></figure><ol start="3" type="1"><li>Node Api。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns a Compiler instance</span></span><br><span class="line">webpack(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// configuration object here!</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// …</span></span><br><span class="line">    <span class="comment">// compilerCallback</span></span><br><span class="line">    <span class="built_in">console</span>.error(err);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="引用">引用</h2><ul><li><a href="https://docs.google.com/presentation/d/1hFtMCMo62DgOIc-9OwgaVwPZHwv1cgMELArHcMbXlSI/edit#slide=id.g15e96ef847_0_0">slides</a></li><li><a href="https://frontendmasters.com/courses/Webpack-fundamentals/">Webpack 4 Fundamentals <strong>video</strong></a></li><li><a href="https://github.com/TheLarkInn/webpack-workshop-2018">webpack-workshop-2018</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这是半个月前在 FrontendMasters 看的 &lt;code&gt;Webpack&lt;/code&gt; 视频，过了半个月，做一下总结以及回顾。这篇时第一部分，Webpack 基础。&lt;/p&gt;
    
    </summary>
    
      <category term="Webpack" scheme="https://hddhyq.github.io/categories/Webpack/"/>
    
    
      <category term="Webpack" scheme="https://hddhyq.github.io/tags/Webpack/"/>
    
      <category term="foundation" scheme="https://hddhyq.github.io/tags/foundation/"/>
    
  </entry>
  
  <entry>
    <title>CircleCI实践gh-pages部署</title>
    <link href="https://hddhyq.github.io/2019/01/31/CircleCI%E5%AE%9E%E8%B7%B5gh-pages%E9%83%A8%E7%BD%B2/"/>
    <id>https://hddhyq.github.io/2019/01/31/CircleCI实践gh-pages部署/</id>
    <published>2019-01-31T14:22:35.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>这里展示一下CircleCI集成与github之间联系。 <a id="more"></a></p><p>当你在Circle中添加一个项目时。相关的 GitHub 设置中将会使用您在注册时为CircleCI提供的权限。</p><ul><li><code>deloy key</code> 用来从 GitHub 中查看项目源代码。</li><li><code>service hook</code> 用来通知 CircleCI ，当你向 GitHub 中提交代码。</li></ul><p>常见 push hooks：</p><p>另外 两个钩子： * 提供PR hooks，用来储存 PR 请求。 * 如果PR钩子在forked的项目中，CircleCI将会在PRs在分支仓库创建时提交。</p><p>详见 <a href="https://circleci.com/docs/2.0/workflows/#using-contexts-and-filtering-in-your-workflows">workflows filters</a></p><p>CircleCI在每次测试都会清理容器。你的 github 的仪表盘中也会有显示。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/status_check.png" /></p><h1 id="使你circleci的项目能够检出私有仓库">使你CircleCI的项目能够检出私有仓库</h1><p>如果你的测试过程涉及多个存储库，除了部署密钥之外，CircleCI还需要GitHub用户密钥，因为每个部署密钥仅对一个储存库有效，而GitHub用户莫要可以访问所有GitHub储存库。查看<a href="https://circleci.com/docs/2.0/add-ssh-key">adding ssh keys</a>章节来查看更多。</p><p>在 <strong>Project Settings &gt; Checkout SSH keys</strong> 页面提供给 CircleCI GitHub用户私钥。CircleCI创建和关联新的SSH密钥来访问你的所有的仓库。</p><h2 id="用户密钥安全">用户密钥安全</h2><p>CircleCI 绝对不会公开你的SSH密钥。</p><p>请记住，SSH密钥只能分享给信任的用户，所有的 GitHub 合作者拥有了SSH密钥都可以访问你的仓库。所以要确保你的SSH密钥的安全。</p><h2 id="用户密钥访问相关错误信息">用户密钥访问相关错误信息</h2><p>下面的错误表明你需要添加用户密钥</p><p><strong>Python</strong>: 在 <code>pip install</code>步骤期间</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR: Repository not found.</span><br></pre></td></tr></table></figure><p><strong>Ruby</strong>: 在<code>bundle install</code>步骤期间</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Permission denied (publickey).</span><br></pre></td></tr></table></figure><h1 id="创建机器用户">创建机器用户</h1><p>要对多个存储库进行细粒度访问，请考虑为CircleCI项目创建机器用户。一个机器用户是你为运行自动化任务而创建的GitHub用户。通过使用机器用户的SSH密钥，你可以允许任何人对仓库进行，构造，测试和部署项目。创建机器用户还可以降低丢失与单个用户关联的凭据的风险。</p><p>要为机器用户使用SSH密钥，请遵循下列步骤：</p><p><strong>注意</strong>: 要执行下列步骤，机器用户必须拥有管理员权限。完成项目添加后，可以将机器用户权限设为只读。</p><ol type="1"><li>根据<a href="https://developer.github.com/v3/guides/managing-deploy-keys/#machine-users">instructions on GitHub</a>，创建机器用户权限。</li><li>作为机器用户登陆Github。</li><li><a href="https://circleci.com/login">登陆CircleCI</a>。当GitHub提醒你需要授权给CircleCI的时候，点击 <strong>Authorize application</strong> 按钮。</li><li>在<a href="https://circleci.com/add-projects">添加项目</a>, follow你希望使用机器用户访问的项目。</li><li>在 <strong>Project Settings &gt; Checkout SSH keys</strong>页面，点击 <strong>Authorize With GitHub</strong> 按钮。这将给CircleCI权限作为机器用户去创造和上传SSH密钥。</li><li>点击 <strong>Create and add XXXX user Key</strong> 按钮。</li></ol><p>现在Circle将使用机器用户的SSH密钥来使用Git命令行运行你的构建。</p><h1 id="权限概述">权限概述</h1><p>CircleCI要求你的版本控制系统（VCS）提供以下权限，<a href="http://developer.github.com/v3/oauth/#scopes">GitHub permissions model</a></p><h2 id="读权限">读权限</h2><ul><li>获取用户的邮件地址</li></ul><h2 id="写权限">写权限</h2><ul><li>给仓库添加部署密钥</li><li>给仓库添加服务器钩子</li><li>获取用户所有仓库的列表</li><li>给用户账户添加SSH密钥</li></ul><p><strong>注意</strong>: CircleCI只有在必须的时候才会请求权限。但是，CircleCI受到VCS提供的权限约束。举例，从GitHub获取所有用户仓库，需要写权限，因为GitHub没有提供只读权限。</p><p>如果你强烈的希望减少CircleCI的使用，考虑向你的VCS供应商联系。</p><h2 id="团队账户权限">团队账户权限</h2><p>本节概述了可用于满足各种业务需求的团队和个人帐户选择：</p><ol type="1"><li><p>如果单个用户拥有个人GitHub账户，他会使用它登录CircleCI然后在CircleCI里follow任务。GitHub中该存储库上的每个“协作者”也能够跟踪项目并在推送提交时构建在CircleCI上。由于GitHub储存协作者的方式，CircleCI不会显示完整的列表。有关合作者的完整列表需要参阅GitHub。</p></li><li><p>如果一个个人用户升级到团队用户，他们将被允许添加用户，甚至给那些运行构建任务的合作者管理者权限。团队用户的拥有者必须到CircleCI的<a href="https://circleci.com/add-projects">Add Project</a>，点击链接到GitHub应用权限界面，选择授权CircleCI来使组织的成员通过他们的账户follow项目。拥有两名成员的团队帐户每月25美元，而不是个人帐户每月7美元。</p></li><li><p>对于最多五人的团队，个人Bitbucket账户可免费用于私人回购。个人可以创建Bitbucket团队，添加成员并根据需要为需要构建的人员提供管理员权限。该项目将出现在CircleCI中，供会员遵循，无需额外费用。</p></li></ol><h2 id="如何为github组织重新启用circleci">如何为GitHub组织重新启用CircleCI</h2><p>这一章节描述了如何在GitHub组织启用了第三方应用程序限制后重新启用CircleCi。参见[GitHub Seeting]。</p><ul><li>"申请进入"，如果你不是组织的管理者会有这种问题。管理者应该批准访问。</li><li>"授予访问权限"如果你是管理者应该给予。</li></ul><p>获取访问权限后，CircleCi的行为将会正常。</p><p>GitHub最近添加了在每个组织级别<a href="third%20party%20application%20access%20on%20a%20per-organization%20level">准第三方程序访问权限</a>。再此之前，组织的成员都能授权给应用（生成 OAhth token 关联他们的GitHub用户账户），而且应用可以使用 OAuth token 来代表用户行事，可以使用OAuth flow中的任何权限。</p><p>现在的当第三方组织限制打开的时候，OAuth token默认情况下没有办法访问第三方数据。不管是OAuth进程之前或者之后，你必须准备为组织申请权限，然后组织管理者需要批准权限。</p><p>你也可以在GitHub的组织设置界面打开第三方访问权限。并单击“第三方应用程序访问策略”部分中的“设置应用程序访问限制”按钮。</p><p>如果您对已运行CircleCI的组织启用这些限制，那么我们将停止从GitHub接收推送事件挂钩（因此不会构建新的推送）。而且API调用将被拒绝（例如，导致重新构建旧版本以使源检出失败。）要使CircleCI再次运行，您必须授予对CircleCI应用程序的访问权限。</p><h1 id="部署密钥和用户密钥">部署密钥和用户密钥</h1><h2 id="什么是部署密钥">什么是部署密钥？</h2><p>当你创建新项目的时候，CircleCi将会为你的项目在基于网络的分布式系统上（例如GitHub和Bitbucket）创建密钥。部署密钥是仓库专属的密钥。如果你使用GitHub作为你的分布式系统，而且GitHub有用公钥，CircleCi将会储存私有秘钥。部署密钥给CircleCi访问单个仓库的权限。为了保护CircleCi不能推送内容到你的仓库，部署密钥是只读的。</p><p>如果你想要在构建中push内容到你的仓库，你需要一个拥有读写取新鲜的部署密钥，即用户密钥。下面几步展示了为你的VCS创建用户密钥。</p><h2 id="什么是用户密钥">什么是用户密钥？</h2><p>一个用户密钥是用户专属的SSH密钥。你的VCS拥有公钥，CircleCi存储私钥。拥有私钥能够给予你模仿用户的能力，像使用<code>git</code>访问项目。</p><h2 id="创建github用户密钥">创建GitHub用户密钥</h2><p>在下面的例子中，GitHub仓库是<code>https://github.com/you/test-repo</code>，你的CircleCi项目是<a href="https://circleci.com/gh/you/test-repo">https://circleci.com/gh/you/test-repo</a>。</p><ol type="1"><li>根据<a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/">GitHub instructions</a>创建SSH密钥。当提示输入密码的时候，一定不要输入密码。</li></ol><p><strong>警告</strong>：默认情况下，ssh-keygen中的最新更新不会以PEM格式生成密钥。如果你的密钥不是以<code>-----BEGIN RSA PRIVATE KEY-----</code>开始，通过使用<code>ssh-keygen -m PEM -t rsa -C "your_email@example.com"</code>来强制生成密钥。</p><ol type="1"><li><p>到<code>https://github.com/you/test-repo/settings/keys</code>，点击"Add deploy key"。在 Title 输入框写下标题，复制粘贴你在第一步创建的密钥，点击"Allow write access"，然后点击"Add key"。</p></li><li><p>到 <a href="https://circleci.com/gh/you/test-repo/edit#ssh">https://circleci.com/gh/you/test-repo/edit#ssh</a>，添加在上面创建的密钥到"Hostname"输入框，输入"github.com"，添加提交按钮</p></li><li><p>在你的 config.yml ，添加指纹到<code>add_ssh_keys</code>。</p></li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy-job:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_ssh_keys:</span></span><br><span class="line">          <span class="attr">fingerprints:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"SO:ME:FIN:G:ER:PR:IN:T"</span></span><br></pre></td></tr></table></figure><h2 id="这些键是怎么用的">这些键是怎么用的？</h2><p>当CircleCi构建你的项目的时候，私有秘钥会被创建到<code>.ssh</code>目录，随后将SSH配置为与您的版本控制提供程序进行通信。此后，私有秘钥会给用户提供下列权限：</p><ul><li>检查主要项目。</li><li>检查任何 GitHub 托管的子项目。</li><li>检查任何 GitHub 托管的私有依赖项。</li><li>自动化 git 的合并和打标签等操作。</li></ul><p>由于上述的原因，部署建对于需要添加私有依赖项的项目功能不够强大。</p><h2 id="关于安全因素">关于安全因素？</h2><p>私钥对于CircleCi生成的密钥绝对不会离开CircleCi系统，只有公钥会被传输给GitHub。私钥会被安全加密的存储。然而，当你将私钥用于你构建的容器，你的CircleCi的任何代码都可以读到他们。</p><h2 id="部署密钥和用户密钥的区别">部署密钥和用户密钥的区别？</h2><p>部署密钥和用户密钥是GitHub唯一支持的密钥类型。部署密钥是全局唯一的，举例来说，没有机制能使部署密钥访问多个仓库。而用户密钥没有分割区域，用户可以访问所有与之相关的仓库。</p><p>为了实现访问多个不同的仓库，应该考录常见一个GitHub的机器用户。给这个用户你构建项目所需要的权限，然后再CircleCi上关联用户密钥到你的项目。</p><h1 id="关于github机器用户">关于GitHub机器用户</h1><p>如果你的服务需要访问多个仓库，你可以创建一个新的GitHub账户，然后连接的SSH密钥，仅仅用以项目的自动化。这样的Github账户不会被用户使用，这样的Github账户被称作机器账户。你可以添加一个机器用户作为个人账户的合作者（授予读写权限），或者作为公共仓库的外有合作者（授予读写或者管理者权限），或者作为需要自动化的团队仓库。</p><blockquote><p>GitHub服务条框是: 不允许机器或者自动化注册账户. 这表示你不能自动创建账户.但是如果你只是创建一个私有用户来为你的项目或者组织运行自动化脚本,这么做是推荐的.</p></blockquote><h2 id="pros">Pros</h2><ul><li>任何有权访问仓库或者服务的人都有能力部署项目.</li><li>真实用户,或者说是人类用户,不需要改变他们的本地SSH密钥.</li><li>多个密钥是不需要的,一个服务就够了.</li></ul><h2 id="cons">Cons</h2><ul><li>只有组织能够限制机器用户值有读写权限.个人仓库总是授予合作者读写权限.</li><li>机器用户密钥和部署密钥一样,不受密码保护.</li></ul><h2 id="创建">创建</h2><ol type="1"><li><a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/#generating-a-new-ssh-key">运行ssh-keygen过程</a>在你的服务器上,然后通过机器用户连接公钥.</li><li>给及其用户你想自动化的仓库.你可以通过添加账户作为合作者,作为一个外界合作者,或者组织的一个团队.</li></ol><h1 id="gh-pages实践步骤">gh-pages实践步骤</h1><h2 id="创建机器用户-1">1. 创建机器用户</h2><p>经过上面的介绍，基本上应该知道。<code>push</code> dist 目录到相应的分支，这里需要用到<code>push</code>的权限。我们必不可少的就是需要一个用户密钥。使用用户密钥的方法就是利用新创建一个git用户，下面我创建了一个<code>hddMachine</code>的用户。然后原仓库的管理者将机器用户添加到合作者中，然后在CircleCI中生成对应的<code>fingerprints</code>，并添加到下面的yml文件。这样当我们每次<code>push</code>的时候就会调用机器用户权限来使用 git 命令。</p><h2 id="git">git</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">working_directory:</span> <span class="string">~/repo</span> <span class="comment"># directory where steps will run</span></span><br><span class="line">    <span class="attr">docker:</span> <span class="comment"># use the docker executor type; machine and macos executors are also supported</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/node:8.10</span> <span class="comment"># the primary container, where your job's commands are run</span></span><br><span class="line">    <span class="attr">filters:</span></span><br><span class="line">      <span class="attr">branches:</span></span><br><span class="line">        <span class="attr">only:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_ssh_keys:</span></span><br><span class="line">          <span class="attr">fingerprints:</span> <span class="string">'41:f1:b3:2d:89:ff:f0:16:a4:eb:49:92:39:27:95:04'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">checkout</span> <span class="comment"># check out the code in the project directory</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">update-npm</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">'sudo npm install -g npm@latest'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">restore_cache:</span> <span class="comment"># special step to restore the dependency cache</span></span><br><span class="line">          <span class="comment"># Read about caching dependencies: https://circleci.com/docs/2.0/caching/</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">dependency-cache-&#123;&#123;</span> <span class="string">checksum</span> <span class="string">"package.json"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">install-npm</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">save_cache:</span> <span class="comment"># special step to save the dependency cache</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">dependency-cache-&#123;&#123;</span> <span class="string">checksum</span> <span class="string">"package.json"</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./node_modules</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="comment"># run build</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">build</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="comment"># git push</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">push-github</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">"975018306@qq.com"</span></span><br><span class="line">            <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">"hddMachine"</span></span><br><span class="line">            <span class="string">git</span> <span class="string">add</span> <span class="string">-f</span> <span class="string">dist</span></span><br><span class="line">            <span class="string">git</span> <span class="string">commit</span> <span class="string">-m</span> <span class="string">'create dist'</span></span><br><span class="line">            <span class="string">git</span> <span class="string">push</span> <span class="string">origin</span> <span class="string">`git</span> <span class="string">subtree</span> <span class="string">split</span> <span class="string">--prefix</span> <span class="string">dist</span> <span class="string">master`:gh-pages</span> <span class="string">--force</span></span><br></pre></td></tr></table></figure><h1 id="参考">参考</h1><ul><li>https://circleci.com/docs/2.0/configuration-reference/#add_ssh_keys</li><li>https://circleci.com/docs/2.0/language-javascript/</li><li>https://github.com/CircleCI-Public/circleci-demo-javascript-express/blob/master/.circleci/config.yml</li><li><a href="https://stackoverflow.com/questions/13756055/git-subtree-subtree-up-to-date-but-cant-push">git-subtree-cant-push</a></li><li><a href="https://circleci.com/docs/2.0/gh-bb-integration/?tdsourcetag=s_pctim_aiomsg">GitHub和Bitbucket使用CircleCI</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这里展示一下CircleCI集成与github之间联系。
    
    </summary>
    
      <category term="CircleCI" scheme="https://hddhyq.github.io/categories/CircleCI/"/>
    
    
      <category term="自动化" scheme="https://hddhyq.github.io/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    
      <category term="git" scheme="https://hddhyq.github.io/tags/git/"/>
    
      <category term="GitHub" scheme="https://hddhyq.github.io/tags/GitHub/"/>
    
      <category term="CircleCI" scheme="https://hddhyq.github.io/tags/CircleCI/"/>
    
  </entry>
  
  <entry>
    <title>CircleCI简单概念</title>
    <link href="https://hddhyq.github.io/2019/01/25/CircleCI%E7%AE%80%E5%8D%95%E6%A6%82%E5%BF%B5/"/>
    <id>https://hddhyq.github.io/2019/01/25/CircleCI简单概念/</id>
    <published>2019-01-25T13:05:10.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>又是关于前两个星期零零星星看的文章的总结，主要关于 CircleCI 。首先是CircleCI的介绍，然后下一篇文字介绍下部署一个vue项目到gh-pages的步骤。 <a id="more"></a></p><h1 id="概念">概念</h1><p><a href="https://circleci.com/docs/2.0/hello-world/">导航</a>,<a href="https://circleci.com/docs/2.0/concepts/">概念</a> ## 步骤（Steps）</p><p>步骤一般是可执行的命令组成的。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#...</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">checkout</span> <span class="comment"># Special step to checkout your source code</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="comment"># Run step to execute commands, see</span></span><br><span class="line">      <span class="comment"># circleci.com/docs/2.0/configuration-reference/#run</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Running</span> <span class="string">tests</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">make</span> <span class="string">test</span> <span class="comment"># executable command run in</span></span><br><span class="line">          <span class="comment"># non-login shell with /bin/bash -eo pipefail option</span></span><br><span class="line">          <span class="comment"># by default.</span></span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure><h2 id="镜像image">镜像（Image）</h2><p>指定确定的docker容器。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">version</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build1:</span> <span class="comment"># job name</span></span><br><span class="line">    <span class="attr">docker:</span> <span class="comment"># Specifies the primary container image,</span></span><br><span class="line">    <span class="comment"># see circleci.com/docs/2.0/circleci-images/ for</span></span><br><span class="line">    <span class="comment"># the list of pre-built CircleCI images on dockerhub.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">buildpack-deps:trusty</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">postgres:9.4.1</span> <span class="comment"># Specifies the database image</span></span><br><span class="line">      <span class="comment"># for the secondary or service container run in a common</span></span><br><span class="line">      <span class="comment"># network where ports exposed on the primary container are</span></span><br><span class="line">      <span class="comment"># available on localhost.</span></span><br><span class="line">        <span class="attr">environment:</span> <span class="comment"># Specifies the POSTGRES_USER authentication</span></span><br><span class="line">        <span class="comment"># environment variable, see circleci.com/docs/2.0/env-vars/</span></span><br><span class="line">        <span class="comment"># for instructions about using environment variables.</span></span><br><span class="line">          <span class="attr">POSTGRES_USER:</span> <span class="string">root</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">build2:</span></span><br><span class="line">    <span class="attr">machine:</span> <span class="comment"># Specifies a machine image that uses</span></span><br><span class="line">    <span class="comment"># an Ubuntu version 14.04 image with Docker 17.06.1-ce</span></span><br><span class="line">    <span class="comment"># and docker-compose 1.14.0, follow CircleCI Discuss Announcements</span></span><br><span class="line">    <span class="comment"># for new image releases.</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">circleci/classic:201708-01</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">build3:</span></span><br><span class="line">    <span class="attr">macos:</span> <span class="comment"># Specifies a macOS virtual machine with Xcode version 9.0</span></span><br><span class="line">      <span class="attr">xcode:</span> <span class="string">"9.0"</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><h2 id="任务jobs">任务（Jobs）</h2><p>任务是步骤的集合，单个任务必须指定<code>docker</code>，<code>machine</code>和<code>macos</code>。</p><h3 id="缓存">缓存</h3><p>可以缓存诸如项目中源代码的依赖的文件或者目录。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build1:</span></span><br><span class="line">    <span class="attr">docker:</span> <span class="comment"># Each job requires specifying an executor</span></span><br><span class="line">    <span class="comment"># (either docker, macos, or machine), see</span></span><br><span class="line">    <span class="comment"># circleci.com/docs/2.0/executor-types/ for a comparison</span></span><br><span class="line">    <span class="comment"># and more examples.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/ruby:2.4-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/postgres:9.4.12-alpine</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">checkout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">save_cache:</span> <span class="comment"># Caches dependencies with a cache key</span></span><br><span class="line">      <span class="comment"># template for an environment variable,</span></span><br><span class="line">      <span class="comment"># see circleci.com/docs/2.0/caching/</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">v1-repo-&#123;&#123;</span> <span class="string">.Environment.CIRCLE_SHA1</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">~/circleci-demo-workflows</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build2:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/ruby:2.4-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/postgres:9.4.12-alpine</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">restore_cache:</span> <span class="comment"># Restores the cached dependency.</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">v1-repo-&#123;&#123;</span> <span class="string">.Environment.CIRCLE_SHA1</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="工作流">工作流</h2><p>工作流定义了一系列的任务和他们的运行顺序。它可以使任务并行，穿行和按计划或者手动控制运行。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build1:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/ruby:2.4-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/postgres:9.4.12-alpine</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">checkout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">save_cache:</span> <span class="comment"># Caches dependencies with a cache key</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">v1-repo-&#123;&#123;</span> <span class="string">.Environment.CIRCLE_SHA1</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">~/circleci-demo-workflows</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build2:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/ruby:2.4-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/postgres:9.4.12-alpine</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">restore_cache:</span> <span class="comment"># Restores the cached dependency.</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">v1-repo-&#123;&#123;</span> <span class="string">.Environment.CIRCLE_SHA1</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Running</span> <span class="string">tests</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">make</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">build3:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/ruby:2.4-node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">circleci/postgres:9.4.12-alpine</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">restore_cache:</span> <span class="comment"># Restores the cached dependency.</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">v1-repo-&#123;&#123;</span> <span class="string">.Environment.CIRCLE_SHA1</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Precompile</span> <span class="string">assets</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">rake</span> <span class="string">assets:precompile</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">build_and_test:</span> <span class="comment"># name of your workflow</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">build1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">build2:</span></span><br><span class="line">        <span class="attr">requires:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">build1</span> <span class="comment"># wait for build1 job to complete successfully before starting</span></span><br><span class="line">          <span class="comment"># see circleci.com/docs/2.0/workflows/ for more examples.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">build3:</span></span><br><span class="line">        <span class="attr">requires:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">build1</span> <span class="comment"># wait for build1 job to complete successfully before starting</span></span><br><span class="line">          <span class="comment"># run build2 and build3 in parallel to save time.</span></span><br></pre></td></tr></table></figure><h3 id="工作区域和文件">工作区域和文件</h3><p>Artifacts， Workspaces，Caches的讨论看 <a href="https://circleci.com/blog/persisting-data-in-workflows-when-to-use-caching-artifacts-and-workspaces/">Persisting Data in Workflows: When to Use Caching, Artifacts, and Workspaces</a></p><p>也可以看看 <a href="https://circleci.com/docs/2.0/jobs-steps/">Jobs and Steps</a>来查看更多。</p><h1 id="工作流-1"><a href="https://circleci.com/docs/2.0/workflows">工作流</a></h1><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/wf-header.png" /></p><p>要通过更快的反馈，更短的重运行时间和更有效的资源使用来提高软件开发的速度，请配置工作流程。这个文档描述了工作流程的特性而且提供以下章节的用例：</p><ul><li>概述</li><li>工作流配置案例</li><li>手动控制持久工作流</li><li>有序化一个工作流程</li><li>使用上下文来过滤你的工作流程</li><li>使用工作区来在任务重分享数据</li><li>重运行失败的任务</li><li>故障排除</li></ul><h2 id="概述">概述</h2><p>你能做的有：</p><ul><li>通过实时状态反馈来运行和解决任务中的问题</li><li>将需要定期执行的工作流按计划执行</li><li>通过多个并行任务来进行有效的版本测试</li><li>快速部署到多个不同的平台</li></ul><h3 id="平行任务">平行任务</h3><p>在底部添加<code>workflows</code>，通过build_and_test 可看<a href="https://github.com/CircleCI-Public/circleci-demo-workflows/blob/parallel-jobs/.circleci/config.yml">Sample Parallel Workflow config</a></p><h3 id="顺序任务">顺序任务</h3><p>需要添加<code>require</code>关键字。 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">build-test-and-deploy:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test1:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test2:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">deploy:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test2</span></span><br></pre></td></tr></table></figure></p><h3 id="扇出扇入工作流示例">扇出/扇入工作流示例</h3><p>下面视图扇出一组工作流，然后扇入来运行公共的部署任务： <a href="https://github.com/CircleCI-Public/circleci-demo-workflows/tree/fan-in-fan-out">Sample Fan-in/Fan-out Workflow config</a></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">build_accept_deploy:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">acceptance_test_1:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">acceptance_test_2:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">acceptance_test_3:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">acceptance_test_4:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">deploy:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">acceptance_test_1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">acceptance_test_2</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">acceptance_test_3</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">acceptance_test_4</span></span><br></pre></td></tr></table></figure><h3 id="通过手动批准来控制工作流">通过手动批准来控制工作流</h3><p>工作流可以设置为需要手动批准再进行下一个任务。任何有权利访问代码库的人都可以继续工作流。为了做到这一点，在任务列表中添加<code>type: approval</code>。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">build-test-and-approval-deploy:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">build</span>  <span class="comment"># your custom job from your config, that builds your code</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test1:</span> <span class="comment"># your custom job; runs test suite 1</span></span><br><span class="line">          <span class="attr">requires:</span> <span class="comment"># test1 will not run until the `build` job is completed.</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test2:</span> <span class="comment"># another custom job; runs test suite 2,</span></span><br><span class="line">          <span class="attr">requires:</span> <span class="comment"># test2 is dependent on the succes of job `test1`</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hold:</span> <span class="comment"># &lt;&lt;&lt; A job that will require manual approval in the CircleCI web application.</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">approval</span> <span class="comment"># &lt;&lt;&lt; This key-value pair will set your workflow to a status of "On Hold"</span></span><br><span class="line">          <span class="attr">requires:</span> <span class="comment"># We only run the "hold" job when test2 has succeeded</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test2</span></span><br><span class="line">      <span class="comment"># On approval of the `hold` job, any successive job that requires the `hold` job will run.</span></span><br><span class="line">      <span class="comment"># In this case, a user is manually triggering the deploy job.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">deploy:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">hold</span></span><br></pre></td></tr></table></figure><p>上例中举例，就是在最后需要手动批准hold才能进行部署任务。</p><p>下面也有一些我们在工作流中需要注意的地方： * <code>approval</code>是仅在<code>workflow</code>下job的一个特殊类型。 * <code>hold</code>任务必须确保不再其他任务中重名。 * 这代表着，你的个人定制任务，像<code>build</code>或者<code>test1</code>在上例中不能给<code>type: approval</code>键 * 任务的名字随意。 * 在手动任务之后的任务都需要添加<code>require:</code>来依赖这个手动任务。 * 任务按顺序执行，直到碰到了<code>type: approval</code>。</p><p>下面展示一下截图 <img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/approval_job.png" /></p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/approval_job_dialog.png" /></p><h2 id="安排工作流程">安排工作流程</h2><p>手动书写每个分支的任务和流程十分的低效和耗时，所以我们能够在确定不同分支的运行时间。</p><h3 id="在夜晚执行的任务">在夜晚执行的任务</h3><p>默认工作流的触发依赖于每次<code>git push</code>，为了按照计划执行工作流，我们可以添加<code>triggers</code>键来特殊化工作调度。</p><p>下面的例子中，我们将运行一个旨在夜晚12点后运行的工作流。使用POSIX <code>crontab</code>语法指定<code>cron</code>键。<a href="https://www.unix.com/man-page/POSIX/1posix/crontab/">crontab man page</a>来查看基本语法。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">commit:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">nightly:</span></span><br><span class="line">    <span class="attr">triggers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">schedule:</span></span><br><span class="line">          <span class="attr">cron:</span> <span class="string">"0 0 * * *"</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">only:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">beta</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">coverage</span></span><br></pre></td></tr></table></figure><h3 id="制定有效的计划">制定有效的计划</h3><p>一个有效的计划，需要<code>cron</code>键和<code>filter</code>键。<code>cron</code>的键值必须是一个有效的<code>vaild crontab entry</code>键。</p><h3 id="使用任务上下文来分享环境变量">使用任务上下文来分享环境变量</h3><p>下面的例子展示了如何使用上下文来在一个工作流的四个平行任务中分享环境变量。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">build-test-and-deploy:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test1:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">          <span class="attr">context:</span> <span class="string">org-global</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test2:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test1</span></span><br><span class="line">          <span class="attr">context:</span> <span class="string">org-global</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">deploy:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test2</span></span><br></pre></td></tr></table></figure><h2 id="分支级别的任务执行">分支级别的任务执行</h2><p>下面的例子会展示，如何在三个分支配置任务流。工作流会在忽略在任务底下的分支键，如果想在工作流中添加任务级别的分支，需要移除任务级别的分支，转而描述它。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/branch_level.png" /></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">dev_stage_pre-prod:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test_dev:</span></span><br><span class="line">          <span class="attr">filters:</span>  <span class="comment"># using regex filters requires the entire branch to match</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">only:</span>  <span class="comment"># only branches matching the below regex filters will run</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">dev</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">/user-.*/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test_stage:</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">stage</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test_pre-prod:</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">/pre-prod(?:-.+)?$/</span></span><br></pre></td></tr></table></figure><h2 id="执行git-tag的工作流">执行Git Tag的工作流</h2><p>circleci并不会主动执行 git tags 分支，除非你定义特定的tags过滤器。如果一个任务直接间接的需要另外一个任务，你必须指定正则表达式来制定任务的tag filter。轻量级和注释的tag都被支持。</p><p>下面的例子展示了两种tag分支方式： 1. <code>untagged-build</code>为所有分支运行<code>build</code>任务。 2. <code>tagged-build</code>为所有分支和带<code>v</code>的标签运行<code>build</code>。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">untagged-build:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tagged-build:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">build:</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">tags:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">/^v.*/</span></span><br></pre></td></tr></table></figure><p>下面展示的三个例子就是workflow的步骤 * build跑所有分支和有<code>config-test</code>名称的tags。 * test跑所有分支和有<code>config-test</code>名称的tags。 * deploy不跑分支只跑有<code>config-test</code>的任务。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">build-test-deploy:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">build:</span></span><br><span class="line">          <span class="attr">filters:</span>  <span class="comment"># required since `test` has tag filters AND requires `build`</span></span><br><span class="line">            <span class="attr">tags:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">/^config-test.*/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">test:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">          <span class="attr">filters:</span>  <span class="comment"># required since `deploy` has tag filters AND requires `test`</span></span><br><span class="line">            <span class="attr">tags:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">/^config-test.*/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">deploy:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="attr">tags:</span></span><br><span class="line">              <span class="attr">only:</span> <span class="string">/^config-test.*/</span></span><br><span class="line">            <span class="attr">branches:</span></span><br><span class="line">              <span class="attr">ignore:</span> <span class="string">/.*/</span></span><br></pre></td></tr></table></figure><p>需要注意的是，GitHub的分支单词只能承受5MB和少于三个标签。意味着，如果你一次添加多个标签，那么CircleCi也许不会接受他们全部。</p><h2 id="使用工作区来在任务中分享数据">使用工作区来在任务中分享数据</h2><p>每个工作流都有一个相关的工作区，能够将文件转换为下游任务的工作流流程。工作区仅用来添加数据的储存。任务可以在工作区中持久化数据。此配置归档数据并在容器外存储中创建新层。下游文件可以通过文件系统的容器访问工作区。附加工作区会根据工作流程中上游作业的顺序下载并解压缩每个层。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/Diagram-v3-Workspaces.png" /></p><p>使用工作区来传递当前层及下层需要的特殊数据。工作流程的任务运行于多个分支，也许需要将数据分享到工作区中。工作区也可以用于在测试容器中比较数据。</p><p>举个例子，Scala项目一般需要打来的CPU计算来完成build任务。相比之下，Scala测试任务不是CPU密集型的而且可以很好的跨容器并行化。使用一个大的容器来build任务，然后保存编译好的数据到工作区，能够让测试容器中使用到编译好的数据。</p><p>第二个例子就是，一个能编译的项目，使用build好的包，然后保存到工作区。build任务扇出到的分支能够并行的使用打包好的文件。</p><p>为了将一个任务中的数据持久化，并使它能够在其他的任务中使用。我们需要使用<code>persist_to_workspace</code>键。文件和目录中的带有<code>paths</code>的属性使用<code>persist_to_workspace</code>会被上传到工作区中的临时目录中，相对于<code>root</code>键定义的目录。文件和目录在这时上传之后，就可以在相应的子任务中使用。</p><p>配置任务接收存储的数据，需要用到<code>attach_workspace</code>键。下面的例子中的<code>config.yml</code>文件中，定义了下游文件使用了流任务中的两个任务。这里的工作流是顺序的。所以<code>downstream</code>需要等到流文件结束才能开始。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Note that the following stanza uses CircleCI 2.1 to make use of a Reusable Executor</span></span><br><span class="line"><span class="comment"># This allows defining a docker image to reuse across jobs.</span></span><br><span class="line"><span class="comment"># visit https://circleci.com/docs/2.0/reusing-config/#authoring-reusable-executors to learn more.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">executors:</span></span><br><span class="line">  <span class="attr">my-executor:</span></span><br><span class="line">    <span class="attr">docker:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">buildpack-deps:jessie</span></span><br><span class="line">    <span class="attr">working_directory:</span> <span class="string">/tmp</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">flow:</span></span><br><span class="line">    <span class="attr">executor:</span> <span class="string">my-executor</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">workspace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">echo</span> <span class="string">"Hello, world!"</span> <span class="string">&gt;</span> <span class="string">workspace/echo-output</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Persist the specified paths (workspace/echo-output) into the workspace for use in downstream job.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">persist_to_workspace:</span></span><br><span class="line">          <span class="comment"># Must be an absolute path, or relative path from working_directory. This is a directory on the container which is</span></span><br><span class="line">          <span class="comment"># taken to be the root directory of the workspace.</span></span><br><span class="line">          <span class="attr">root:</span> <span class="string">workspace</span></span><br><span class="line">          <span class="comment"># Must be relative path from root</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">echo-output</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">downstream:</span></span><br><span class="line">    <span class="attr">executor:</span> <span class="string">my-executor</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">attach_workspace:</span></span><br><span class="line">          <span class="comment"># Must be absolute path or relative path from working_directory</span></span><br><span class="line">          <span class="attr">at:</span> <span class="string">/tmp/workspace</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">if</span> <span class="string">[[</span> <span class="string">`cat</span> <span class="string">/tmp/workspace/echo-output`</span> <span class="string">==</span> <span class="string">"Hello, world!"</span> <span class="string">]];</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">"It worked!"</span><span class="string">;</span></span><br><span class="line">          <span class="string">else</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">"Nope!"</span><span class="string">;</span> <span class="string">exit</span> <span class="number">1</span></span><br><span class="line">          <span class="string">fi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">workflows:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2.1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">btd:</span></span><br><span class="line">    <span class="attr">jobs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">flow</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downstream:</span></span><br><span class="line">          <span class="attr">requires:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">flow</span></span><br></pre></td></tr></table></figure><p>可通过<a href="https://circleci.com/blog/persisting-data-in-workflows-when-to-use-caching-artifacts-and-workspaces/">Persisting Data in Workflows: When to Use Caching, Artifacts, and Workspaces</a>查看更多的关于使用workspaces, caching, and artifacts。</p><h2 id="重运行失败的任务">重运行失败的任务</h2><p>当你使用工作流的时候，你能增加你快速响应失败任务的能力。为了重运行工作流中失败的任务。你可以在<strong>Workflows</strong>中选择相应的工作流，选择<strong>Rerun</strong>按钮。</p><figure><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/rerun-from-failed.png" alt="" /><figcaption>return</figcaption></figure><h2 id="故障排除">故障排除</h2><p>这个章节讨论一些工作流中常见的问题。</p><h3 id="工作流没有开始">工作流没有开始</h3><p>如果你创建和修改了工作流的配置，如果你没看见新的任务，很有可能是你的配置文件<code>config.yml</code>出现了问题。</p><p>通常情况下，如果你没看见你的工作流正常触发，配置错误阻止了工作流的启动。作为结论，工作流没有启动任何一个任务。</p><p>在设置工作流程时，您当前必须检查CircleCI应用程序的工作流程页面（而不是作业页面）以查看配置错误。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/workflow-config-error.png" /></p><h3 id="工作流等待github的状态">工作流等待GitHub的状态。</h3><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/circleci/github_branches_status.png" /></p><h1 id="配置circleci"><a href="https://circleci.com/docs/2.0/configuration-reference/">配置circleci</a></h1><h1 id="circleci-镜像"><a href="https://circleci.com/docs/2.0/circleci-images/">CircleCI 镜像</a></h1><ul><li>https://hub.docker.com/r/circleci/</li><li>https://github.com/circleci/circleci-images</li><li>https://github.com/circleci-public/circleci-dockerfiles</li></ul><h2 id="最佳实践">最佳实践</h2><p>最好确定好版本号，不适用last版本。Debian系统需要在尾部添加上<code>-jessie</code>和<code>-stretch</code>。</p><h3 id="使用镜像的便签来标注语言和操作系统">使用镜像的便签来标注语言和操作系统</h3><p><code>circleci/golang:1.8.6-jessie</code></p><p><strong>注意:</strong> 如果没有固定标签，Docker将会使用<code>latest</code>标签。<code>latest</code>引用的是最有一个稳定版本的镜像。这样的镜像时十分不稳定的，所以最佳时间推荐使用稳定的镜像。</p><h3 id="使用docker镜像id将图像固定到固定版本">使用Docker镜像ID将图像固定到固定版本</h3><p>每一个Docker都有唯一的ID。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha256:df1808e61a9c32d0ec110960fed213ab2339451ca88941e9be01a03adc98396e</span><br></pre></td></tr></table></figure><p>如何找到最近的镜像的ID 1. 在CircleCI应用程序中，转到最后使用该镜像的构建中。 2. 在<strong>Test Summary</strong>栏中，点击<strong>Spin up environment</strong>。 3. 在日志输出中，找到镜像的摘要。 4. 将图像ID添加到图像名称，如下所示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">circleci&#x2F;ruby@sha256:df1808e61a9c32d0ec110960fed213ab2339451ca88941e9be01a03adc98396e</span><br></pre></td></tr></table></figure><h2 id="镜像类型">镜像类型</h2><p>CircleCi为了便利，提供了两种镜像。语言镜像和服务器镜像。所有的镜像都需要添加<code>circleci</code>用户来作为系统用户。</p><h3 id="镜像语言">镜像语言</h3><ul><li>Android</li><li>Clojure</li><li>Elixir</li><li>Go (Golang)</li><li>JRuby</li><li>Node.js</li><li>OpenJDK (Java)</li><li>PHP</li><li>Python</li><li>Ruby</li><li>Rust</li></ul><h3 id="语言镜像变体">语言镜像变体</h3><p>Circleci维持了一些语言变量的变体镜像。要使用这些变种将以下后缀之一添加到图像标记的末尾。</p><ul><li><code>-node</code> 包括用于多语言应用程序的Node.js.</li><li><code>-browsers</code> 包括Chrome，Firefox，Java 8和Geckodriver.</li><li><code>-browsers-legacy</code> 包括Chrome，Firefox，Java 8和PhantomJS.</li><li><code>-node-browsers</code> 结合了<code>-node</code>和<code>-browsers</code>变体.</li><li><code>-node-browsers-legacy</code> 结合了<code>-node</code>和<code>-browsers-legacy</code>变体.</li></ul><h3 id="服务器镜像">服务器镜像</h3><p>服务镜像是数据库等服务的便利镜像。这些景象应该在语言镜像之后列出，使之成为二级镜像。</p><ul><li><code>buildpack-deps</code></li><li><code>DynamoDB</code></li><li><code>MariaDB</code></li><li><code>MongoDB</code></li><li><code>MySQL</code></li><li><code>PostgreSQL</code></li><li><code>Redis</code></li></ul><h3 id="服务镜像变体">服务镜像变体</h3><p>使用RAM加速需要添加<code>-ram</code>后缀。举例，<code>circleci/postgres:9.5-postgis</code> =&gt; <code>circleci/postgres:9.5-postgis-ram</code>。</p><h2 id="预安装工具">预安装工具</h2><p>除了安卓镜像，其他都包括下列预安装工具，通过<code>apt-get</code>安装。</p><ul><li><code>bzip2</code></li><li><code>ca-certificates</code></li><li><code>curl</code></li><li><code>git</code></li><li><code>gnupg</code></li><li><code>gzip</code></li><li><code>locales</code></li><li><code>mercurial</code></li><li><code>net-tools</code></li><li><code>netcat</code></li><li><code>openssh-client</code></li><li><code>parallel</code></li><li><code>sudo</code></li><li><code>tar</code></li><li><code>unzip</code></li><li><code>wget</code></li><li><code>xvfb</code></li><li><code>zip</code></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;又是关于前两个星期零零星星看的文章的总结，主要关于 CircleCI 。首先是CircleCI的介绍，然后下一篇文字介绍下部署一个vue项目到gh-pages的步骤。
    
    </summary>
    
      <category term="CircleCI" scheme="https://hddhyq.github.io/categories/CircleCI/"/>
    
    
      <category term="自动化" scheme="https://hddhyq.github.io/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/"/>
    
      <category term="CircleCI" scheme="https://hddhyq.github.io/tags/CircleCI/"/>
    
  </entry>
  
  <entry>
    <title>简单聊下响应式布局</title>
    <link href="https://hddhyq.github.io/2019/01/15/%E7%AE%80%E5%8D%95%E8%81%8A%E4%B8%8B%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80/"/>
    <id>https://hddhyq.github.io/2019/01/15/简单聊下响应式布局/</id>
    <published>2019-01-15T15:39:38.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>简单的从响应式布局的viewport介绍到读hexo博客的next主题的源码，来介绍下响应式布局。 <a id="more"></a></p><h1 id="viewport">viewport</h1><p>谈到响应式，就离不开viewport。</p><p>移动端浏览器在一个通常比屏幕更宽的虚拟“窗口”（视口）中渲染页面，用户从而无须将所有页面都压缩进一个小屏幕里（那样会把很多没有针对移动端进行优化的站点打乱）。用户可以通过平移和缩放来浏览页面的不同区域。</p><h2 id="两种viewport">两种viewport</h2><ul><li>布局视口(layout viewport)</li><li>视觉视口(visual viewport)</li></ul><p>想象一下布局视口是一个足够大的而且不会改变尺寸和形状的图片，现在想象你有一个很小的框，你通过这个框来看上面那个足够大的图片。小框周围布满了不透明的材料，通过小框看到的大图就是视觉视口。你可以将小框向后移来观看所有的大图，也可以将小框靠近大图来观看大图的一部分。你也可以改变小框的方向，不过你要知道大图（布局视口）的形状和大小是从来没有改变的。</p><p>视觉视口（visual viewport）是在当前页面中显示屏幕的一部分。用户可能会滚动来改变他所看到的页面的一部分，或者通过缩放来改变视觉视口的尺寸。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/css/mobile_visualviewport.jpg" /></p><p>然而，CSS布局，尤其是百分比宽度，是相对于<strong>布局视口</strong>计算的。布局视口比视觉视口宽的多。</p><p>因此<code>&lt;html&gt;</code>元素最初获取布局视口的宽度，而且你的CSS被解释为宽度比手机宽的多，就相当于上面比喻中小框远离视觉视口的大图。这样可以确保你的页面布局的行为和桌面是一样的。</p><h3 id="不同的浏览器用的默认layoutview的大小是多少呢">不同的浏览器用的默认layoutview的大小是多少呢?</h3><ul><li>Safari iPhone 使用980px</li><li>Opera 使用850px</li><li>Android WebKit 使用800px</li><li>IE 使用974px</li></ul><h3 id="在桌面端viewport">在桌面端viewport</h3><p>桌面端有一个有趣的现象，如果我们定义body中的子元素<code>width:100%</code>，那么这100%相对于谁呢？对，相对于html，html的宽度又取决于<code>viewport</code>，<code>viewport</code>的宽度又相当于浏览器窗口的宽度。</p><p>上面的情况在100%zoom的时候显示正常，当我们缩放窗口的时候，<code>viewport</code>小于页面的总宽度。页面本身没有关系，内容现在溢出超过<code>&lt;html&gt;</code>，但是元素属性设置了<code>overflow: visible</code>，这边是超出的内容也会展示出来。</p><p>下例中，蓝色的顶部栏由于设置了<code>width: 100%</code>，所以浏览器会遵循<code>viewport</code>所设置的宽度。这样蓝色的顶部栏并不管现在它太狭窄了。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/css/desktop_htmlbehaviour.jpg" /></p><h2 id="缩放zooming">缩放zooming</h2><p>两种视口都是用来测量CSS像素，但是显然视觉视口的尺寸是根据缩放改变的（如果你放大，屏幕上的像素就会变少）。如果布局视口没有一直保持不变，那么百分比计算的宽度将会回流和重新计算。</p><h3 id="了解布局视口">了解布局视口</h3><p>为了了解布局视口，我们需要关注一下页面完全缩小的情况。很多移动浏览器都是在完全缩放的情况下展示页面。这种情况下视觉视口等于布局视口。</p><p>因此布局视口的宽度和高度等于我们在完全缩放模式看到的。即使当用户放大窗口，布局视口也保持不变。</p><p>而且当你旋转手机到水平的时候，布局视口的内容也没有变，依旧是缩放到手机上面。这种情况有会导致一个问题，高度比横向少得多，不过网页开发者一般不关心页面的高度，只关心宽度。</p><p>下面罗列几个布局视口的宽度</p><table><thead><tr class="header"><th>属性</th><th>含义</th></tr></thead><tbody><tr class="odd"><td><strong>document. documentElement. clientWidth / Height</strong></td><td>布局视口尺寸</td></tr><tr class="even"><td><strong>window.innerWidth/Height</strong></td><td>视觉视口尺寸</td></tr><tr class="odd"><td><strong>screen.width and screen.height</strong></td><td>屏幕尺寸</td></tr><tr class="even"><td><strong>window.pageX/YOffset</strong></td><td>滚动偏移，和视觉视口相对于布局视口的值相同</td></tr><tr class="odd"><td><strong>document. documentElement. offsetWidth / Height</strong></td><td><code>&lt;html&gt;</code>标签的尺寸</td></tr><tr class="even"><td><strong>Media queries</strong></td><td>测量<code>&lt;html&gt;</code>的宽度（width）或者设备的宽度(device-width)。</td></tr></tbody></table><h2 id="viewport-meta属性">viewport Meta属性</h2><p>这里让我们看一下<code>&lt;meta name="viewport" content="width=320"&gt;</code>的意义，这表示调整布局视口的尺寸。为了了解为什么这个属性这么重要，我们需要退后一步讨论。</p><p>假设你正在写一个简单的页面而且你没有设定你的元素的宽度。那么他们就会伸缩到布局视口宽度的100%。大多数浏览器都会将整个页面缩放来显示整个布局视口。像下图所示和缩放效果。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/css/mq_none.jpg" /><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/css/mq_none_zoomed.jpg" /></p><p>现在设置<code>html {width: 320px}</code>的时候，<code>&lt;html&gt;</code>将会收缩，所有的元素都会取320px的100%，但是这种情况只有用户放大页的时候才能得到，并不是初始化的状态。当用户缩小页面的时候，将会有大片的空白区域。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/css/mq_html300.jpg" /><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/blog/css/mq_yes.jpg" /></p><p>当你设置为<code>&lt;meta name="viewport" content="width=320"&gt;</code>的时候，初始化也显示正常了。你也可以设置任何你想要的宽度，包括<code>device-width</code>。将会取得屏幕的宽度<code>screen.width</code>（在设备像素中），于是布局视口将会使用这个值。</p><p>不过这里有一个问题，有时真正的<code>screen.width</code>并没有起多大的作用，因为像素树太高了。例如， Nexus One 的屏幕像素是480px，不过谷歌工程师觉得给480px的宽度作为<code>device-width</code>来说太大了。所以他们决定使用缩放到 2/3 ，所以<code>device-width</code>所表达的宽度就是320px。</p><p>最后这里介绍下典型的针对移动端优化的viewport</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, maximum-scale=1"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 添加用户缩放禁止 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1,maximum-scale=1, minimum-scale=1, user-scalable=no"</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>width</code>控制视口的宽度。可以设置width=600这样的固定值，或者device-width这类的特殊值来指导比例为100%时屏幕宽度的CSS像素数值。</p><h2 id="像素并非像素">像素并非像素</h2><p>许多手机都有物理像素都比页面的布局大得多，所以移动端将会以多个物理像素现已单个CSS像素。意味着<code>initial-scale=1</code>在安卓或者ios手机上，都能显示较为接近的物理尺寸。</p><p>在240dpi及以上的屏幕上，<code>initial-scale=1</code>的页面实际上会被Android WebKit浏览器放大至150%。其中的文字会保持平滑锐利，但是位图图像在全屏模式下就会不尽人意。为了使图片在这些屏幕上变得清晰，web开发者会将图片甚至整个布局设计成最终尺寸的150%（或者200%从而支持像配备retina屏的iPhone那样的像素密度高达320 dpi及以上的设备），然后通过CSS或视口属性缩小。</p><p>默认比例依赖于显示密度。在密度低于200dpi的显示设备上，比例为1.0。在密度介于200及300dpi之间的显示设备上，比例为1.5。对于具有300dpi以上密度的现实设备，比例为/150dpi向下取整。注意再有在视口比例为1时才会应用默认比例。否则，CSS像素与设备像素之间的关系依赖于当前的缩放等级。</p><h1 id="next源码中响应式应用">next源码中响应式应用</h1><p>hexo中的<a href="http://theme-next.iissnan.com/">next主题</a>是一个非常热门的blog主题，其中的相关源码是使用stylus书写的。</p><p>首先在文件夹外面定义了尺寸，这部分尺寸定义在需要修改样式的地方会进行修改。 <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">mobile-smallest</span><span class="params">()</span></span> &#123;</span><br><span class="line">  @media (<span class="attribute">max-width</span>: <span class="number">413px</span>) &#123;</span><br><span class="line">    &#123;block&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">mobile-small</span><span class="params">()</span></span> &#123;</span><br><span class="line">  @media (<span class="attribute">max-width</span>: <span class="number">567px</span>) &#123;</span><br><span class="line">    &#123;block&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">mobile</span><span class="params">()</span></span> &#123;</span><br><span class="line">  @media (<span class="attribute">max-width</span>: <span class="number">767px</span>) &#123;</span><br><span class="line">    &#123;block&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">tablet</span><span class="params">()</span></span> &#123;</span><br><span class="line">  @media (<span class="attribute">min-width</span>: <span class="number">768px</span>) and (max-width: <span class="number">991px</span>) &#123;</span><br><span class="line">    &#123;block&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">desktop</span><span class="params">()</span></span> &#123;</span><br><span class="line">  @media (<span class="attribute">min-width</span>: <span class="number">992px</span>) &#123;</span><br><span class="line">    &#123;block&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">desktop-large</span><span class="params">()</span></span> &#123;</span><br><span class="line">  @media (<span class="attribute">min-width</span>: <span class="number">1600px</span>) &#123;</span><br><span class="line">    &#123;block&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>博客的左侧的页面导航在小于767的时候会隐藏，在大于767px的时候会在左上显示。这里展示部分代码：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.site-nav-toggle</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: none;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">10px</span>;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">button</span> &#123;</span><br><span class="line">    <span class="attribute">margin-top</span>: <span class="number">2px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">9px</span> <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">background</span>: transparent;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.site-nav</span> &#123;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> -<span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">clear</span>: both;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> solid <span class="variable">$gray</span>-lighter;</span><br><span class="line">  &#125;</span><br><span class="line">  +tablet() &#123; <span class="attribute">display</span>: block !important; &#125;</span><br><span class="line">  +desktop() &#123; <span class="attribute">display</span>: block !important; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后放下layout的布局stylus：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.header</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">  <span class="attribute">width</span>: <span class="variable">$main</span>-desktop;</span><br><span class="line"></span><br><span class="line">  +tablet() &#123;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.header-inner</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">240px</span>;</span><br><span class="line">  <span class="attribute">background</span>: white;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="variable">$box</span>-shadow-inner;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="variable">$border</span>-radius-inner;</span><br><span class="line"></span><br><span class="line">  +desktop-large() &#123;</span><br><span class="line">    <span class="selector-class">.container</span> &amp; &#123; <span class="attribute">width</span>: <span class="number">240px</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  +tablet() &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">    <span class="attribute">border-radius</span>: initial;</span><br><span class="line">  &#125;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">    <span class="attribute">border-radius</span>: initial;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.main</span> &#123;</span><br><span class="line">  clearfix();</span><br><span class="line">  +tablet() &#123;</span><br><span class="line">    <span class="attribute">padding-bottom</span>: <span class="number">100px</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">padding-bottom</span>: <span class="number">100px</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.container</span> <span class="selector-class">.main-inner</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="variable">$main</span>-desktop;</span><br><span class="line"></span><br><span class="line">  +tablet() &#123;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.content-wrap</span> &#123;</span><br><span class="line">  <span class="attribute">float</span>: right;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="variable">$content</span>-desktop-padding;</span><br><span class="line">  <span class="attribute">width</span>: <span class="variable">$content</span>-desktop;</span><br><span class="line">  <span class="attribute">background</span>: white;</span><br><span class="line">  <span class="attribute">min-height</span>: <span class="number">700px</span>;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="variable">$box</span>-shadow-inner;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="variable">$border</span>-radius-inner;</span><br><span class="line"></span><br><span class="line">  +tablet() &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: initial;</span><br><span class="line">  &#125;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">min-height</span>: auto;</span><br><span class="line">    <span class="attribute">border-radius</span>: initial;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: static;</span><br><span class="line">  <span class="attribute">float</span>: left;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="variable">$sidebar</span>-desktop;</span><br><span class="line">  <span class="attribute">background</span>: <span class="variable">$body</span>-bg-color;</span><br><span class="line">  <span class="attribute">box-shadow</span>: none;</span><br><span class="line"></span><br><span class="line">  +tablet() &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">  &#125;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sidebar-toggle</span> &#123; <span class="attribute">display</span>: none; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.footer-inner</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="variable">$main</span>-desktop;</span><br><span class="line">  <span class="attribute">padding-left</span>: <span class="number">260px</span>;</span><br><span class="line"></span><br><span class="line">  +tablet() &#123;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">0</span> !important;</span><br><span class="line">    <span class="attribute">padding-right</span>: <span class="number">0</span> !important;</span><br><span class="line">  &#125;</span><br><span class="line">  +mobile() &#123;</span><br><span class="line">    <span class="attribute">width</span>: auto;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">0</span> !important;</span><br><span class="line">    <span class="attribute">padding-right</span>: <span class="number">0</span> !important;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.sidebar-position-right</span> &#123;</span><br><span class="line">  <span class="selector-class">.header-inner</span> &#123; <span class="attribute">right</span>: <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="selector-class">.content-wrap</span> &#123; <span class="attribute">float</span>: left; &#125;</span><br><span class="line">  <span class="selector-class">.sidebar</span> &#123; <span class="attribute">float</span>: right; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.footer-inner</span> &#123;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding-right</span>: <span class="number">260px</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="小结">小结</h2><p>因为blog的主要受众还是网页端，所以默认尺寸的填写时桌面端，再根据媒体查询开始往小尺寸开始。我看网上有说，页面优先从小尺寸开始写，这样比较适合响应式。不过我觉得应该根据页面的主要受众，来决定是优先移动端还是桌面端。太复杂的页面应该也不用写响应式，应该根据桌面端和移动端单独设计。</p><h1 id="引用">引用</h1><ul><li><a href="https://www.quirksmode.org/mobile/viewports.html">A Tale of Two Viewports</a></li><li><a href="https://www.quirksmode.org/mobile/viewports2.html">A Tale of Two Viewports</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Mobile/Viewport_meta_tag">在移动浏览器中使用viewport元标签控制布局</a></li><li><span class="citation" data-cites="media">[@media]</span>(https://developer.mozilla.org/zh-CN/docs/Web/CSS/<span class="citation" data-cites="media">@media</span>)</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;简单的从响应式布局的viewport介绍到读hexo博客的next主题的源码，来介绍下响应式布局。
    
    </summary>
    
      <category term="css" scheme="https://hddhyq.github.io/categories/css/"/>
    
    
      <category term="css" scheme="https://hddhyq.github.io/tags/css/"/>
    
      <category term="mediaQuery" scheme="https://hddhyq.github.io/tags/mediaQuery/"/>
    
      <category term="viewport" scheme="https://hddhyq.github.io/tags/viewport/"/>
    
  </entry>
  
  <entry>
    <title>了解MV*模式</title>
    <link href="https://hddhyq.github.io/2018/12/23/%E4%BA%86%E8%A7%A3MV-%E6%A8%A1%E5%BC%8F/"/>
    <id>https://hddhyq.github.io/2018/12/23/了解MV-模式/</id>
    <published>2018-12-23T10:58:03.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>找了和看了许多关于MVC、MVP、MVVM的资料，趁着周末同样是做一下总结。 <a id="more"></a> # MV*需要解决的问题 在传统的GUI程序中，图形界面展示数据和信息，用户的输入行为会触发一些应用逻辑（application logic）可能会触发一些业务逻辑（business logic），业务逻辑会对数据进行相关的变更操作。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/basic_knowledge/gui.png" /></p><p>所以这里需要解决的问题有：View如何同步Model的变更，View和Model之间如何粘合在一起。</p><h1 id="mvc">MVC</h1><p>MVC把应用程序分为了view、model层以及controller层， <strong>controller</strong> 的主要职责是 <strong>进行Model和View</strong> 之间的协作（路由、输入预处理等）应用逻辑； <strong>model</strong> 进行处理业务逻辑。它们的如下：</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/basic_knowledge/mvc.png" /></p><h2 id="mvc的调用关系">MVC的调用关系</h2><p>一般来说网页上用户的的调用关系如下图所示：</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/basic_knowledge/mvc1.png" /></p><p>用户对View操作后，View捕获到这个操作，会把处理权给Controller；Controller会对来自View的数据进行预处理，决定调用哪一个Model的接口；然后由Model执行相关的业务逻辑；当Model变更之后，会通过 <strong>观察者模式（Observer Pattern）通知View</strong> ； <strong>View通过观察者模式</strong> 收到Model变更的消息后，会向Model请求最新的数据，然后重新更新界面。</p><p>需要注意的点：</p><ol type="1"><li><p>View把控制权交给Controller，Controller执行应用程序相关的应用逻辑（对来自View数据进行预处理、决定调用哪个Model的接口等等）。</p></li><li><p>Controller操作Model，Model执行业务逻辑对数据进行处理。Controller不会直接操作View，它并不用了解View。</p></li><li><p>View和Model的同步消息是通过观察者模式进行，而同步操作是由View自己请求Model的数据然后对视图进行更新。</p></li></ol><h2 id="mvc的优缺点">MVC的优缺点</h2><p>优点： 1. 把业务逻辑和展示逻辑分离，模块化程度高。且当应用逻辑需要变更的时候，不需要变更业务逻辑和展示逻辑，只需要Controller换成另外一个Controller就行了（Swappable Controller）。 2. 观察者模式可以做到多视图同时更新。</p><p>缺点： 1. Controller测试困难。因为视图同步操作是由View自己执行，而View只能在有UI的环境下运行。在没有UI环境下对Controller进行单元测试的时候，应用逻辑正确性是无法验证的：Model更新的时候，无法对View的更新操作进行断言。 2. View无法组件化。View是强依赖特定的Model的，如果需要把这个View抽出来作为一个另外一个应用程序可复用的组件就困难了。因为不同程序的的Domain Model是不一样的。</p><h3 id="mvc在服务端调用">MVC在服务端调用</h3><p>服务端接收到来自客户端的请求，服务端通过路由规则把这个请求交由给特定的Controller进行处理，Controller执行相应的应用逻辑，对Model进行操作，Model执行业务逻辑以后；然后用数据去渲染特定的模版，返回给客户端。</p><p>相对于MVC中的输入就是Controller：</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/basic_knowledge/mvc2.png" /></p><h1 id="mvp">MVP</h1><p>MVP模式将Controller改名为 Presenter，同时改变了通信方向：</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/basic_knowledge/mvp.png" /></p><p>和MVC模式一样，用户对View的操作都会从View交移给Presenter。Presenter会执行相应的应用程序逻辑，并且对Model进行相应的操作；而这时候Model执行完业务逻辑以后，也是通过观察者模式把自己变更的消息传递出去，但是是传给Presenter而不是View。Presenter获取到Model变更的消息以后，<strong>通过View提供的接口更新界面</strong>。</p><p>关键点： 1. View不再负责同步的逻辑，而是由Presenter负责。Presenter中既有应用程序逻辑也有同步逻辑。 2. View需要提供操作界面的接口给Presenter进行调用。（关键）</p><p>对比在MVC中，Controller是不能操作View的，View也没有提供相应的接口；而在MVP当中，Presenter可以操作View，View需要提供一组对界面操作的接口给Presenter进行调用；Model仍然通过事件广播自己的变更，但由Presenter监听而不是View。</p><p>这里 View 非常薄，不部署任何业务逻辑，称为"被动视图"（Passive View），即没有任何主动性，而 Presenter非常厚，所有逻辑都部署在那里</p><h2 id="mvp优缺点">MVP优缺点</h2><p>优点： 1. 便于测试。Presenter对View是通过接口进行，在对Presenter进行不依赖UI环境的单元测试的时候。可以通过Mock一个View对象，这个对象只需要实现了View的接口即可。然后依赖注入到Presenter中，单元测试的时候就可以完整的测试Presenter应用逻辑的正确性。 2. View可以进行组件化。在MVP当中，View不依赖Model。这样就可以让View从特定的业务场景中脱离出来，可以说View可以做到对业务完全无知。它只需要提供一系列接口提供给上层操作。这样就可以做到高度可复用的View组件。</p><p>缺点： 1. Presenter中除了应用逻辑以外，还有大量的View-&gt;Model，Model-&gt;View的手动同步逻辑，造成Presenter比较笨重，维护起来会比较困难。</p><h1 id="mvvm">MVVM</h1><p>MVVM 模式将 Presenter 改名为 ViewModel，基本上与 MVP 模式完全一致。ViewModel的含义就是 "Model of View"，视图的模型。它的含义包含了领域模型（Domain Model）和视图的状态（State）。 在图形界面应用程序当中，界面所提供的信息可能不仅仅包含应用程序的领域模型。还可能包含一些领域模型不包含的视图状态，例如电子表格程序上需要显示当前排序的状态是顺序的还是逆序的，而这是Domain Model所不包含的，但也是需要显示的信息。</p><p>可以简单把ViewModel理解为页面上所显示内容的数据抽象，和Domain Model不一样，ViewModel更适合用来描述View。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/basic_knowledge/mvvm.png" /></p><h2 id="mvvm的调用关系">MVVM的调用关系</h2><p>MVVM的调用关系和MVP一样。但是，在ViewModel当中会有一个叫Binder，或者是Data-binding engine的东西。以前全部由Presenter负责的View和Model之间数据同步操作交由给Binder处理。你只需要在View的模版语法当中，指令式地声明View上的显示的内容是和Model的哪一块数据绑定的。当ViewModel对进行Model更新的时候，Binder会自动把数据更新到View上去，当用户对View进行操作（例如表单输入），Binder也会自动把数据更新到Model上去。这种方式称为：Two-way data-binding，双向数据绑定。可以简单而不恰当地理解为一个模版引擎，但是会根据数据变更实时渲染。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/basic_knowledge/mvvm1.png" /></p><p>也就是说，MVVM把View和Model的同步逻辑自动化了。以前Presenter负责的View和Model同步不再手动地进行操作，而是交由框架所提供的Binder进行负责。只需要告诉Binder，View显示的数据对应的是Model哪一部分即可。</p><h2 id="mvvm的优缺点">MVVM的优缺点</h2><p>优点：</p><ol type="1"><li>提高可维护性。解决了MVP大量的手动View和Model同步的问题，提供双向绑定机制。提高了代码的可维护性。</li><li>简化测试。因为同步逻辑是交由Binder做的，View跟着Model同时变更，所以只需要保证Model的正确性，View就正确。大大减少了对View同步更新的测试。</li></ol><p>缺点： 1. 对于大型的图形应用程序，视图状态较多，ViewModel的构建和维护的成本都会比较高。 2. 数据绑定的声明是指令式地写在View的模版当中的，这些内容是没办法去打断点debug的。</p><h1 id="引用">引用</h1><ul><li>https://github.com/livoras/blog/issues/11</li><li>https://stackoverflow.com/questions/4415904/business-logic-in-mvc</li><li>https://addyosmani.com/resources/essentialjsdesignpatterns/book/#detailmvcmvp</li><li>http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;找了和看了许多关于MVC、MVP、MVVM的资料，趁着周末同样是做一下总结。
    
    </summary>
    
      <category term="computer" scheme="https://hddhyq.github.io/categories/computer/"/>
    
    
      <category term="设计模式" scheme="https://hddhyq.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
      <category term="MVC" scheme="https://hddhyq.github.io/tags/MVC/"/>
    
      <category term="MVP" scheme="https://hddhyq.github.io/tags/MVP/"/>
    
      <category term="MVVM" scheme="https://hddhyq.github.io/tags/MVVM/"/>
    
  </entry>
  
  <entry>
    <title>Levenshtein distance 编辑距离算法</title>
    <link href="https://hddhyq.github.io/2018/12/08/Levenshtein-distance-%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB%E7%AE%97%E6%B3%95/"/>
    <id>https://hddhyq.github.io/2018/12/08/Levenshtein-distance-编辑距离算法/</id>
    <published>2018-12-08T06:53:12.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>这几天再看virtrual-dom，关于两个列表的对比，讲到了Levenshtein distance距离，周末抽空做一下总结。 <a id="more"></a> # Levenshtein Distance 介绍 在信息理论和计算机科学中，Levenshtein距离是用于测量两个序列之间的差异量（即编辑距离）的度量。两个字符串之间的Levenshtein距离定义为将一个字符串转换为另一个字符串所需的最小编辑数，允许的编辑操作是单个字符的插入，删除或替换。</p><h2 id="例子">例子</h2><p>'kitten'和'sitten'之间的 Levenshtein 距离是3，因为一下三个编辑将一个更改为另一个，并且没有办法用少于三个编辑来执行操作。</p><ol type="1"><li><code>k</code> itten <code>s</code>itten =&gt; 用's'代替'k'</li><li>sitt <code>e</code> n sitt <code>i</code> =&gt; 用'i'代替'e'</li><li>sittin sittin <code>g</code> 在结尾插入'g'</li></ol><h1 id="levenshtein-distance-编辑距离-算法详解">Levenshtein Distance (编辑距离) 算法详解</h1><p>为了得到编辑距离，我们用 beauty 和 batyu 为例：</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/algorithm/ld.png" /></p><p>图示如 <strong>①</strong> 单元位置是两个单词的第一个字符[b]比较得到的值，其的值有它的上方的值(1)、它左方的值(1)和它左上角的值(0)来决定。当单元格所在的行和列所对应的字符相等时，单元格的值为左上方的值。</p><p>否则，单元格左上角的值与其上方和左方的值进行比较，它们之间的最小值+1即是单元格的值。</p><p>图中 <strong>①</strong> 的值由于单元格行和列相等，所以取左上角值0。</p><p>图中 <strong>②</strong> 的值由于单元格行列不相等，(1, 2, 0)取最小为0， 结果+1， 所以 <strong>②</strong> 值为1。</p><p>图示 <strong>③</strong> 的值由于单元格行列不相等，(1, 0, 2)取最小0， 结果+1， 所以 <strong>③</strong> 值为1。</p><h2 id="算法证明">算法证明</h2><p>这个算法计算的是将s[1…i]转换为t[1…j]（例如将beauty转换为batyu）所需最少的操作数（也就是所谓的编辑距离），这个操作数被保存在d[i,j]（d代表的就是上图所示的二维数组）中。</p><ul><li>在第一行与第一列肯定是正确的，这也很好理解，例如我们将beauty转换为空字符串，我们需要进行的操作数为beauty的长度（所进行的操作为将beauty所有的字符丢弃）。</li><li>我们对字符的可能操作有三种：</li><li>将s[1…n]转换为t[1…m]当然需要将所有的s转换为所有的t，所以，d[n,m]（表格的右下角）就是我们所需的结果。</li><li>如果我们可以使用k个操作数把s[1…i]转换为t[1…j-1]，我们只需要把t[j]加在最后面就能将s[1…i]转换为t[1…j]，操作数为k+1</li><li>如果我们可以使用k个操作数把s[1…i-1]转换为t[1…j]，我们只需要把s[i]从最后删除就可以完成转换，操作数为k+1</li><li>如果我们可以使用k个操作数把s[1…i-1]转换为t[1…j-1]，我们只需要在需要的情况下（s[i] != t[j]）把s[i]替换为t[j]，所需的操作数为k+cost（cost代表是否需要转换，如果s[i]==t[j]，则cost为0，否则为1）。</li></ul><h2 id="可能的改进">可能的改进</h2><ul><li>现在的算法复杂度为O(m*n)，可以将其改进为O(m)。因为这个算法只需要上一行和当前行被存储下来就可以了。</li><li>如果需要重现转换步骤，我们可以把每一步的位置和所进行的操作保存下来，进行重现。</li><li>如果我们只需要比较转换步骤是否小于一个特定常数k，那么只计算高宽宽为2k+1的矩形就可以了，这样的话，算法复杂度可简化为O(kl)，l代表参加对比的最短string的长度。</li><li>我们可以对三种操作（添加，删除，替换）给予不同的权值（当前算法均假设为1，我们可以设添加为1，删除为0，替换为2之类的），来细化我们的对比。</li><li>如果我们将第一行的所有cell初始化为0，则此算法可以用作模糊字符查询。我们可以得到最匹配此字符串的字符串的最后一个字符的位置（index number），如果我们需要此字符串的起始位置，我们则需要存储各个操作的步骤，然后通过算法计算出字符串的起始位置。</li><li>这个算法不支持并行计算，在处理超大字符串的时候会无法利用到并行计算的好处。但我们也可以并行的计算cost values（两个相同位置的字符是否相等），然后通过此算法来进行整体计算。</li><li>如果只检查对角线而不是检查整行，并且使用延迟验证（lazy evaluation），此算法的时间复杂度可优化为O(m(1+d))（d代表结果）。这在两个字符串非常相似的情况下可以使对比速度速度大为增加。</li></ul><h2 id="字符串比较代码">字符串比较代码</h2><p>这一部分的代码，参考了 https://rosettacode.org/wiki/Levenshtein_distance#ES5</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ld = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> t = [], u, i, j, m = a.length, n = b.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!m) <span class="keyword">return</span> b;</span><br><span class="line">  <span class="keyword">if</span> (!n) <span class="keyword">return</span> a;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt;= m; j++) &#123;</span><br><span class="line">    t[j] = j;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(t);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (u = [i], j = <span class="number">1</span>; j &lt;= m; j++) &#123;</span><br><span class="line">      u[j] = a[j - <span class="number">1</span>] === b[i - <span class="number">1</span>] ? t[j - <span class="number">1</span>] : <span class="built_in">Math</span>.min(t[j - <span class="number">1</span>], t[j], u[j - <span class="number">1</span>]) + <span class="number">1</span>  <span class="comment">// Levenshtein Distance 算法核心比较部分。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t = u;</span><br><span class="line">    <span class="built_in">console</span>.log(t);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> u[m];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[[<span class="string">'beauty'</span>, <span class="string">'batyu'</span>, <span class="number">3</span>],</span><br><span class="line">].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">v</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = v[<span class="number">0</span>], b = v[<span class="number">1</span>], t = v[<span class="number">2</span>], d = ld(a, b);</span><br><span class="line">  <span class="keyword">if</span> (d !== t) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'levenstein("'</span> + a + <span class="string">'","'</span> + b + <span class="string">'") was '</span> + d + <span class="string">' should be '</span> + t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印出来</span></span><br><span class="line">[ <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span> ]</span><br><span class="line">[ <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> ]</span><br><span class="line">[ <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> ]</span><br><span class="line">[ <span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line">[ <span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span> ]</span><br><span class="line">[ <span class="number">5</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span> ]</span><br></pre></td></tr></table></figure><h1 id="还原字符串">还原字符串</h1><p>上面总结了传统的计算字符串之间的差距，那么当我们怎么能在计算的过程中，记录需要转换的步骤，并且进行还原呢。</p><p>这里我们需要对比较的每一位的步骤有一个了解。</p><p>为了得到编辑距离，我们用 beauty 和 batyu 为例： 从上面一节的图中可以看到，<code>'beauty'</code> 转换为 <code>''</code> ，对一个的第一行的 <code>[1，2，3，4，5，6]</code>，每一个步骤都相对与上一个元素新建一个元素，同理 <code>''</code> 转换为 <code>'batyu'</code>，每一个值都是相对一上一个元素的删除步骤。</p><p>那么对角线也显而易见就是先相对于替换操作。那么我们现在需要做的就是，记录下相对应的索引和元素以及需要进行的操作，并将其保存为一个对象，每次新增的对象用数组来保存就可以了。</p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/algorithm/translate.png" /></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> actionType = &#123;</span><br><span class="line">  TYPE_REPLACE: <span class="string">'TYPE_REPLACE'</span>,</span><br><span class="line">  TYPE_NEW: <span class="string">'TYPE_NEW'</span>,</span><br><span class="line">  TYPE_DELETE: <span class="string">'TYPE_DELETE'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成对象的方法</span></span><br><span class="line"><span class="keyword">const</span> patchObj = <span class="function">(<span class="params">index, type, item = <span class="string">''</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    index,</span><br><span class="line">    type,</span><br><span class="line">    item</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是compare方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>r 替换操作 replace</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>n 新建操作 new</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; array &#125;</span> </span>d 删除操作 delete</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; number &#125;</span> </span>i 需要转换元素的 index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; number &#125;</span> </span>j 需要删除元素的 index</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123; string &#125;</span> </span>b 比较字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> compare = <span class="function">(<span class="params">r, n, d, i, j, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> min = <span class="built_in">Math</span>.min(r.length, n.length, d.length);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (min) &#123;</span><br><span class="line">    <span class="keyword">case</span> r.length:</span><br><span class="line">      <span class="keyword">return</span> [...r, patchObj(i, actionType.TYPE_REPLACE, b[i])];</span><br><span class="line">    <span class="keyword">case</span> n.length:</span><br><span class="line">      <span class="keyword">return</span> [...n, patchObj(i, actionType.TYPE_NEW, b[i])];</span><br><span class="line">    <span class="keyword">case</span> d.length:</span><br><span class="line">      <span class="keyword">return</span> [...d, patchObj(j, actionType.TYPE_DELETE)];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面需要注意的是，我们一组保存了多个数组对象，不要对原数组进行操作，每一次操作我们都需要拷贝一个新的数组对象。</p><p>具体的的diff代码参考<a href="https://github.com/hddhyq/Levenshtein-distance/blob/master/diff.js">diff代码</a></p><p>得到了，patches对象，剩下的我们就需要patch了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> patch = <span class="function">(<span class="params">a, diffs</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> aList = a.split(<span class="string">''</span>);</span><br><span class="line">  <span class="keyword">let</span> delCount = <span class="number">0</span>; <span class="comment">// 删除之后，后续的index计算需要加上之前删除的数量</span></span><br><span class="line">  diffs.forEach(<span class="function">(<span class="params">diff</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (diff.type) &#123;</span><br><span class="line">      <span class="keyword">case</span> actionType.TYPE_DELETE:</span><br><span class="line">        aList.splice(diff.index - delCount, <span class="number">1</span>);</span><br><span class="line">        delCount++</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> actionType.TYPE_NEW:</span><br><span class="line">        aList.splice(diff.index, <span class="number">0</span>, diff.item);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> actionType.TYPE_REPLACE:</span><br><span class="line">        aList.splice(diff.index, <span class="number">1</span>, diff.item);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// console.log(aList.join(''))</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> aList.join(<span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体代码参考<a href="https://github.com/hddhyq/Levenshtein-distance">代码地址</a></p><h1 id="参考资料">参考资料</h1><ul><li><a href="http://www.cnblogs.com/zhoug2020/p/4224866.html">http://www.cnblogs.com/zhoug2020/p/4224866.html</a></li><li><a href="https://rosettacode.org/wiki/Levenshtein_distance#ES5">https://rosettacode.org/wiki/Levenshtein_distance#ES5</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这几天再看virtrual-dom，关于两个列表的对比，讲到了Levenshtein distance距离，周末抽空做一下总结。
    
    </summary>
    
      <category term="算法" scheme="https://hddhyq.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="https://hddhyq.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="vitrual-dom" scheme="https://hddhyq.github.io/tags/vitrual-dom/"/>
    
  </entry>
  
  <entry>
    <title>css世界之层叠规则</title>
    <link href="https://hddhyq.github.io/2018/10/02/css%E4%B8%96%E7%95%8C%E4%B9%8B%E5%B1%82%E5%8F%A0%E8%A7%84%E5%88%99/"/>
    <id>https://hddhyq.github.io/2018/10/02/css世界之层叠规则/</id>
    <published>2018-10-02T09:06:46.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>这是关于css世界我总结的最后一篇。层叠规则 <a id="more"></a> # z-index只是一小部分</p><p>CSS世界中，z-index属性只有和定位元素（position不为static的元素）在一起的时候才有作用，可以是正数也可以是负数。在CSS3中，flex盒子的子元素也可以设置z-index属性。</p><h2 id="理解层叠上下文和层叠水平">理解层叠上下文和层叠水平</h2><p>层叠上下文，英文称作stacking context，是HTML中的一个三维概念。</p><ol type="1"><li><p>位于最下面的 background/border 特指层叠上下文元素的边框和背景色。每一个层叠顺序规则仅适用于当前层叠上下文元素的小世界。</p></li><li><p>inline 水平盒子指的是包括 inline/inline-block/inline-table 元素的“层叠顺序”，它们都是同等级别的。</p></li><li><p>单纯从层叠水平上看，实际上 <code>z-index:0</code> 和 <code>z-index:auto</code> 是可以看成是一样的。注意这里的措辞—“单纯从层叠水平上看”，实际上，两者在层叠上下文领域有着根本性的差异。</p></li></ol><h3 id="层叠准则">层叠准则</h3><ol type="1"><li><p>谁大谁上：当具有明显的层叠水平标识的时候，如生效的 z-index 属性值，在同一个层叠上下文领域，层叠水平值大的那一个覆盖小的那一个。</p></li><li><p>后来居上：当元素的层叠水平一致、层叠顺序相同的时候，在 DOM 流中处于后面的元素会覆盖前面的元素。</p></li></ol><h3 id="层叠上下文特性">层叠上下文特性</h3><ul><li>层叠上下文的层叠水平要比普通元素高。</li><li>层叠上下文可以阻断元素的混合模式。</li><li>层叠上下文可以嵌套，内部层叠上下文及其所有子元素均受制于外部的“层叠上下文”。</li><li>每个层叠上下文和兄弟元素独立，也就是说，当进行层叠变化或渲染的时候，只需要考虑后代元素。</li><li>每个层叠上下文是自成体系的，当元素发生层叠的时候，整个元素被认为是在父层叠上下文的层叠顺序中。</li></ul><h3 id="层叠上下文的创建">层叠上下文的创建</h3><ol type="1"><li><p>天生派: 页面根元素天生具有层叠上下文，称之为根层叠上下文。</p></li><li><p>正统派: z-index值为数值的定位元素的传统“层叠上下文”。</p><p>对于 position 值为 relative/absolute 以及 Firefox/IE 浏览器（不包括 Chrome 浏览器）下含有 <code>position:fixed</code> 声明的定位元素，当其 z-index 值不是 auto 的时候，会创建层叠上下文。需要注意下，当两个相邻div的z-index为auto，将直接比较里面元素的z-index，当两个相邻div的层级都为相同数值的时候，父级的层级“后来居上”。Chrome 等 WebKit 内核浏览器下，<code>position:fixed</code> 元素天然层叠上下文元素，无须 z-index为数值。</p></li><li><p>扩招派: 其他CSS3属性。</p><ul><li>元素为 <code>flex</code> 布局元素（父元素 display:flex|inline-flex），同时 z-index值不是 auto。</li><li>元素的 <code>opacity</code> 值不是 1。</li><li>元素的 <code>transform</code> 值不是 none。</li><li>元素 <code>mix-blend-mode</code> 值不是 normal。</li><li>元素的 <code>filter</code> 值不是 none。</li><li>元素的 <code>isolation</code> 值是 isolate。</li><li>元素的 <code>will-change</code> 属性值为上面 2～6 的任意一个（如 <code>will-change:opacity</code>、<code>will-chang:transform</code> 等）。</li><li>元素的<code>-webkit-overflow-scrolling</code> 设为 <code>touch</code>。</li></ul></li></ol><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/z_index_stack.png" /></p><h3 id="z-index不犯2准则">z-index“不犯2”准则</h3><p>对于非浮层元素，避免设置z-index值，z-index值没有任何道理需要超过2。</p><ol type="1"><li><p>定位元素一旦设置z-index值，就从普通定位元素变成了层叠上下文元素，相互间的层叠顺序就发生了根本的变化，很容易出现设置了巨大的 z-index 值也无法覆盖其他元素的问题。</p></li><li><p>避免 z-index“一山比一山高”的样式混乱问题。</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这是关于css世界我总结的最后一篇。层叠规则
    
    </summary>
    
      <category term="css世界" scheme="https://hddhyq.github.io/categories/css%E4%B8%96%E7%95%8C/"/>
    
    
      <category term="css" scheme="https://hddhyq.github.io/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>css世界之内联元素&amp;&amp;流的破坏</title>
    <link href="https://hddhyq.github.io/2018/10/01/css%E4%B8%96%E7%95%8C%E4%B9%8B%E5%86%85%E8%81%94%E5%85%83%E7%B4%A0-%E6%B5%81%E7%9A%84%E7%A0%B4%E5%9D%8F/"/>
    <id>https://hddhyq.github.io/2018/10/01/css世界之内联元素-流的破坏/</id>
    <published>2018-10-01T05:16:11.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>这一部分总结了两处，一处是内联元素，其实内联元素这里主要让我重新认识了下vertical-align和line-height。另一处就是关于流的破坏，主要就是介绍了下float和absolute这些属性一些知识点了。最后国庆节快乐哈哈。 <a id="more"></a> # 内联元素与流</p><p>在内联盒子中，涉及到垂直方向的排版或者对齐，都离不开基线。而字母x的下边缘就是我们的基线（baseline）。</p><p><code>vertical-align: middle</code>对齐为字母x的中心，因为各种字体不同，所以不是绝对的垂直居中。内联元素垂直居中是对文字，而非外部的块级元素。</p><p>ex是CSS一个相对单位，指的是小写字母x的高度，就是指<strong>x-height</strong>。</p><h2 id="内联元素的高度-line-height">内联元素的高度 line-height</h2><p>对于非替换元素的纯内联元素，其可视高度完全由line-height决定。</p><p>由于上下半间距的存在，与设计师的文字上下边距的计算一般不同，需要我们重新计算下，文字一般偏下，所以文字下边距向上取整，文字上边距向上取整。在有内联替换元素的时候，line-height不能影响替换元素的高度，内联替换元素和内联元素混排的的时候。line-height只能决定行高的最小高度。</p><h3 id="line-height让内联元素垂直居中">line-height让内联元素“垂直居中”</h3><p>要让单行文字垂直居中，其实不用设置height，只需要设置好line-height的高度就好了。</p><p>多行文字居中的话也有办法，嵌套的div，使用inline-block来表示。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">120px</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#f0f3f9</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.content</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">vertical-align</span>: middle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么上面的代码能垂直居中呢，全凭内联盒子前面那个宽度为0的“幽灵空白节点”。</p><h2 id="line-height的属性值">line-height的属性值</h2><p><code>line-height: normal</code>是默认值。不同字体下的<code>line-height</code>的属性值normal计算量都是不一样的：</p><table><thead><tr class="header"><th>字体</th><th>Chrome</th><th>Firefox</th><th>IE</th></tr></thead><tbody><tr class="odd"><td>微软雅黑</td><td>1.32</td><td>1.321</td><td>1.32</td></tr><tr class="even"><td>宋体</td><td>1.141</td><td>1.142</td><td>1.141</td></tr></tbody></table><p>line-height有三种计算方式： 1. 数值。如<code>line-height: 1.5</code>，与当前font-size相乘后的值。</p><ol start="2" type="1"><li><p>百分比值。如<code>line-height: 150%</code>，与当前font-size相乘后的值。</p></li><li><p>长度值。如<code>line-height:21px</code>或者<code>者 line-height:1.5em</code>。</p></li></ol><p>使用数值的计算，和其他两种方式在继承方面有所不同。使用数值的话，那么所有的子元素继承的都是这个值；使用百分比值或者长度值作为属性值，所有 的子元素继承的是最终的计算值。</p><p>这里推荐的继承设置：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1.5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">input</span>, <span class="selector-tag">button</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: inherit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="内联元素line-height的大值特性">内联元素line-height的“大值特性”</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">96px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> <span class="selector-tag">span</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 另一个 */</span></span><br><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> <span class="selector-tag">span</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">96px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个子元素的行高是20px，一个是96px，假如一行文字，.box元素的高度是多少。答案是都是96px。</p><p>原因是，里层96px直接撑开，外层96px，“幽灵空白节点”继承96px，最终撑开。设置独立的<code>inline-block</code>避免“幽灵空白节点”影响。</p><h2 id="vertical-align">vertical-align</h2><p>首先要知道，line-height的高度并不是元素的最终高度。</p><p>vertical-align分为下面四大类：</p><ul><li><p>线类，如baseline、top、middle、bottom。</p></li><li><p>文本类，如text-top、text-bottom。</p></li><li><p>上标下标类，如sub、super。</p></li><li><p>数值百分比。如20px、2em、20%等。</p></li></ul><p>默认是baseline，如果设置10px这样，就会往baseline往上偏移10px。负值设置则是往下偏移。</p><h3 id="vertical-align作用的前提">vertical-align作用的前提</h3><p>verticl-align作用的前提是，只能应用于内联元素以及display值为table-cell的元素。</p><p>这里举一个图片的vertical-align没有效果的例子。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 无效果 */</span></span><br><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">128px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> &gt; <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">96px</span>;</span><br><span class="line">  <span class="attribute">vertical-align</span>: middle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设置line-height */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">128px</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">128px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> &gt; <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">96px</span>;</span><br><span class="line">  <span class="attribute">vertical-align</span>: middle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="vertical-align和line-height">vertical-align和line-height</h3><p>阐述一下容器高度不等于行高的例子</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">32px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> &gt; <span class="selector-tag">span</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">24px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为“幽灵空白节点”的字体大小不等于span，所以字号不一样的参差位移导致的。如果在父元素设置好字体大小和子元素一样就不会有这样的情况啦。</p><p>图片底部存在间隙也是“幽灵空白节点”、line-height和vertical-align共同导致的。解决方法：</p><ol type="1"><li><p>图片块状化。</p></li><li><p>容器line-height足够小。</p></li><li><p>容器font-size足够小。</p></li><li><p>图片设置其他vertical-align属性值。</p></li></ol><p>关于图片的<code>margin-top: -200</code>无效这样的效果，原因是“幽灵空白节点”因为默认的<code>vertical-align: baseline</code>固定死在父级容器内。</p><h3 id="vertical-align线性类属性值">vertical-align线性类属性值</h3><h4 id="inline-block与baseline">inline-block与baseline</h4><p>vertical-align 属性的默认值 baseline 在文本之类的内联元素那里就是字符 x 的下边缘，对于替换元素则是替换元素的下边缘。但是，如果是 inline-block 元素，则规则要复杂了：一个 inline-block 元素，如果里面没有内联元素，或者 overflow 不是 visible，则该元素的基线就是其 margin 底边缘；否则其基线就是元素里面最后一行内联元素的基线。</p><p>inline-block和baseline的利用，删除icon，<code>&lt;i class="icon-delete"&gt;删除&lt;/i&gt;</code>和<code>&lt;i class="icon-delete"&gt;&lt;/i&gt;</code>这里面一个有文字，一个没文字,由于有文字的一般设置为<code>overflow：hidden</code>但是他们的元素基线都是margin底边缘。下面是小技巧，将inline-block和文字对齐。</p><ol type="1"><li><p>图标高度和行高一样。一般设定一个固定的宽高。</p></li><li><p>图标标签里面永远有字符。可以借助::before或者::after伪元素生成一个空格字符串。</p></li><li><p>图标CSS不使用<code>overflow: hidden</code>保证基线为里面字符的基线，但是要让里面潜在的字符不可见。</p></li></ol><h1 id="流的破坏与保护">流的破坏与保护</h1><h2 id="float">float</h2><p>float的特性： * 包裹性。 * 块状化并格式化上下文。 * 破坏文档流。 * 没有任何margin合并。</p><p>元素设置float，会让父元素坍塌。使用浮动元素的时候，最好采用采用一些手段干净地清除浮动带来的影响。</p><h3 id="float的克星clear">float的克星clear</h3><p>语法如下：</p><p>clear: none | left | right | both</p><p>clear的官方解释是“元素盒子的边不能和前面的浮动元素相邻”。</p><ul><li>none: 默认值，左右浮动都有。</li><li>left: 左侧康浮动。</li><li>right: 右侧抗浮动。</li><li>both: 两侧抗浮动。</li></ul><p>一般使用，<code>clear: both</code>。<code>clear: both</code>的本质是让自己不和float元素在一行显示，并不是真正意义上的清除浮动。</p><ol type="1"><li><p>如果<code>clear: both</code>元素前面的元素就是float元素，则<code>margin-top</code>负值即使设置-9999px也没有效果。</p></li><li><p><code>clear: both</code> 后面的元素一九可能发生文字环绕的现象。</p></li></ol><h2 id="bfc">BFC</h2><p>BFC全称<strong>block formatting context</strong>，中文是“块级格式化上下文”。与之对应的还有IFC，“内联格式化上下文”。</p><p>触发BFC的条件：</p><ul><li><code>&lt;html&gt;</code>根元素。</li><li>float的值不为none。</li><li>overflow的值auto、scroll或hidden。</li><li>display的值<code>table-cell</code>、<code>table-caption</code>和<code>inline-block</code>中任何一个。</li><li>position的值不为relative和static。</li></ul><p>BFC特点是及最重要用途是，实现更健壮、更智能的自适应布局。而不仅仅是去margin和清除float影响。</p><p>BFC的表现规则是，具有BFC特性的元素的子元素不会受外部元素影响，也不会影响外部元素。</p><h2 id="overflow">overflow</h2><p>最适合产生BFC的属性就是<code>overflow: hidden</code>。当子元素内容超出容器高度限制的时候，剪裁的边界是<code>border box</code>的内边缘，而非<code>padding box</code>的内边缘。</p><p>介绍下overflow属性经典的不兼容问题。在chrome浏览器下，如果浏览器能滚动（假设是垂直滚动），则<code>padding-bottom</code>也算在滚动尺寸内，IE和Firefox浏览器忽略<code>padding-bottom</code>。</p><h3 id="overflow-x和overflow-y">overflow-x和overflow-y</h3><ul><li>visible：默认值。</li><li>hidden：剪裁。</li><li>scroll：滚动条区域一直在。</li><li>auto：不足以滚动时没有滚动条，可以滚动时滚动条出现。</li></ul><p>关于overflow-x和overflow-y的设置，如果一个值设置visible而另一个值设置为scroll、auto和hidden，则visible会当成auto来解析。但是scroll、auto和hidden可以共存。</p><p>PC端的默认滚动条来自<code>&lt;html&gt;</code>，而不是<code>&lt;body&gt;</code>标签，移动端就不是这样啦。</p><p>PC端滚动条会占用容器的可用宽度和高度。移动端滚动条一般是悬浮的就不会。</p><h3 id="overflow与锚点定位">overflow与锚点定位</h3><p>下面两种情况可以触发锚点定位:</p><h3 id="锚点定位行为触发条件">锚点定位行为触发条件</h3><ol type="1"><li><p>URL地址中的锚链与锚点元素对应并有交互行为。</p></li><li><p>可focus的锚点元素处于focus状态。</p></li></ol><h3 id="锚点定位作用的本质">锚点定位作用的本质</h3><p>锚点定位作用的发生，本质上是通过改变容器滚动高度或者宽度来实现的。</p><p>锚点定位可以发生在普通元素，而且定位行为的发生是由内而外的。“由内而外”指的是，普通元素和窗体同时可滚动的时候，会由内而外触发所有可滚动窗体的锚点定位行为。</p><p>设置<code>overflow: hidden</code>的元素也是可以滚动的，只是没有滚动条，如内部的scrollTop依旧可以使用。</p><h2 id="position-absolute">position: absolute</h2><p>当一个元素同时拥有absolute和float的时候，float属性没有任何效果。具有块状话，一旦设置了absolute或者fixed，其元素display就变成block。</p><p>关于元素的宽度的详细计算规则：</p><ol type="1"><li><p>根元素（很对场景下可以看成<code>&lt;html&gt;</code>）被称为“初始包含块”，其尺寸等于浏览器可视窗口的大小。</p></li><li><p>对于其它元素，如果该元素的position是relative或者static，则“包含块”由其最近的块容器祖先盒的content box边界形成。</p></li><li><p>如果元素position: fixed，则包含块是“初始包含块”。</p></li><li><p>如果元素的position: absolute，则“包含块”由最近的position不为static的祖先元素建立。</p><p>如果该祖先元素是纯inline元素，则规则略复杂：</p><ul><li>假设给内联元素的前后各生成一个宽度为0的内联盒子（inline box），则这两个内联盒子的padding box外面的包围盒就是内联元素的“包围块”。</li><li>如果该内联元素被跨行分割了，那么“包含块”是未定义的，也就是CSS2.1规范没有明确定义，浏览器自行发挥。</li></ul></li></ol><p>与常规元素相比，absolute绝对定位元素的“包含块”有以下3个差异 1. 内联元素也可以作为“包含块”所在的元素。 2. “包含块”所在的元素不是父级块元素，而是最近position不为static的祖先元素或者根元素。 3. 边界是padding box而不是content box。</p><p>内联元素一般不做“包含块”。 1. 一般使用absolute绝对定位都适合布局有关，而内联元素主要是图文展示。</p><ol start="2" type="1"><li><p>理解和学习成本高。内联元素的“包含块”不能按照常规块级元素的“包含块”来理解。</p></li><li><p>兼容性问题。无论内联元素是单行还是跨行都存在兼容性问题。单行的兼容性问题存在于“包含块”是一个空的内联元素的时候。</p></li></ol><p>提示信息一行使用absolute定位的时候，利用<code>white-space: nowrap</code>让信息单行显示。</p><h3 id="具有相对特性的无依赖absolute绝对定位">具有相对特性的无依赖absolute绝对定位</h3><p>absolute是非常独立的CSS属性，其样式和行为表现不依赖其他任何CSS属性就可以完成。</p><p>absolute定位效果完全不需要父元素设置position为relative或者其他属性就能实现。这种情况下，子元素也不要设置left/top/right/bottom的属性值。其实这种“无依赖绝对定位”本质上就是“相对定位”，仅仅是不占据CSS流的尺寸空间而已。</p><p>简单的例子</p><ol type="1"><li><p>图标的的定位</p></li><li><p>超越常规布局的排版</p></li></ol><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/absoluteLayout.png" /></p><ol start="3" type="1"><li>下拉列表的定位</li></ol><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/absoluteSelect.png" /></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.datalist</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.search-result</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">input</span><span class="selector-pseudo">:focus</span> ~ <span class="selector-class">.search-result</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然“无依赖绝对定位”好处多多，但建议只用在静态交互效果上，比方说，导航二级菜单的显示与定位。如果是动态呈现的列表，建议还是使用 JavaScript 来计算和定位。</p><h3 id="absolute与overflow">absolute与overflow</h3><p>overflow与absolute元素的裁剪规则用一句话表述就是：绝对定位元素不总是被父级 overflow 属性剪裁，尤其当 overflow 在绝对定位元素及其包含块之间的时候。</p><p>转述就是：如果overflow不是定位元素，同时绝对定位元素和overflow容器之间也没有定位元素，则overflow无法对absolute元素经行剪裁。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 不会剪裁 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"overflow: hidden;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1.jpg"</span> <span class="attr">style</span>=<span class="string">"position: absolute;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"position: relative;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"overflow: hidden;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1.jpg"</span> <span class="attr">style</span>=<span class="string">"position: absolute;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 会剪裁 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"overflow: hidden; position: relative;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1.jpg"</span> <span class="attr">style</span>=<span class="string">"position: absolute;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"overflow: hidden;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"position: relative;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"1.jpg"</span> <span class="attr">style</span>=<span class="string">"position: absolute;"</span>&gt;</span> <span class="comment">&lt;!-- 剪裁 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当元素出现transform属性的时候，近似于添加了“定位元素”。所以需要检查，absolute元素是否会被剪裁，fixed定位失效。</p><h3 id="absolute与clip">absolute与clip</h3><p>CSS 世界中有些属性或者特性必须和其他属性一起使用才有效，比如clip。</p><p><code>clip: rect(top, right, bottom, left)</code>表示据每个边缘的距离开始剪裁。作用有：</p><ol type="1"><li><p>fixed固定定位的剪裁。</p></li><li><p>最佳可访问性隐藏。例如隐藏一些文字之类的。</p></li></ol><p>clip 隐藏仅仅是决定了哪部分是可见的，非可见部分无法响应点击事件等；然后，虽然视觉上隐藏，但是元素的尺寸依然是原本的尺寸，在 IE 浏览器和 Firefox 浏览器下抹掉了不可见区域尺寸对布局的影响，Chrome 浏览器却保留了。</p><h3 id="absolute流体特性">absolute流体特性</h3><p>绝对定位元素在“对立方向同时发生定位的时候”。</p><p>当绝对定位元素处于流体状态的时候，各个盒模型相关属性的解析和普通流体元素都是一模一样的，margin 负值可以让元素的尺寸更大，并且可以使用 margin:auto 让绝对定位元素保持居中。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.element</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>; <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">right</span>: <span class="number">0</span>; <span class="attribute">top</span>: <span class="number">0</span>; <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">margin</span>: auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="position-relative">position: relative</h2><p>relative的定位有两点值得一提： * 相对定位元素的left/top/right/bottom的百分比计算值是相对包含块计算的，而不是本身。所以如果包含块的高度是auto，那么计算值是0，便宜无效。 * 相对元素同时应用对立方向定位值的时候，按照默认文档流，自上而下、从左往右，top 、left作用大。</p><h3 id="relative最小化影响原则">relative最小化影响原则</h3><ol type="1"><li>尽量不适用relative，想定位某些元素，首先看能否使用“无依赖的绝对定位”。</li><li>如果场景受限，一定要使用relative，则该relative务必最小化。</li></ol><p>原因有，一个普通元素变成相对定位元素，元素的层叠顺序提高了。“relative 的最小化影响原则”不仅规避了复杂场景可能出现样式问题的隐患，从日后的维护角度讲也更方便。</p><h2 id="position-fixed固定定位">position: fixed固定定位</h2><p>position:fixed 固定定位元素的“包含块”是根元素，我们可以将其近似看成<code>&lt;html&gt;</code>元素。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这一部分总结了两处，一处是内联元素，其实内联元素这里主要让我重新认识了下vertical-align和line-height。另一处就是关于流的破坏，主要就是介绍了下float和absolute这些属性一些知识点了。最后国庆节快乐哈哈。
    
    </summary>
    
      <category term="css世界" scheme="https://hddhyq.github.io/categories/css%E4%B8%96%E7%95%8C/"/>
    
    
      <category term="css" scheme="https://hddhyq.github.io/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>css世界之盒子模型</title>
    <link href="https://hddhyq.github.io/2018/09/27/css%E4%B8%96%E7%95%8C%E4%B9%8B%E7%9B%92%E5%AD%90%E6%A8%A1%E5%9E%8B/"/>
    <id>https://hddhyq.github.io/2018/09/27/css世界之盒子模型/</id>
    <published>2018-09-27T15:59:15.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>这是这个总结系列的第二篇文章，关于content、padding、margin、border的。 <a id="more"></a> # content</p><h2 id="什么是替换元素">什么是替换元素</h2><p>简单的来说，通过修改某个属性值，呈现的内容就可以被替换的元素就称之为<strong>替换元素</strong>。</p><ol type="1"><li><p>内容的外观不受页面的css影响。也就是说样式表现在css作用域之外，如何修改替换元素本身的外观呢。需要利用浏览器提供行的一些样式接口，如：<code>::-ms-check{}</code>，直接修改样式是不起作用的。</p></li><li><p>有自己的尺寸。很多替换元素在没有明确尺寸的时候，其默认尺寸（不包括边框）为300像素×150像素。</p></li><li><p>很多css属性有自己的一套表现方式。比如<code>vertical-align</code>属性，对于非替换内联元素来说，其一般是字符x的下边缘，而对于替换元素来说，一般来说是元素的下边缘。</p></li></ol><h3 id="替换元素的display值">替换元素的display值</h3><p>替换元素都是内联元素，但是它们的display值却是有所不同。</p><table><thead><tr class="header"><th>元素</th><th>Chrome</th><th>Firefox</th><th>IE</th></tr></thead><tbody><tr class="odd"><td><code>&lt;img&gt;</code></td><td>inline</td><td>inline</td><td>inline</td></tr><tr class="even"><td><code>&lt;iframe&gt;</code></td><td>inline</td><td>inline</td><td>inline</td></tr><tr class="odd"><td><code>&lt;video&gt;</code></td><td>inline</td><td>inline</td><td>inline</td></tr><tr class="even"><td><code>&lt;select&gt;</code></td><td>inline-block</td><td>inline-block</td><td>inline-block</td></tr><tr class="odd"><td><code>&lt;input&gt;</code></td><td>inline-block</td><td>inline</td><td>inline-block</td></tr><tr class="even"><td><code>range(or)file &lt;input&gt;</code></td><td>inline-block</td><td>inline-block</td><td>inline-block</td></tr><tr class="odd"><td><code>hidden &lt;input&gt;</code></td><td>none</td><td>none</td><td>none</td></tr><tr class="even"><td><code>&lt;button&gt;</code></td><td>inline-block</td><td>inline-block</td><td>inline-block</td></tr><tr class="odd"><td><code>&lt;video&gt;</code></td><td>inline-block</td><td>inline</td><td>inline-block</td></tr></tbody></table><h3 id="替换元素的尺寸计算规则">替换元素的尺寸计算规则</h3><ol type="1"><li><p>固有尺寸。这个固有尺寸指的是替换内容的原本尺寸。例如，图片、视频作为一个独立文件存在的时候，都是有着自己的宽度和高度的。这个宽度和高度的大小就是“固有尺寸”。</p></li><li><p>HTML尺寸。“HTML尺寸”只能通过HTML原生属性改变，这些原生属性包括<code>&lt;img&gt;</code>的width和height属性、<code>&lt;input&gt;</code>的size属性、<code>&lt;textarea&gt;</code>的cols和rows属性等。</p></li><li><p>CSS尺寸特指可以通过CSS的width和height。</p></li></ol><p>css尺寸 &gt; HTML尺寸 &gt; 固有尺寸。即使替换元素设置<code>display: block</code>，尺寸规则仍然和内联状态一样，这也是为什么图片或者其他表单元素设置<code>display:block</code>却没有达到100%容器的原因。</p><p>如果一个图片没有src，那么其将不会有网络请求，这一点可以用在图片懒加载上面。而在Firefox中，这种没有src的img元素将会表现为一个普通的内联元素，所以宽高设置无效，所以需要将其设置为<code>display: inline-block</code>。</p><p>关于图片的width和height设置，影响图片的方式。图片的默认填充方式是fill，也就是说，你说设置的宽度和高度都会被默认填充满，所以尺寸的变化，改变的不是图片的固有尺寸，只是改变了图片填充的外部尺寸。CSS3中，替换元素的适配方式，可以通过<code>object-fit</code>来修改。</p><h3 id="替换元素和非替换元素的区别">替换元素和非替换元素的区别</h3><h4 id="观点1-替换元素和非替换元素之间只隔了一个src属性">观点1： 替换元素和非替换元素之间只隔了一个src属性。</h4><p>这里举了一个小例子，利用到了伪元素的图片生成技术。</p><ul><li><p>不能有src属性（证明观点所在）</p></li><li><p>不能使用content属性生成图片（针对Chrome）</p></li><li><p>需要有alt属性并有值（针对Chrome）</p></li><li><p>Firefox下::before伪元素的content值会被无视，::after不会发生这种问题。</p></li></ul><p>这里有一个展示的链接，http://demo.cssworld.cn/4/1-2.php 。这里可以演示图片没加载成功的时候，hover提示图片信息的技术。</p><h4 id="观点2替换元素和非替换元素之间只隔了一个css-content-属性">观点2：替换元素和非替换元素之间只隔了一个CSS content 属性</h4><p>替换元素之可替换的部分是content box，对应css属性是content。所以从理论来说content熟悉决定了是替换元素或者非替换元素。直接添加了content属性的元素我们可以称之为“匿名替换元素”。</p><p>在MDN中对于<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/content">content</a>的介绍中，也直接说明了使用content 属性插入的内容都是匿名的可替换元素。</p><p>关于content的利用，这里放一个<a href="http://demo.cssworld.cn/4/1-9.php">三个点动态加载</a>以及<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Lists_and_Counters/Using_CSS_counters">counter()</a>。计数器可以说也主要是生成文档的时候来用一下。最后最后，content能够混合的，也就是像这种形式<code>content: "(" attr(href) ")"</code>。</p><h1 id="padding">padding</h1><h2 id="奇怪的首选最小宽度">奇怪的首选最小宽度</h2><p>关于padding里面有几个点需要注意的，即使设置了<code>box-sizing: border-box</code>，当padding计算值大于width时，width也会无效，最终宽度呈现为padding计算值，内容则表现为“首选最小宽度”。而且加了文字也不会变，一般来说是0吧。</p><h2 id="内联元素的padding">内联元素的padding</h2><p>内联元素的padding，会发生层叠，就是说，对上下元素的原本布局没有任何影响，却发生了层叠。</p><p>css中有很多不影响其他元素布局的层叠现象。如，relative元素的定位、盒阴影box-shadow以及outline等。</p><ol type="1"><li><p>纯视觉层叠。不影响外部尺寸，如box-shadow以及outline等。</p></li><li><p>会影响视觉的层叠。inline元素的padding就是这种。</p></li></ol><p>区分的方式也很简单，如果父容器设置为<code>overflow: auto</code>，层叠区域超出父元素的时候，没有滚动条出现，则是纯视觉的；如果有滚动条出现，则会影响尺寸，影响布局。</p><h2 id="内联padding的一点小应用">内联padding的一点小应用</h2><h3 id="利用内联padding实现高度可控的管道分隔符">利用内联padding实现高度可控的“管道分隔符”</h3><p><a href="http://demo.cssworld.cn/4/2-2.php">查看链接</a></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">a</span> + <span class="selector-tag">a</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">''</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">3px</span> <span class="number">1px</span>;</span><br><span class="line">  <span class="attribute">margin-left</span>: <span class="number">6px</span>;</span><br><span class="line">  <span class="attribute">border-left</span>: <span class="number">1px</span> solid gray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/pipe_border.png" /></p><h2 id="padding的百分比值及应用">padding的百分比值及应用</h2><p>块级元素的话，有一个纯css实现宽高5:1的头图， <a href="http://demo.cssworld.cn/4/2-3.php">效果图</a></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10%</span> <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.box</span> &gt; <span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里在讨论一下内联元素的padding百分比。</p><ul><li>同样的相对宽度计算。</li><li>默认的高度和宽度细节有差异。</li><li>padding会断行。</li></ul><p>内联元素的padding首先计算的是左边，那么左边的长度够了的话，元素就会换行，换行之后，新的padding会形成背景，如果是背景色不是transparent的话，就会根据先来后到的产生层叠现象，而且层叠等级比较高。会产生相应的奇怪的现象，一般的开发过程中，遇到这种情况的概率比较小。</p><p>空白的内联元素的表现也会有不同的表现，因为内联元素前面有一个宽度为0高度自适应的“幽灵空白节点元素”，所以，设置<code>padding: 50%</code>最终的变现为一个长方形，这种现象，在我们知道了“幽灵空白节点元素”的存在就不会显得那么难以理解了。</p><h2 id="padding与图形绘制">padding与图形绘制</h2><p>padding属性和background-clip属性配合，可以在有限的标签下实现一些css图形绘制效果。</p><p>不使用伪元素，仅一层标签实现菜单图标。下面是十倍大小模拟。</p><p>双层圆心选中效果也可以直接模拟。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.icon-menu</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">140px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">35px</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">10px</span> solid;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">10px</span> solid;</span><br><span class="line">  <span class="attribute">background-color</span>: currentColor;</span><br><span class="line">  <span class="attribute">background-clip</span>: content-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.icon-dot</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">10px</span> solid;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: currentColor;</span><br><span class="line">  <span class="attribute">background-clip</span>: content-box;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="http://demo.cssworld.cn/4/2-4.php">效果图</a></p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/menu_dot.png" /></p><h1 id="margin">margin</h1><h2 id="元素尺寸的相关概念">元素尺寸的相关概念</h2><ul><li><p>元素尺寸：对应jQuery的<code>$().outerWidth()</code>和<code>$().outerHeight()</code>方法，是元素的<strong>border box</strong>尺寸。在原生DOM API中写作offsetWidth和offsetHeight，所以有时也称作“元素偏移尺寸”。</p></li><li><p>元素内部尺寸：对应jQuery的<code>$().innerWidth()</code>和<code>$().innerHeight()</code>，就是元素的<strong>padding box</strong>的尺寸。在原生DOM API中写作clientWidth和clientHeight。</p></li><li><p>元素外部尺寸：对应jQuery的<code>$().outerWidth(true)</code>和<code>$(true).outerHeight(true)</code>，是元素的<strong>margin box</strong>的尺寸。原生DOM API中没有对应的。</p></li></ul><p>当元素的尺寸表现为充分利用可利用空间的时候，margin会影响元素的尺寸。对于普通流体元素，margin只能改变元素水平方向尺寸。对于具有可拉伸的绝对定位元素，则水平和垂直方向都可以。</p><h2 id="margin合并">margin合并</h2><p>margin合并的三种场景：</p><ol type="1"><li><p>相邻兄弟元素margin合并。</p></li><li><p>父级和第一个、最后一个子元素。</p></li><li><p>空块级元素的margin合并。块级元素为空，上下margin会合并。</p></li></ol><p>margin合并规则，“正正取最大”“正负相加”“负负取最负”。</p><p>margin合并的意义主要是为了文档的展示，即css2的主要内容。 v ## margin: auto</p><p>平分规则：</p><ol type="1"><li><p>如果一侧定值，一侧为auto，则auto为剩余空间大小。</p></li><li><p>如果两侧均是auto，则平分剩余空间。</p></li></ol><p>这里让某个元素右对齐就可以用，<code>margin-left：auto</code>这个属性啦。</p><p>这里介绍一下水平垂直同时居中的一个方法。容器尺寸固定且，<code>position: relative</code>。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.son</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这种格式化的流体布局中，margin的自动分配剩余空间就起作用啦，所以最后会垂直水平居中。</p><h2 id="margin无效情况">margin无效情况</h2><ol type="1"><li><p>display计算值为inline的非替换元素的垂直margin是无效的。对于内联替换元素的垂直margin有效。</p></li><li><p>表格的</p><tr><p>和</p><td><p>元素设置display值是<code>table-cell</code>或<code>table-row</code>的margin无效。如果计算值是<code>tab-caption</code>、<code>inline-table</code>，可以通过margin控制外边距，甚至::first-letter伪元素也可以解析margin。</p></li><li><p>margin合并时候，margin小于合并值设置无效。</p></li><li><p>绝对定位元素非定位方位的margin值“无效”。绝对定位元素无法影响兄弟元素，所以看起来无效。</p></li><li><p>定高容器的子元素的margin-bottom或者宽度定死的子元素的margin-right的定位“失效”。正常流的情况下，margin-top和margin-left有效，而margin-bottom和margin-right则会无效。虽然有，但是影响不到自己，只会影响兄弟元素的定位。</p></li><li><p>float鞭长莫及的margin。<code>float: right</code>和<code>margin-right: 20px</code>这里20px小于元素的宽度的时候，就会无效。</p></li><li><p>内联特性导致的margin无效。</p></li></ol><h1 id="border">border</h1><p>border和padding与margin不同，border-width不支持百分比的数值。border相当于盒子的宽度，包装盒哪里有根据内部容器变大的情况呢。其他诸如outline、box-shadow、text-shadow等都是不支持百分比的数值的。</p><p>border-width还支持若干关键字。thin、medium、thick等。</p><p>border-style有几个点，关于border-style: none为默认值。border-style: double表现规则记录一下：双线宽度永远相等，中间间隔±1。</p><p>借助border也能实现菜单menu啦。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.icon</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">120px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">60px</span> double;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">20px</span> solid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="border三角形绘制">border三角形绘制。</h2><p>等腰三角形的绘制：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">10px</span> solid;</span><br><span class="line">  <span class="attribute">border-color</span>: <span class="number">#f30</span> transparent transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先我们需要知道border的绘制过程：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">100px</span> solid;</span><br><span class="line">  <span class="attribute">border-color</span>: <span class="number">#f30</span> <span class="number">#00f</span> <span class="number">#396</span> <span class="number">#0f0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/border_color.png" /></p><p>所以其他三边透明和宽高为0的等宽三角想也就出来了： <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 梯形 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">100px</span> solid;</span><br><span class="line">  <span class="attribute">border-color</span>: <span class="number">#f30</span> transparent transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 三角形 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">100px</span> solid;</span><br><span class="line">  <span class="attribute">border-color</span>: <span class="number">#f30</span> transparent transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/border_color_transparent.png" /> <img src="https://images-1253206717.cos.ap-guangzhou.myqcloud.com/little_tricks/border_single.png" /></p><p>其他一些其他的三角形利用，则是利用两个倾斜度不同的三角形叠加。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这是这个总结系列的第二篇文章，关于content、padding、margin、border的。
    
    </summary>
    
      <category term="css世界" scheme="https://hddhyq.github.io/categories/css%E4%B8%96%E7%95%8C/"/>
    
    
      <category term="css" scheme="https://hddhyq.github.io/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>css世界之流体布局</title>
    <link href="https://hddhyq.github.io/2018/09/23/css%E4%B8%96%E7%95%8C%E4%B9%8B%E6%B5%81%E4%BD%93%E5%B8%83%E5%B1%80/"/>
    <id>https://hddhyq.github.io/2018/09/23/css世界之流体布局/</id>
    <published>2018-09-23T10:23:00.000Z</published>
    <updated>2020-03-27T08:06:33.234Z</updated>
    
    <content type="html"><![CDATA[<p>这将会把看到的css世界里面的知识点提取出来，可能会有5到6篇文章来做总结。</p><p>这是第一篇文章，css世界之流体布局。 <a id="more"></a> # 文档流 想要了解文档流，我们需要关注普通元素默认的布局是怎样的。</p><p>在MDN中<a href="https://developer.mozilla.org/zh-CN/docs/Learn/CSS/CSS_layout/Normal_Flow">normal flow</a>章节中有所描述。</p><p>单个元素我们需要关注于它们的盒子模型，首先获取元素的content，然后是它们的padding，最后是border和margin。</p><p>默认来说，块级元素的content是父级元素宽度的100%，高度是元素content的高度。内联元素的高度是content的高度，宽度也是content的宽度。你不能直接设置一个内联元素的高度或者宽度，内联元素的高度仅仅是坐落在块级元素的内容中。如果你想要控制内联元素的高度和宽度，你需要将它们设置为 <code>display: block;</code> 或 <code>display: inline-block;</code></p><p>上面解释了单个元素。如果有多个元素，他们会怎么交互呢？在正常的浏览器布局中，默认来说，块级元素会根据文档的书写方式有关。每一个块级元素将会占据一个新行，他们还会根据所设置的margin值来分离。在英语中，或者其他水平，自上而下的书写的语言中，块级元素会根据垂直布局。</p><p>内联元素的表现方式就有所不同，它们不会在新的一行出现，它们会在同一行一个接一个的排列，直到它们的长度超过父级元素的宽度就会换行。</p><h1 id="width或height作用的具体细节">width或height作用的具体细节</h1><p>由于块级元素的流体特性主要体现在水平上，所以首先讨论的就是宽度。</p><h2 id="width-auto">width: auto</h2><p>width的默认值就是auto。它有以下四种表现：</p><ol type="1"><li><p>充分利用可用空间。常见就是<code>&lt;div&gt;&lt;p&gt;</code>元素宽度是100%默认于父级容器的。</p></li><li><p>收缩于包裹。常见于浮动、绝对定位、inline-block元素或table元素。</p></li><li><p>收缩到最小。常见于table-layout为auto的表格中。</p></li><li><p>超出容器限制。上面三种元素都不会使元素超出容器宽度，除非设置了<code>white-space: nowrap</code>。</p></li></ol><p>上述四种宽度情况中，除了第一种是由外部尺寸确定的宽度，其他都是内部尺寸决定的宽度。</p><h3 id="外部尺寸与流体特性">外部尺寸与流体特性</h3><ol type="1"><li><p>正常流宽度。宽度会自动填充满父级容器。</p></li><li><p>格式化宽度。出现在‘绝对定位模型中’，也就是position为 <strong>absolute</strong> 和 <strong>fixed</strong> 元素中，</p><p>对于非替换元素，当left/right或者top/bottom对立方位的属性值同时存在的时候，元素的宽度表现为格式化宽度。同样的设置了宽度就会破坏了这种流体性。</p></li></ol><h3 id="内部尺寸与流体特性">内部尺寸与流体特性</h3><p>这里我仅仅记录了一个关于包裹性的利用，页面中某个文字内容是动态的，可能是几个字或多很多字，几个字的时候居中显示，多个字的时候居左显示。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.content</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">text-align</span>: left;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="height-auto">height: auto</h2><p>如果父级元素的高度是100%，那么只要子元素在文档流之中，其百分比值完全被忽略。为什么高度的百分比计算会被忽略呢。在w3c规范中在就给出了答案，如果包含块的高度没有显式指定（即高度由内容决定），并且该元素不是绝对定位，则计算值为 <strong>auto</strong> 。父级容器的高度解释为了auto自然没法与百分比相乘了。</p><p><strong>如何让元素支持height: 100%</strong></p><ol type="1"><li><p>设定显式的高度值。给html和body设定100%也是也可以的。</p></li><li><p>使用绝对定位。绝对元素的宽高百分比计算是相对于 <strong>padding box</strong> 计算的，非绝对定位的高度百分比计算则是相对于 <strong>content box</strong> 计算的。</p></li></ol><h1 id="css-min-widthmax-width和min-heightmax-height"><strong>css</strong> min-width/max-width和min-height/max-height</h1><p>下面简述一下min/max-width/height与width和height的不一样的地方。</p><h2 id="关于初始值">关于初始值</h2><p>既然是总结，直接放出来好了，max-*的初始值是none，min-*的初始值是auto。</p><h2 id="覆盖规则">覆盖规则</h2><p>当max-width小于width设置的时候，即使width加上了<code>!important</code>也没有用，max-width大于width的设置。</p><p>当min-width大于max-width的时候，会以min-width为准则。</p><p>根据覆盖原则，我们可以实现任意高度的展开收起技术。由于设置height为auto无法计算值，过渡和动画效果也无法完成。所以我们可以利用max-height实现。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.element</span> &#123;</span><br><span class="line">  <span class="attribute">max-height</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">transition</span>: max-height .<span class="number">25s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.element</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">  <span class="attribute">max-height</span>: <span class="number">666px</span>; <span class="comment">/* 一个足够大的最大高度值 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="内联盒模型和幽灵空白节点">内联盒模型和幽灵空白节点</h1><h2 id="内联盒模型的简易版">内联盒模型的简易版</h2><ol type="1"><li><p>内容区域。内容区域指一种围绕文字看不见的盒子，可以理解为em盒。</p></li><li><p>内联盒子。“内联盒子”不会让内容成块显示，而是排成一行。需要注意的是一段单独的文本不一定是“匿名内联盒子”，还有可能是“匿名块级盒子”，主要是看其前后标签是内联还是块级。</p></li><li><p>行框盒子。每一行就是一个行框盒子，每个行框盒子又是一个一个“内联盒子”组成的。</p></li><li><p>包含盒子。又称包含块，包括父级标签。</p></li></ol><h2 id="幽灵空白节点">幽灵空白节点</h2><p>“幽灵空白节点”是内联盒子模型的一个非常重要的概念。具体指，在HTML5的文档声明中，内联元素的所有解析盒渲染表现就如同每个行框盒子的前面有一个“空白节点”一样。这个节点永远透明，不占据任何宽度，看不见也无法通过脚本获取，就好像幽灵一样，但是又确确实实存在。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这将会把看到的css世界里面的知识点提取出来，可能会有5到6篇文章来做总结。&lt;/p&gt;
&lt;p&gt;这是第一篇文章，css世界之流体布局。
    
    </summary>
    
      <category term="css世界" scheme="https://hddhyq.github.io/categories/css%E4%B8%96%E7%95%8C/"/>
    
    
      <category term="css" scheme="https://hddhyq.github.io/tags/css/"/>
    
  </entry>
  
</feed>
